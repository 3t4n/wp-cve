!function(y){"use strict";y(document).ready(function(){var a=0,i=null;y.ajaxPrefilter(function(t,e,a){var i,n;e.hasOwnProperty("data")&&e.data.hasOwnProperty("action")&&("new_activity_comment"==(i=e.data.action)?0!=(n=y("#ac-form-"+e.data.form_id).find('input[name="attachments_files[]"]').map(function(t,e){return y(e).val()}).get()).length&&(t.data+="&attachments_files="+n,""==e.data.content)&&(t.data+="&content={{{youzify_comment_attachment}}}"):"messages_send_reply"==i&&0!=(n=y("#send-reply").find('input[name="attachments_files[]"]').map(function(t,e){return y(e).val()}).get()).length&&(t.data+="&attachments_files="+n,""==e.data.content)&&(t.data+="&content={{{youzify_message_attachment}}}"))}),y(document).ajaxSuccess(function(t,e,a){"[object String]"==Object.prototype.toString.call(a.data)&&(e=e.responseText)[0]+e[1]!="-1"&&("new_activity_comment"==(e=y.youzify_getUrlParameter(a.data,"action"))?(y("#ac-form-"+y.youzify_getUrlParameter(a.data,"form_id")).find(".youzify-delete-attachment").trigger("click"),y("#ac-form-"+y.youzify_getUrlParameter(a.data,"form_id")).find(".youzify-wall-upload-btn").fadeIn()):"messages_send_reply"==e&&(y("#send-reply").find(".youzify-delete-attachment").trigger("click"),y("#send-reply").find(".youzify-upload-btn").fadeIn()))}),y(document).on("change",".youzify-upload-attachments",function(t){t.preventDefault();var e,a,t=y(this).closest("form");return!(t.hasClass("ac-form")&&(t.find(".youzify-wall-upload-btn").fadeOut(),t.find(".youzify-attachment-item")[0])||(a=(e=y(this).closest(".youzify-attachments")).find(".youzify-wall-item-upload"))[0]&&(a.fadeOut(1),e.find(".youzify-attachment-item")[0]))&&(i=y(this).get(0),void y.youzify_UploadFiles(t,e,{attachments:i}))}),y.youzify_UploadFiles=function(t,e,a){for(var i=y.extend({},a).attachments.files,n=0;n<i.length;n++){var o=i[n];if(t.hasClass("youzify-wall-form")){if(!y.youzify_CheckFilesNumber(t))return!1}else if(t.find(".youzify-attachment-item")[0])return!1;var f=y.youzifyAttachmentItem({file:o,input_name:e.attr("data-name")?e.attr("data-name"):"attachments_files[]",file_name:o.name});t.hasClass("ac-form")?t.find(".youzify-wall-upload-btn").fadeOut(1):"send-reply"!=t.attr("id")&&"send_message_form"!=t.attr("id")||t.find(".youzify-upload-btn").fadeOut(1),e.find(".youzify-form-attachments").append(f),0==n&&y.youzify_UploadFile(t,e,o)}},y.youzifyAttachmentItem=function(t){var t=y.extend({},t),e='<div class="youzify-attachment-item youzify-file-preview"><div class="youzify-attachment-details"><i class="fas fa-hourglass-half youzify-file-icon"></i><span class="youzify-file-name">'+y.youzify_GetNameExcerpt(t.file_name)+'</span></div><div class="youzify-file-progress"><span class="youzify-file-upload"></span></div><input type="hidden" class="youzify-attachment-data" name="'+t.input_name+'" /></div>',a='<div class="youzify-attachment-item youzify-image-preview"><div class="youzify-attachment-details"><i class="fas fa-hourglass-half youzify-file-icon"></i></div><div class="youzify-file-progress"><span class="youzify-file-upload"></span></div><input type="hidden" class="youzify-attachment-data" name="'+t.input_name+'" /></div>';return y.youzify_CheckIsFileImage(t.file)?a:e},y.youzify_UploadFile=function(i,n,f){var s=n.find(".youzify-file-progress:first").parent(".youzify-attachment-item"),t=new FormData;t.append("file",f),i.hasClass("youzify-wall-form")?(t.append("target","activity"),t.append("post_type",i.find('input:radio[name="post_type"]:checked').val())):i.hasClass("ac-form")?t.append("target","comment"):"send-reply"!=i.closest("form").attr("id")&&"send_message_form"!=i.closest("form").attr("id")||t.append("target","message"),t.append("attachments_number",i.find(".youzify-attachment-item").length),t.append("action","youzify_upload_wall_attachments"),t.append("security",Youzify.security_nonce),y.ajax({type:"POST",url:Youzify.ajax_url,data:t,cache:!1,contentType:!1,processData:!1,xhr:function(){var t=y.ajaxSettings.xhr();return t.upload&&(i.find(".youzify-wall-post,.youzify-update-post").attr("disabled",!0),t.upload.addEventListener("progress",function(t){var e;t.lengthComputable&&(e=t.total,t=100*t.loaded/e,e=s.find(".youzify-file-upload"),s.find(".youzify-file-icon").attr("class","fas fa-spinner fa-spin youzify-file-icon"),e.css("width",t+"%"),100<=t)&&e.addClass("youzify-file-uploaded")})),t},success:function(t){if(0==t.success)return y.youzify_DialogMsg("error",t.data.error),i.hasClass("ac-form")?i.find(".youzify-wall-upload-btn").fadeIn():"send-reply"!=i.attr("id")&&"send_message_form"!=i.attr("id")||i.find(".youzify-upload-btn").fadeIn(),n.hasClass("youzify-cf-attachment")&&n.find(".youzify-wall-item-upload").fadeIn(),s.remove(),y.youzify_CheckUploadProgress(i),!1;var e=t.data.base_url,o=(s.find(".youzify-file-progress").fadeOut(400,function(){y(this).remove(),y.youzify_upload_next_file(i,n),y.youzify_CheckUploadProgress(i)}),y.youzify_CheckIsFileImage(f)&&s.find(".youzify-file-icon").remove(),s.find(".youzify-file-icon").attr("class","fas fa-paperclip youzify-file-icon"),s.find(".youzify-attachment-details").append('<i class="fas fa-trash-alt youzify-delete-attachment"></i>'),delete t.data.base_url,s.find(".youzify-attachment-data").val(JSON.stringify(t.data)),new FileReader);f.type.match("video.*")&&(o.onload=function(){function t(){a()&&(n.removeEventListener("timeupdate",t),n.pause())}var e=new Blob([o.result],{type:f.type}),i=URL.createObjectURL(e),n=document.createElement("video"),a=(n.addEventListener("loadeddata",function(){a()&&n.removeEventListener("timeupdate",t)}),function(){var t,e=document.createElement("canvas"),e=(e.width=n.videoWidth,e.height=n.videoHeight,e.getContext("2d").drawImage(n,0,0,e.width,e.height),e.toDataURL("image/jpeg")),a=1e5<e.length;return a&&((t=JSON.parse(s.find(".youzify-attachment-data").val())).video_thumbnail=e,s.find(".youzify-attachment-data").val(JSON.stringify(t)),URL.revokeObjectURL(i)),a});n.addEventListener("timeupdate",t),n.preload="metadata",n.src=i,n.muted=!0,n.playsInline=!0,n.play()},o.readAsArrayBuffer(f)),s.css("background-image","url("+e+"temp/"+t.data.original+")")},error:function(t,e,a){s.remove(),y.youzify_DialogMsg("error",e),y.youzify_CheckUploadProgress(i),y.youzify_upload_next_file(i,n)}})},y.youzify_upload_next_file=function(t,e){a++,null!==i&&void 0!==i.files[a]&&y.youzify_UploadFile(t,e,i.files[a])},y(document).on("click",".youzify-delete-attachment",function(t){var e,a=y(this).closest("form"),a=(a.hasClass("ac-form")?a.find(".youzify-wall-upload-btn").fadeIn():"send-reply"!=a.attr("id")&&"send_message_form"!=a.attr("id")||a.find(".youzify-upload-btn").fadeIn(),y(this).closest(".youzify-attachments").find(".youzify-wall-item-upload").fadeIn(),y(this).closest(".youzify-attachment-item"));a.find(".youzify-attachment-data").get(0)&&(e=y.parseJSON(a.find(".youzify-attachment-data").val()),y.youzify_DeleteAttachment(e.original)),a.remove()}),y.youzify_DeleteAttachment=function(t){var e=new FormData;e.append("attachment",t),e.append("security",Youzify.security_nonce),e.append("action","youzify_delete_wall_attachment"),y.ajax({type:"POST",data:e,url:ajaxurl,contentType:!1,processData:!1})},y.youzify_GetNameExcerpt=function(t){var e,a;return t.length<=25?t:(a=25-"...".length,e=Math.ceil(a/2),a=Math.floor(a/2),t.substr(0,e)+"..."+t.substr(t.length-a))},y.youzify_CheckIsFileImage=function(t){t=t.type;return!(y.inArray(t,["image/gif","image/jpeg","image/png"])<0)},y.youzify_CheckUploadProgress=function(t){t.find(".youzify-file-progress")[0]||(t.find(".youzify-upload-attachments").val(""),t.find('.youzify-wall-actions button[type="submit"]').attr("disabled",!1),a=0,i=null)},y.youzify_CheckFilesNumber=function(t){var e=t.find('input:radio[name="post_type"]:checked').val();return"activity_photo"==e||"activity_poll"==e||"activity_versus_poll"==e||"activity_classic_poll"==e||"activity_grid_poll"==e||"activity_slideshow"==e||!t.find(".youzify-attachment-item")[0]||(i=null,y.youzify_DialogMsg("error",Youzify_Wall.max_one_file),!1)},y.youzify_getUrlParameter=function(t,e){for(var a,i=t.split("&"),n=0;n<i.length;n++)if((a=i[n].split("="))[0]===e)return void 0===a[1]||decodeURIComponent(a[1])}})}(jQuery);