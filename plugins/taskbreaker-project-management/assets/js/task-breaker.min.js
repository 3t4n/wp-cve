jQuery(document).ready(function(k){"use strict";k(window).load(function(){var c={attached_files:""},t=function(e,t,a){var s=e.target.files;if(!(s.length<=0)){var r=new FormData,i="#"+t+" ",n=e.target.files[0].name,o=0;1<=s.length&&k.each(s,function(){this.size>parseInt(task_breakerProjectSettings.max_file_size)&&o++}),1<=o?alert(taskbreaker_strings.file_error):(k(i+".tasbreaker-file-attached").html(n),k.each(s,function(e,t){r.append(e,t)}),"null"!=typeof a&&k.each(a,function(e,t){r.append(e,t)}),r.append("action","task_breaker_transactions_request"),r.append("method","task_breaker_transaction_task_file_attachment"),r.append("nonce",task_breakerProjectSettings.nonce),k(i+".taskbreaker-upload-error").remove(),k(i+".taskbreaker-upload-error-text-helper").removeClass("active"),k(i+".taskbreaker-upload-success-text-helper").removeClass("active"),k.ajax({url:task_breakerAjaxUrl,type:"POST",data:r,cache:!1,dataType:"json",processData:!1,contentType:!1,success:function(e,t,a){void 0===e.error?0!==e?"fail"===e.message?(c.attached_files="",k(i+".tb-file-attachment-progress").parent().append('<div class="taskbreaker-upload-error">'+e.response+"</div>"),k(i+".taskbreaker-upload-error-text-helper").addClass("active"),k(i+".taskbreaker-upload-success-text-helper").removeClass("active")):(c.attached_files=e.file,k(i+".taskbreaker-upload-error").remove(),k(i+".taskbreaker-upload-error-text-helper").removeClass("active"),k(i+".taskbreaker-upload-success-text-helper").addClass("active")):(k(i+".taskbreaker-upload-error-text-helper").addClass("active"),k(i+".taskbreaker-upload-success-text-helper").removeClass("active"),k(i+".tb-file-attachment-progress").parent().append('<div class="taskbreaker-upload-error">'+taskbreaker_strings.file_attachment_error+"</div>"),c.attached_files=""):console.log("File attachment errors debug: "+e.error)},error:function(e,t,a){console.log("File attachment errors debug: "+t)},xhr:function(){var e=k.ajaxSettings.xhr(),t=0,a="0%";return e.upload&&(k(i+".tb-file-attachment-progress-wrap").addClass("active"),k("#task_breaker-submit-btn").attr("disabled",!0),k("#task_breaker-edit-btn").attr("disabled",!0),e.upload.addEventListener("progress",function(e){e.lengthComputable&&(k("progress").attr({value:e.loaded,max:e.total}),"number"==typeof(t=e.loaded/e.total*100)&&(a=Math.floor(t)+"%",k(i+".tb-file-attachment-progress-movable").css({width:a}),k(i+".taskbreaker-upload-progress-value").html(a)))},!1)),e},complete:function(){console.log("finished"),k("#task_breaker-submit-btn").removeAttr("disabled"),k("#task_breaker-edit-btn").removeAttr("disabled")}}))}},o=new(Backbone.View.extend({id:0,project_id:task_breakerProjectSettings.project_id,page:1,priority:-1,current_page:1,max_page:1,min_page:1,total:0,show_completed:"no",total_pages:0})),d=new(Backbone.View.extend({el:"body",model:o,search:"",template:"",events:{"click .task_breaker-project-tab-li-item-a":"switchView","click .next-page":"next","click .prev-page":"prev","submit #task-breaker-search-task-form":"searchTasks","change #task_breaker-task-filter-select":"filter"},switchView:function(e,t){if(e){var a=k(e.currentTarget);if(-1!==k.inArray(a.attr("id"),["task_breaker-project-edit-tab","task_breaker-project-edit","task_breaker-project-add-new"]))return!1}c.attached_files="",k(".tasbreaker-file-attached").html("No Files Selected."),k(".tb-file-attachment-progress-wrap").removeClass("active"),k("#task_breaker-project-edit-tab").css("display","none"),k("#task_breaker-project-add-new").css("display","none"),k(".task_breaker-project-tab-li-item").removeClass("active"),k(".task_breaker-project-tab-content-item").removeClass("active");var s="";if(e){var r=k(e.currentTarget);s=r.attr("data-content"),r.parent().addClass("active"),k("div[data-content="+s+"]").addClass("active")}else k(t).addClass("active"),s=k(t).attr("data-content"),k("a[data-content="+s+"]").parent().addClass("active")},hideFilters:function(){k("#task_breaker-tasks-filter").hide()},showFilters:function(){k("#task_breaker-tasks-filter").show()},searchTasks:function(e){var t=k("#task_breaker-task-search-field").val();return 0===t.length?location.href="#tasks":location.href="#tasks/search/"+encodeURI(t),!1},filter:function(e){this.model.priority=e.currentTarget.value,"tasks"!=Backbone.history.getFragment()?location.href="#tasks":this.render()},next:function(e){e.preventDefault();var t=this.model.page;t<this.model.max_page&&(this.model.page=++t,location.href="#tasks/page/"+this.model.page)},prev:function(e){e.preventDefault();var t=this.model.page;t>this.model.min_page&&(this.model.page=--t,location.href="#tasks/page/"+this.model.page)},single:function(e){this.progress(!0);var t=this;this.template="single_task_index",this.renderTask(function(e){t.progress(!1),"fail"==e.message&&k("#task_breaker-project-tasks").html("<p class='info' id='message'>"+e.message_long+"</p>"),e.html&&k("#task_breaker-project-tasks").html(e.html)})},showEditForm:function(e){var s=this,t="";"undefined"!=typeof tinymce&&(t=tinymce.get("task_breakerTaskEditDescription")),this.progress(!0),t?t.setContent(""):k("#task_breakerTaskEditDescription").val(""),k(".task_breaker-project-tab-content-item").removeClass("active"),k(".task_breaker-project-tab-li-item").removeClass("active"),k("a#task_breaker-project-edit-tab").css("display","block").parent().addClass("active"),k("#task_breaker-project-edit-context").addClass("active"),k("#task_breakerTaskId").attr("disabled",!0).val("loading..."),k("#task_breakerTaskEditTitle").attr("disabled",!0).val("loading..."),k("#task_breaker-task-edit-select-id").attr("disabled",!0),this.model.id=e,this.renderTask(function(e){if(s.progress(!1),e.task){var t=e.task,a="";"undefined"!=typeof tinymce&&(a=tinymce.get("task_breakerTaskEditDescription")),k("#task_breakerTaskId").val(t.id).removeAttr("disabled"),k("#task_breakerTaskEditTitle").val(t.title).removeAttr("disabled"),k("#js-edit-taskbreaker-deadline-field").val(t.deadline.replace("-","")),a?a.setContent(t.description):k("#task_breakerTaskEditDescription").val(t.description),k("#task-user-assigned-edit").val(""),document.getElementById("task-user-assigned-edit")&&(document.getElementById("task-user-assigned-edit").options.length=0),k.each(t.assign_users_meta.members_stack,function(e,t){var a=document.createElement("option");a.value=t.ID,a.text=t.display_name,a.selected="selected",document.getElementById("task-user-assigned-edit").appendChild(a)}),s.autoSuggestMembers(k("#task-user-assigned-edit"),!0,t),k("#task_breaker-task-edit-select-id").val(t.priority).change().removeAttr("disabled"),k("#task-breaker-form-file-attachment-edit-field").removeAttr("disabled"),t.meta?k.each(t.meta,function(e,t){if("file_attachment"===t.meta_key){var a="";k("#taskbreaker-file-attachment-edit .tasbreaker-file-attached").html(t.meta_value),c.attached_files=t.meta_value,a+='<a href="#" title="Click to remove file attachment" data-attachment="'+t.meta_value+'">&times;</a>',k("#taskbreaker-unlink-file-btn").html(a)}}):(k("#taskbreaker-file-attachment-edit .tasbreaker-file-attached").html("No files attached"),k("#taskbreaker-unlink-file-btn a").remove())}})},renderTask:function(t){k.ajax({url:ajaxurl,method:"get",dataType:"json",data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_fetch_task",id:this.model.id,project_id:this.model.project_id,template:this.template,nonce:task_breakerProjectSettings.nonce},success:function(e){t(e)}})},render:function(){var t=this;this.progress(!0),k.ajax({url:ajaxurl,method:"get",dataType:"json",data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_fetch_task",id:this.model.id,project_id:this.model.project_id,page:this.model.page,search:this.search,priority:this.model.priority,template:"render_tasks",show_completed:this.model.show_completed,nonce:task_breakerProjectSettings.nonce},success:function(e){t.progress(!1),"success"==e.message&&(e.task.stats&&(o.max_page=e.task.stats.max_page,o.min_page=e.task.stats.min_page),k("#task_breaker-project-tasks").html(e.html)),0===e.task.length&&k("#task_breaker-project-tasks").html('<div class="task-breaker-message danger">'+taskbreaker_strings.tasks_not_found+"</div>")},error:function(){}})},initialize:function(){},progress:function(e){var t="none",a=1;e&&(t="block",a=.25),k("#task_breaker-preloader").css({display:t}),k("#task_breaker-project-tasks").css({opacity:a})},updateStats:function(e){var t=null,a=null;e.status&&(t=e.status.priority,a=e.status.task_status),a&&k("#task-details-status").text(a).removeClass("open close").addClass(a.toLowerCase()),t&&k("#task-details-priority").text(t).removeClass("normal high critical").addClass(t.toLowerCase()),k(".task_breaker-total-tasks").text(e.total),k(".task_breaker-remaining-tasks-count").text(e.remaining),k(".task-progress-completed").text(e.completed),k(".task-progress-percentage-label > span").text(e.progress),k(".task-progress-percentage").css({width:Math.ceil(e.completed/e.total*100)+"%"})},autoSuggestMembers:function(a,e,t){if(a){a.select2({maximumInputLength:20,placeholder:"Type member's name...",allowClear:!0,minimumResultsForSearch:1/0,minimumInputLength:2,tag:!0,ajax:{data:function(e){var t={action:"task_breaker_transactions_request",method:"task_breaker_transactions_user_suggest",nonce:task_breakerProjectSettings.nonce,group_id:task_breakerProjectSettings.current_group_id,term:e.term,user_id_collection:0};return a.val()&&(t.user_id_collection=a.val()),t},url:task_breakerAjaxUrl,delay:250,cache:!0},templateResult:function(e){if(e.avatar)var t=k('<span><img class="result-template-avatar" src="'+e.avatar+'" alt="s" />'+e.text+"</span>");return t}})}}}));(new(Backbone.Router.extend({routes:{tasks:"index","tasks/dashboard":"dashboard","tasks/settings":"settings","tasks/completed":"completed_tasks","tasks/add":"add","tasks/edit/:id":"edit","tasks/page/:page":"next","tasks/view/:id":"view_task","tasks/search/:search_keyword":"search"},view:d,model:o,index:function(){this.view.switchView(null,"#task_breaker-project-tasks-context"),this.model.page=1,this.model.id=0,this.model.show_completed="no",this.view.search="",this.view.render()},dashboard:function(){this.view.switchView(null,"#task_breaker-project-dashboard-context")},settings:function(){this.view.switchView(null,"#task_breaker-project-settings-context")},add:function(){this.view.switchView(null,"#task_breaker-project-add-new-context"),k("#task_breaker-project-add-new").css("display","block"),k("#task-user-assigned").val(""),k("#js-edit-taskbreaker-deadline-field").val(""),this.view.autoSuggestMembers(k("#task-user-assigned"),!0,null),tinymce.editors.task_breakerTaskDescription&&tinymce.editors.task_breakerTaskDescription.setContent("")},completed_tasks:function(){this.view.switchView(null,"#task_breaker-project-tasks-context"),this.model.show_completed="yes",this.view.render()},edit:function(e){this.view.showEditForm(e),k("#task_breaker-edit-task-message").html("")},next:function(e){this.model.page=e,this.view.render()},view_task:function(e){this.model.id=e,this.view.single(e),this.view.switchView(null,"#task_breaker-project-tasks-context")},search:function(e){this.model.page=1,this.model.id=0,this.view.search=e,this.view.render()}}))).on("route",function(e){"view_task"===e?this.view.hideFilters():this.view.showFilters()}),Backbone.history.start(),k("#task_breaker-submit-btn").click(function(e){e.preventDefault();var t=k(this);t.attr("disabled",!0),t.text("Loading ...");var a="",s=tinymce.get("task_breakerTaskDescription");a=s?s.getContent():k("#task_breakerTaskDescription").val(),k.ajax({url:ajaxurl,data:{action:"task_breaker_transactions_request",method:"task_breaker_transaction_add_ticket",description:a,deadline:k("#js-add-taskbreaker-deadline-field").val(),title:k("#task_breakerTaskTitle").val(),milestone_id:k("#task_breakerTaskMilestone").val(),priority:k("select#task_breaker-task-priority-select").val(),nonce:task_breakerProjectSettings.nonce,project_id:task_breakerTaskConfig.currentProjectId,user_id:task_breakerTaskConfig.currentUserId,user_id_collection:k("select#task-user-assigned").val(),file_attachments:c.attached_files},method:"post",success:function(e){parseInt(k(".task_breaker-total-tasks").text().trim()),parseInt(k(".task_breaker-remaining-tasks-count").text().trim());"success"===e.message?(t.text("Save Task"),t.removeAttr("disabled"),k("#task_breakerTaskDescription").val(""),k("#task_breakerTaskTitle").val(""),d.updateStats(e.stats),location.href="#tasks/view/"+e.response.id):(k("#task_breaker-add-task-message").html('<p class="error">'+e.response+"</p>").show().addClass("error"),t.text("Save Task"),t.removeAttr("disabled"))},statusCode:{500:function(){k("#task_breaker-add-task-message").html('<p class="error">'+taskbreaker_strings.task_error_500+"</p>").show().addClass("error"),t.text("Save Task"),t.removeAttr("disabled")}},error:function(e,t){k("#task_breaker-add-task-message").html('<p class="error">'+taskbreaker_strings.task_unexpected_error+"</p>").show().addClass("error")}})}),k("#task-breaker-form-file-attachment-field").on("change",function(e){t(e,"taskbreaker-file-attachment-add")}),c.attached_files="",k("#task_breaker-edit-btn").click(function(e){e.preventDefault();var a=k(this);a.attr("disabled",!0),a.text("Loading ...");var t=tinymce.get("task_breakerTaskEditDescription"),s={description:t?t.getContent():k("#task_breakerTaskEditDescription").val(),deadline:k("#js-edit-taskbreaker-deadline-field").val(),nonce:task_breakerProjectSettings.nonce,project_id:task_breakerTaskConfig.currentProjectId,user_id:task_breakerTaskConfig.currentUserId,action:"task_breaker_transactions_request",method:"task_breaker_transaction_edit_ticket",title:k("#task_breakerTaskEditTitle").val(),milestone_id:k("#task_breakerTaskMilestone").val(),id:k("#task_breakerTaskId").val(),priority:k('select[name="task_breaker-task-edit-priority"]').val(),user_id_collection:k("select#task-user-assigned-edit").val(),file_attachments:c.attached_files};k.ajax({url:ajaxurl,data:s,method:"post",success:function(e){var t="<p class='task-breaker-message success'>"+taskbreaker_strings.task_updated+" <a href='#tasks/view/"+e.id+"'>&#65515; "+taskbreaker_strings.task_view+"</a></p>";"fail"===e.message&&"no_changes"!==e.type&&(t="<p class='task-breaker-message danger'>"+taskbreaker_strings.task_update_error+"</a></p>"),"fail"===e.message&&"unauthorized"===e.type&&(t="<p class='task-breaker-message danger'>"+taskbreaker_strings.task_unauthorized_error+"</a></p>"),k("#task_breaker-edit-task-message").html(t).show(),a.attr("disabled",!1),a.text("Update Task"),k("html, body").animate({scrollTop:k("#task_breaker-edit-task-message").offset().top-300},100)},error:function(){console.log("An Error Occured [task_breaker.js]#311")}})}),k("#task-breaker-form-file-attachment-edit-field").on("change",function(e){console.log("test");t(e,"taskbreaker-file-attachment-edit",{edit_file_attachment:"yes"})}),k("#task_breaker-project").on("click","#taskbreaker-unlink-file-btn > a",function(e){e.preventDefault(),confirm(taskbreaker_strings.file_attachment_delete)&&console.log("deleting file...");var t=k("#task_breakerTaskId").val();k(".tasbreaker-file-attached").html("Deleting file attachment..."),k.ajax({method:"POST",url:task_breakerAjaxUrl,data:{nonce:task_breakerProjectSettings.nonce,ticket_id:t,action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_ticket_attachment"},success:function(e){k(".tasbreaker-file-attached").html("No files attached"),k("#taskbreaker-unlink-file-btn > a").remove(),c.attached_files=""}})}),k("body").on("click","#task_breaker-delete-btn",function(){if(confirm(taskbreaker_strings.task_confirm_delete)){var a=k(this),e={action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_ticket",id:parseInt(o.id),project_id:parseInt(o.project_id),nonce:task_breakerProjectSettings.nonce};d.progress(!0),a.text("Deleting ..."),k.ajax({url:ajaxurl,data:e,method:"post",success:function(e){if(d.progress(!1),d.updateStats(e.stats),"fail"===e.message){var t="<p class='task-breaker-message danger'>"+e.message_text+"</p>";return k("#task_breaker-edit-task-message").html(t).show(),!1}location.href="#tasks",d.switchView(null,"#task_breaker-project-tasks-context"),a.text("Delete")},error:function(){d.progress(!1),a.text("Delete")}})}}),k("body").on("click","#updateTaskBtn",function(){var t=k(this);t.attr("disabled","disabled");var e=o.id,a=k("#task-comment-content").val(),s=k("#task_breaker-task-priority-update-select").val(),r=k("input[name=task_commment_completed]:checked").val(),i=parseInt(o.project_id);if(0!==e){d.progress(!0);var n={action:"task_breaker_transactions_request",method:"task_breaker_transaction_add_comment_to_ticket",ticket_id:e,priority:s,details:a,completed:r,project_id:i,nonce:task_breakerProjectSettings.nonce};k.ajax({url:ajaxurl,data:n,method:"post",success:function(e){t.attr("disabled",!1),d.progress(!1),k("#task-comment-content").val(""),k("#task-lists").append(e.result),"yes"===r&&(k("#ticketStatusInProgress").attr("disabled",!0).attr("checked",!1),k("#ticketStatusComplete").attr("disabled",!0).attr("checked",!1),k("#comment-completed-radio").addClass("hide"),k("#ticketStatusCompleteUpdate").attr("disabled",!1).attr("checked",!0),k("#ticketStatusReOpenUpdate").attr("disabled",!1),k("#task_breaker-comment-completed-radio").removeClass("hide")),"reopen"===r&&(k("#ticketStatusInProgress").attr("disabled",!1).attr("checked",!0),k("#ticketStatusComplete").attr("disabled",!1).attr("checked",!1),k("#comment-completed-radio").removeClass("hide"),k("#ticketStatusCompleteUpdate").attr("disabled",!0).attr("checked",!1),k("#ticketStatusReOpenUpdate").attr("disabled",!0),k("#task_breaker-comment-completed-radio").addClass("hide")),d.updateStats(e.stats)},error:function(){t.attr("disabled",!1),d.progress(!1)}})}}),k("body").on("click","a.task_breaker-delete-comment",function(e){if(e.preventDefault(),!confirm(taskbreaker_strings.comment_confirm_delete))return!1;var t=k(this),a={action:"task_breaker_transactions_request",method:"task_breaker_transaction_delete_comment",comment_id:parseInt(k(this).attr("data-comment-id")),nonce:task_breakerProjectSettings.nonce};d.progress(!0),k.ajax({url:ajaxurl,data:a,method:"post",success:function(e){d.progress(!1),"success"==e.message?t.parent().parent().parent().parent().fadeOut(function(){k(this).remove()}):this.error()},error:function(){d.progress(!1),t.parent().append('<p class="error">'+taskbreaker_strings.comment_error+"</p>")}})}),k("body").on("click","#task_breakerUpdateProjectBtn",function(){var t=k(this),e="",a=tinymce.get("task_breakerProjectContent");e=a?a.getContent():k("#task_breakerProjectContent").val();var s={action:"task_breaker_transactions_request",method:"task_breaker_transactions_update_project",id:parseInt(k("#task_breaker-project-id").val()),title:k("#task_breaker-project-name").val(),content:e,group_id:parseInt(k("select[name=task_breaker-project-assigned-group]").val()),nonce:task_breakerProjectSettings.nonce};t.attr("disabled",!0).text("Updating ..."),d.progress(!0),k(".task_breaker-project-updated").remove(),k.ajax({url:ajaxurl,data:s,method:"post",success:function(e){d.progress(!1),t.attr("disabled",!1).text(taskbreaker_strings.project_label_btn_update),"success"===e.message?(k("article .entry-header > .entry-title").text(k("#task_breaker-project-name").val()),t.parent().parent().prepend('<div id="message" class="task_breaker-project-updated success updated"><p>Project details successfully updated.</p></div>'),location.reload()):"authentication_error"===e.type?t.parent().parent().prepend('<div id="message" class="task_breaker-project-updated error updated"><p>'+taskbreaker_strings.project_authentication_error+"</p></div>"):t.parent().parent().prepend('<div id="message" class="task_breaker-project-updated success updated"><p>'+taskbreaker_strings.project_all_fields_required+"</p></div>"),d.progress(!1),setTimeout(function(){k(".task_breaker-project-updated").fadeOut()},3e3)},error:function(){alert("connection failure")}})}),k("body").on("click","#task_breakerDeleteProjectBtn",function(){if(confirm(taskbreaker_strings.project_confirm_delete)){var e={action:"task_breaker_transactions_request",method:"task_breaker_transactions_delete_project",id:k("#task_breaker-project-id").val(),nonce:task_breakerProjectSettings.nonce};k(this).text("Deleting..."),k.ajax({url:ajaxurl,method:"post",data:e,success:function(e){"success"==e.message?window.location=e.redirect:this.error()},error:function(){alert(taskbreaker_strings.project_error)}})}}),k(".js-taskbreaker-task-deadline").datetimepicker({minDate:-20,dateFormat:"mm/dd/yy"})})});
//# sourceMappingURL=task-breaker.min.js.map