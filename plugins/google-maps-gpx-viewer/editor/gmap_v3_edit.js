/*
gmap_v3_edit.js, V 1.02, altm, 19.02.2014
Author: ATLSoft, Bernd Altmeier
Author URI: http://www.atlsoft.de
*/
popWin=function(a){this.init(a)}; jQuery.extend(popWin.prototype,{clicklock:!1,win:null,rapid:null,X:0,Y:0,dx:0,dy:0,init:function(a){this.win=a;this.rapid=a.rapid;jQuery(a).hide();head=jQuery(a).find(".menu_title");if(a.autoclose){var b;jQuery(a).mouseleave(function(){b=window.setTimeout(function(){jQuery(a).hide();a.popUp.clicklock=!1},200)});jQuery(a).mouseenter(function(){window.clearTimeout(b)})}jQuery(a).find(".close_btn").bind("click",a,function(){jQuery(a).hide()});jQuery(head).mouseleave(a,function(b){a.popUp.clicklock&& (a.popUp.X-=a.popUp.dx-b.clientX,a.popUp.Y-=a.popUp.dy-b.clientY);a.popUp.clicklock=!1;jQuery(this).css("cursor","pointer")});jQuery(head).mousedown(a,function(b){a.popUp.dx=b.clientX;a.popUp.dy=b.clientY;a.popUp.clicklock=!0;jQuery(this).css("cursor","move")});jQuery(head).mouseup(a,function(b){a.popUp.clicklock=!1;a.popUp.X-=a.popUp.dx-b.clientX;a.popUp.Y-=a.popUp.dy-b.clientY;a.popUp.dx=b.clientX;a.popUp.dy=b.clientY;jQuery(this).css("cursor","pointer")});jQuery(head).mousemove(a,function(b){if(a.popUp.clicklock){var d= a.popUp.X-(a.popUp.dx-b.clientX);b=a.popUp.Y-(a.popUp.dy-b.clientY);jQuery(a).css({top:b,left:d})}})},show:function(a,b){this.win.hide();var c=jQuery(a.getDiv()),d,e;e=a.gpx_overlay.getProjection().fromLatLngToContainerPixel(b.latLng);d=Math.abs(Math.round(e.x));e=Math.abs(Math.round(e.y));var g=jQuery(".iconListUI").height();g||(g=0);d>c.width()-this.win.width()&&(d-=this.win.width());e>c.height()-this.win.height()-g&&(e-=this.win.height());c=500;this.win.rapid&&(c=0);this.clicklock=!1;this.X=d; this.Y=e;this.win.css({top:e,left:d}).fadeIn(c)},hide:function(){this.win.hide()}});MkrEddi=function(a){this.init(a)}; jQuery.extend(MkrEddi.prototype,{map:null,win:null,winID:null,marker:null,visible:!1,init:function(a){this.map=a;this.winID="mEddi_"+a.getDiv().id;this.win=jQuery(document.createElement("div")).attr({id:this.winID,"class":"gm_cMenu"});this.win.append('<div class="menu_title">Waypoint<input type="button" class="close_btn" value="X" /></div><hr /><ul><li>Titel<br /><input style="width:140px;" type="text" id="title_'+a.getDiv().id+'" /><br />Descr.<br /><textarea style="width:140px;" id="content_'+a.getDiv().id+ '" rows="2"></textarea><br /></li><input type="button" value="delete" class="ed_btn_wpt" id="delete_'+a.getDiv().id+'" /> <input type="button" value="save" class="ed_btn_wpt" id="submit_'+a.getDiv().id+'" /></ul>');this.win.popUp=new popWin(this.win);jQuery(a.getDiv()).append(this.win);this.win.find("#submit_"+a.getDiv().id).click(function(){a.mrk_eddi.save()});this.win.find("#delete_"+a.getDiv().id).click(function(){a.mrk_eddi.remove()})},save:function(){this.win.hide();var a=this.marker;a.title= jQuery("#title_"+a.map.getDiv().id).val();a.content=jQuery("#content_"+a.map.getDiv().id).val();var b='<div class="gmv3_marker"><div class="gmv3_markerHeader">'+a.title+"</div>",b=b+('<div class="gmv3_markerText">'+a.content+"</div>");a.url&&(b+='<div><a class="gmv3_markerLink" target="_blank" href="'+a.url+'">',b+="more...</a></div>");b+="</div>";a.infowindow.content=b},remove:function(){this.visible=!1;this.win.popUp.hide();for(var a=0;a<this.map.markers.length;a++)if(this.map.markers[a]==this.marker){this.marker.setMap(null); this.map.markers.splice(a,1);break}},show:function(a){if(a.pixel){this.map.mrk_eddi.marker=this;this.map.mrk_eddi.visible=!0;var b=this.map.getDiv().id;jQuery("#title_"+b).val(this.title);jQuery("#content_"+b).val(this.content);this.map.mrk_eddi.win.popUp.show(this.map,a)}},hide:function(){this.visible=!1;this.win.popUp.hide()}});TrkEddi=function(a){this.init(a)}; jQuery.extend(TrkEddi.prototype,{trackMenu:null,delMenu:null,vertex:null,map:null,mapID:null,poly:null,color:null,distance:0,init:function(a){this.map=a;this.color="#ff0000";this.mapID=a.getDiv().id;this.trackMenu=jQuery(document.createElement("div")).attr({id:"trackM_"+this.mapID,"class":"gm_cMenu"});for(var b='<img src="'+pluri+'editor/blank.png" class="li_picto" />',c="",d=1;21>d;d++)c+="<option>"+d+"</option>";for(var e="",g=[0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1],d=0;10>d;d++)e+='<option id="opo_'+ 10*g[d]+'">'+g[d]+"</option>";this.trackMenu.append('<div class="menu_title">Track style <input type="button" class="close_btn" value="X" /></div><hr /><ul><li class="trackPicker">'+b+'Stroke: <select id="widthPicker">'+c+'</select></li><li class="trackPicker">'+b+'Opacity: <select id="opacityPicker" >'+e+'</select></li><li class="trackPicker">'+b+'Color: <input class="colorPicker" /></li><input type="button" value="delete" class="ed_btn_wpt" id="delTseg_'+a.getDiv().id+'" /></ul>');this.trackMenu.popUp= new popWin(this.trackMenu);jQuery(a.getDiv()).append(this.trackMenu);this.trackMenu.find("#delTseg_"+a.getDiv().id).click(function(){a.trk_eddi.remove()});var f="cp_"+this.mapID;jscolor.init(f);var f="#"+f,h;jQuery(".colorPicker").click(function(){jQuery(f).show();jQuery(f).mouseleave(function(){h=window.setTimeout(function(){window.clearTimeout(void 0);jQuery(f).hide()},200)});jQuery(f).mouseenter(function(){window.clearTimeout(void 0);window.clearTimeout(h)})});this.delMenu=jQuery(document.createElement("div")).attr({id:"vertex_"+ this.mapID,"class":"gm_cMenu"});this.delMenu.append('<input type="button" value="delete" class="ed_btn" id="delVertex_'+a.getDiv().id+'" />');this.delMenu.autoclose=!0;this.delMenu.rapid=!0;this.delMenu.popUp=new popWin(this.delMenu);jQuery(a.getDiv()).append(this.delMenu);this.delMenu.find("#delVertex_"+a.getDiv().id).click(function(){a.trk_eddi.delVertex()});google.maps.event.addListener(a,"bounds_changed",this.viewportChange)},viewportChange:function(){if(this.map_menu.start&&this.map_menu.trk){var a= 0,b=this.getBounds(),c=this.polies[this.aktPoly];c&&(c.getPath().forEach(function(d,c){b.contains(d)&&a++}),100>a?c.setEditable(!0):c.setEditable(!1))}},calcDistance:function(){for(var a=this.poly.getPath(),b=0;b<a.length;b++)0<b&&(distance+=calcDistance(a[b],a[b-1]))},gpxLoad:function(){for(var a=0;a<this.map.polies.length;a++)google.maps.event.addListener(this.map.polies[a],"click",this.map.trk_eddi.show),this.map.polies[a].setEditable(!1);this.map.aktPoly=this.map.polies.length-1;this.poly=this.map.polies[this.map.aktPoly]; 0==this.map.polies.length?this.newTrack():200>this.map.polies[this.map.aktPoly].getPath().getLength()&&this.map.polies[this.map.aktPoly].setEditable(!0)},newTrack:function(){var a="#cc3322",b="3",c="1";if(0<this.map.polies.length&&(a=this.map.polies[this.map.aktPoly].strokeColor,b=this.map.polies[this.map.aktPoly].strokeWeight,c=this.map.polies[this.map.aktPoly].strokeOpacity,1>this.map.polies[this.map.aktPoly].getPath().length)){alert("actual track is empty!");return}for(var d=0;d<this.map.polies.length;d++)this.map.polies[d].setEditable(!1); this.map.polies.push(new google.maps.Polyline({strokeColor:a,strokeOpacity:c,strokeWeight:b,editable:!0}));this.map.aktPoly=this.map.polies.length-1;a=this.map.polies[this.map.aktPoly];a.index=this.map.aktPoly;a.setMap(this.map);google.maps.event.addListener(a,"click",this.map.trk_eddi.show)},delVertex:function(){this.delMenu.popUp.hide();this.poly.getPath().removeAt(this.vertex)},remove:function(){this.trackMenu.popUp.hide();for(var a=0;a<this.map.polies.length;a++)if(this.map.polies[a]==this.poly){this.poly.setMap(null); this.map.polies.splice(a,1);0<a?(a--,this.map.aktPoly=a,this.map.polies[a].setEditable(!0)):(this.map.aktPoly=0,this.newTrack());break}},show:function(a){if(this.map.map_menu.start)if(this.map.trk_eddi.poly=this,this.map.aktPoly=this.index,!1==this.getEditable()){for(a=0;a<this.map.polies.length;a++)this.map.polies[a].setEditable(!1);this.setEditable(!0);this.map.map_menu.menu.find('a[href$="#trk"]').click()}else if(void 0!=a.vertex)this.map.trk_eddi.vertex=a.vertex,this.map.trk_eddi.delMenu.popUp.show(this.map, a);else{this.map.trk_eddi.trackMenu.popUp.show(this.map,a);jQuery(".colorPicker").css("background-color",this.strokeColor);jQuery(".colorPicker").attr("value",this.strokeColor.substr(1));jQuery("#widthPicker").find("option[value="+this.strokeWeight+"]").attr("selected","selected");jQuery("#opacityPicker > #opo_"+10*this.strokeOpacity).attr("selected","selected");var b=this;jQuery(".colorPicker").unbind("change");jQuery(".colorPicker").bind("change",b,function(){b.setOptions({strokeColor:"#"+this.value})}); jQuery("#widthPicker").unbind("change");jQuery("#widthPicker").bind("change",b,function(){b.setOptions({strokeWeight:this.options[this.selectedIndex].value})});jQuery("#opacityPicker").unbind("change");jQuery("#opacityPicker").bind("change",b,function(){b.setOptions({strokeOpacity:this.options[this.selectedIndex].value})})}}});RcMenu=function(a){this.init(a);this.map.aktPoly=0;google.maps.event.addListener(a,"rightclick",this.show)}; jQuery.extend(RcMenu.prototype,{menu:null,map:null,mapID:null,start:!0,trk:!0,init:function(a){this.map=a;this.mapID=a.getDiv().id;var b='<img src="'+pluri+'editor/check.png" class="li_picto" />',c='<img src="'+pluri+'editor/blank.png" class="li_picto" />';this.menu=jQuery(document.createElement("div")).attr({id:"cM_"+this.mapID,"class":"gm_cMenu"});this.menu.append('<div class="menu_title">Draw<input type="button" class="close_btn" value="X" /></div><hr /><ul><li><a href="#start">'+b+'Start</a></li><li><a href="#stop">'+ c+'Stop</a><hr /></li><li><a href="#newTrack">'+c+'New Track</a></li><li><a href="#trk">'+b+'Track</a></li><li><a href="#wpt">'+c+'Waypoint</a><hr /></li><li><a href="#undo">'+c+"undo last</a></li></ul>");this.menu.autoclose=!0;this.menu.popUp=new popWin(this.menu);jQuery(a.getDiv()).append(this.menu);var d=this.menu.find("li");this.menu.find("a").click(function(){var b=jQuery(this).attr("href").split("#"),b=b[b.length-1];switch(b){case "start":a.map_menu.start=!0;a.map_menu.trk&&a.polies[a.aktPoly].setEditable(!0); a.map_menu.enableMarkers();jQuery(d[0]).children("a").children("img").attr("src",pluri+"editor/check.png");jQuery(d[1]).children("a").children("img").attr("src",pluri+"editor/blank.png");break;case "stop":a.map_menu.start=!1;for(var c=0;c<a.polies.length;c++)a.polies[c].setEditable(!1);a.map_menu.disableMarker();jQuery(d[1]).children("a").children("img").attr("src",pluri+"editor/check.png");jQuery(d[0]).children("a").children("img").attr("src",pluri+"editor/blank.png");break;case "trk":a.map_menu.trk= !0;a.polies.length&&a.polies[a.aktPoly].setEditable(!0);jQuery(d[3]).children("a").children("img").attr("src",pluri+"editor/check.png");jQuery(d[4]).children("a").children("img").attr("src",pluri+"editor/blank.png");jQuery("#toWpt").prop("checked",!1);jQuery("#toTrack").prop("checked",!0);toggleTrkWpt(!0);break;case "wpt":a.map_menu.trk=!1;for(c=0;c<a.polies.length;c++)a.polies[c].setEditable(!1);jQuery(d[4]).children("a").children("img").attr("src",pluri+"editor/check.png");jQuery(d[3]).children("a").children("img").attr("src", pluri+"editor/blank.png");jQuery("#toTrack").prop("checked",!1);jQuery("#toWpt").prop("checked",!0);toggleTrkWpt(!1);break;case "newTrack":a.map_menu.newTrack(!1);a.map_menu.trk||jQuery(".gm_cMenu").find('a[href=$"#trk"]').click();break;case "undo":c=!1;if(a.map_menu.trk){var f=a.polies[a.aktPoly].getPath();0<f.length?f.pop():c=!0}else 0<a.markers.length?(a.markers[a.markers.length-1].setMap(null),a.markers.pop()):c=!0;c&&alert("Nothing to do!")}"start"==b&&a.map_menu.menu.popUp.hide();return!1}); google.maps.event.addListener(a,"click",this.updateOverlay)},gpxLoad:function(){this.map.trk_eddi.gpxLoad();this.enableMarkers()},newTrack:function(){this.map.trk_eddi.newTrack();this.menu.popUp.hide()},enableMarkers:function(){if(0<this.map.markers.length)for(var a=0;a<this.map.markers.length;a++){var b=this.map.markers[a];b.setDraggable(!0);b.event&&google.maps.event.removeListener(b.event);google.maps.event.clearInstanceListeners(b);b.event=new google.maps.event.addListener(b,"click",this.map.mrk_eddi.show)}}, disableMarker:function(){if(0<this.map.markers.length)for(var a=0;a<this.map.markers.length;a++){var b=this.map.markers[a];b.setDraggable(!1);b.event&&google.maps.event.removeListener(b.event);google.maps.event.clearInstanceListeners(b);b.event=new google.maps.event.addListener(b,"click",function(){this.map.infoWin&&this.map.infoWin.infowindow.close();this.infowindow.open(this.map,this);this.map.infoWin=this})}},show:function(a){this.map_menu.menu.popUp.show(this,a)},updateOverlay:function(a){if(this.map_menu.start)if(this.map_menu.trk)this.polies[this.aktPoly].getPath().push(a.latLng); else if(this.mdrag)this.mdrag=!1;else{var b="",c="";selectedIcon&&(b=new google.maps.MarkerImage(selectedIcon.children("img").attr("src")),c=selectedIcon.children("img").attr("alt"));a=new google.maps.Marker({position:a.latLng,draggable:!0,title:c,content:"",link:"",icon:b,event:null,map:this});a.event=google.maps.event.addListener(a,"click",this.mrk_eddi.show);a.infowindow=new google.maps.InfoWindow({content:""});google.maps.event.addListener(a,"dragend",function(){this.map.mdrag=!0});this.markers.push(a)}}});