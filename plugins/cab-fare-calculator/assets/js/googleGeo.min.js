var GoogleGeoCore=new function(){this.MapStep1=null;this.DirectionsServiceStep1=null;this.DirectionRendererStep1=null;this.AddressService=null;this.PlacesService=null;this.MapZoomSize=14;this.GeocodeRadius=32000;this.LocationString="";this.Geogoder=null;this.Pushpins=[];this.UserLocationLat=0;this.UserLocationLng=0;this.ClientIP=null;this.LatestDirtectionMarkers=null;this.markerLabels="ABCDEFGHIJKLMNOPQRSTUVWXYZ";this.Init=function(){GoogleGeoCore.InitMapWithCurrentPosition(function(b,a){GoogleGeoCore.InitMap(b,a)})};this.InitMapWithCurrentPosition=function(a){var e=false;a(TBFSettings.defaultMapLat,TBFSettings.defaultMapLng);function b(){jQuery.get("https://freegeoip.net/json/",function(f){e=true;a(f.latitude,f.longitude)}).fail(function(){jQuery.getJSON("http://ipinfo.io/"+clientIP+"/json",function(h){var g=h.loc.split(",");var i=g[0];var f=g[1];e=true;a(i,f)}).error(function(){jQuery.getJSON("http://ip-api.com/json",function(f){e=true;a(f.lat,f.lon)}).error(function(){jQuery.getJSON("http://ip.pycox.com/json/",function(f){e=true;a(f.latitude,f.longitude)}).error(function(){})})})})}function c(){var f=TBFSettings.defaultCity+", "+TBFSettings.defaultCountry;new google.maps.Geocoder().geocode({address:f},function(h,g){if(g==google.maps.GeocoderStatus.OK){e=true;TBFSettings.defaultMapLat=h[0].geometry.location.lat();TBFSettings.defaultMapLng=h[0].geometry.location.lng();a(h[0].geometry.location.lat(),h[0].geometry.location.lng())}else{console.log("Error on Geocoder.geocode: "+g)}})}};this.InitMap=function(c,b){GoogleGeoCore.LocationString=c+","+b;console.log(GoogleGeoCore.LocationString);GoogleGeoCore.UserLocationLat=c;GoogleGeoCore.UserLocationLng=b;GoogleGeoCore.Geolocation=new google.maps.LatLng(c,b);var a={center:new google.maps.LatLng(c,b),zoom:GoogleGeoCore.MapZoomSize,disableDefaultUI:false,scrollwheel:true,disableDoubleClickZoom:false};if(jQuery(window).width()<768){a.draggable=false}else{a.draggable=true}if(TBFSettings.defaultCountry!=""){a.componentRestrictions={country:TBFSettings.defaultCountry}}if(TBFSettings.showMapOnDesktop){this.MapStep1=new google.maps.Map(document.getElementById("map-canvas-step1"),a)}GoogleGeoCore.DirectionsService1=new google.maps.DirectionsService();GoogleGeoCore.DirectionRenderer1=new google.maps.DirectionsRenderer();GoogleGeoCore.AddressService=new google.maps.places.AutocompleteService();if(TBFSettings.showMapOnDesktop){GoogleGeoCore.PlacesService=new google.maps.places.PlacesService(GoogleGeoCore.MapStep1)}if(TBFSettings.showMapInPopupOnly){GoogleGeoCore.PlacesService=new google.maps.places.PlacesService(document.createElement("div"))}GoogleGeoCore.Geocoder=new google.maps.Geocoder();if(TBFSettings.addressBookingEnabled){this.getGooglePlaceAutocompleteList("address_from",a);this.getGooglePlaceAutocompleteList("address_to",a);if(TBFSettings.stopsEnabled){this.getGooglePlaceAutocompleteList("tmp_waypoint",a)}}};this.ClearPushpins=function(){for(var a=0;a<GoogleGeoCore.Pushpins.length;a++){GoogleGeoCore.Pushpins[a].setMap(null)}};this.DisplayPushpinOnMap=function(a,b){if(a!=undefined&&a.Latitude!=null&&a.Longitude!=null){var c=new google.maps.LatLng(a.Latitude,a.Longitude);var e=new google.maps.Marker({position:c,map:GoogleGeoCore.MapStep1,draggable:true});GoogleGeoCore.Pushpins.push(e);GoogleGeoCore.MapStep1.panTo(e.getPosition());google.maps.event.addListener(e,"dragend",function(f){if(jQuery(b).attr("id")=="address_from"){jQuery("#address_from_lat").val(this.getPosition().lat());jQuery("#address_from_lng").val(this.getPosition().lng());var g=new google.maps.LatLng(this.getPosition().lat(),this.getPosition().lng());GoogleGeoCore.Geocoder.geocode({latLng:g},function(i,h){if(h==google.maps.GeocoderStatus.OK){if(i[0]){jQuery("#address_from").val(i[0].formatted_address)}}})}})}};this.RenderDirections=function(){if(TBFSettings.showMapInPopupOnly){var b={center:new google.maps.LatLng(jQuery("#address_from_lat").val(),jQuery("#address_from_lng").val()),zoom:GoogleGeoCore.MapZoomSize,disableDefaultUI:false,scrollwheel:true,disableDoubleClickZoom:false};if(jQuery(window).width()<768){b.draggable=false}else{b.draggable=true}if(TBFSettings.defaultCountry!=""){b.componentRestrictions={country:TBFSettings.defaultCountry}}this.MapStep1=new google.maps.Map(document.getElementById("map-canvas-step1"),b)}this.labelIndex=0;jQuery("#estimatedDistance,#estimatedDuration").text("");GoogleGeoCore.DirectionRenderer1.setMap(GoogleGeoCore.MapStep1);GoogleGeoCore.ClearPushpins();var p=[];if(jQuery("#booking_type").val()=="address"){if(jQuery("#address_from_lat").val()!=""&&jQuery("#address_from_lng").val()!=""){var f={Latitude:jQuery("#address_from_lat").val(),Longitude:jQuery("#address_from_lng").val()}}if(jQuery("#address_to_lat").val()!=""&&jQuery("#address_to_lng").val()!=""){var n={Latitude:jQuery("#address_to_lat").val(),Longitude:jQuery("#address_to_lng").val()}}var c=jQuery("div#stops_data_wrapper").children(".stoprow");jQuery("div#stops_data_wrapper").children(".stoprow").each(function(){p.push({Latitude:jQuery(this).find(".waypoints_lat").val(),Longitude:jQuery(this).find(".waypoints_lng").val()})})}if(f!=undefined&&n==undefined){GoogleGeoCore.DisplayPushpinOnMap(f,jQuery("#address_from"))}if(f!=undefined&&n!=undefined&&f.Latitude!=null&&f.Longitude!=null&&n.Latitude!=null&&n.Longitude!=null){var k=[];var g;for(g=0;g<p.length;g++){k.push({location:new google.maps.LatLng(p[g].Latitude,p[g].Longitude),stopover:true})}var o=new google.maps.LatLng(f.Latitude,f.Longitude);var l=new google.maps.LatLng(n.Latitude,n.Longitude);var a=google.maps.UnitSystem.IMPERIAL;if(TBFSettings.distanceUnit=="km"){a=google.maps.UnitSystem.METRIC}var e={origin:o,destination:l,waypoints:k,optimizeWaypoints:TBFSettings.optimizeStops,travelMode:google.maps.TravelMode.DRIVING,unitSystem:a,avoidFerries:TBFSettings.GAPIavoidFerries,avoidHighways:TBFSettings.GAPIavoidHighways,avoidTolls:TBFSettings.GAPIavoidTolls};var m=[f];for(g=0;g<p.length;g++){m.push(p[g])}m.push(n);var h=[];var j=m.length;for(g=0;g<j-1;g++){h.push({from:m[g],to:m[g+1]})}GoogleGeoCore.DirectionsService1.route(e,function(r,s){if(s==google.maps.DirectionsStatus.OK){GoogleGeoCore.DirectionRenderer1.setDirections(r);var q=r.routes[0].legs;var u=0,i=0,t=0;GoogleGeoCore.LatestDirtectionMarkers=[];var w=[];for(var v=0;v<q.length;v++){i+=q[v].distance.value;t+=q[v].duration.value;if(v==0){GoogleGeoCore.ApplyMarkerIcon(q[v].start_location,"address_from",q[v].start_address);GoogleGeoCore.LatestDirtectionMarkers.push(q[v].start_location)}if(q.length>1&&v>0){GoogleGeoCore.LatestDirtectionMarkers.push(q[v].start_location);GoogleGeoCore.ApplyMarkerIcon(q[v].start_location,"waypoint",q[v].start_address);u++}if(v==q.length-1){GoogleGeoCore.LatestDirtectionMarkers.push(q[v].end_location);GoogleGeoCore.ApplyMarkerIcon(q[v].end_location,"address_to",q[v].end_address)}}GoogleGeoCore.ApplyDistance(i,"outbound");GoogleGeoCore.ApplyDuration(t,"outbound")}else{if(s==google.maps.DirectionsStatus.ZERO_RESULTS){jQuery("#estimatedDistance").text(TBTranslations.ERR_MESSAGE_ESTIMATED_DISTANCE_CALCULATE);jQuery("#estimatedDuration").text("");GoogleGeoCore.DirectionRenderer1.setMap(null)}}})}else{GoogleGeoCore.DirectionRenderer1.setMap()}};this.ApplyDistance=function(a,c){if(a>0){var b=(TBFSettings.distanceUnit=="mile")?0.000621371192:0.001;var f=Math.round(a*b*100)/100;if(c=="outbound"){var e=(TBFSettings.distanceUnit=="mile")?TBTranslations.BOOKING_FORM_DISTANCE_UNIT_MILES_LABEL:TBTranslations.BOOKING_FORM_DISTANCE_UNIT_KM_LABEL;jQuery("#estimatedDistance").text(TBTranslations.BOOKING_FORM_ESTIMATED_DISTANCE_LBL+": "+f+" "+e)}else{}}else{jQuery("#estimatedDistance").text(TBTranslations.BOOKING_FORM_ESTIMATED_DISTANCE_LBL+": 0")}};this.ApplyDuration=function(b,g){if(b>0){d=Number(b);var e=Math.floor(d/3600);var a=Math.floor(d%3600/60);var c=Math.floor(d%3600%60);var j=e>0?e+TBTranslations.CAR_LIST_ESTIMATED_TIME_HR.replace("%s",""):"";var i=a>0?a+TBTranslations.CAR_LIST_ESTIMATED_TIME_MIN.replace("%s",""):"";var f=c>0?c+(c==1?" second":" seconds"):"";if(g=="outbound"){jQuery("#estimatedDuration").text(TBTranslations.BOOKING_FORM_ESTIMATED_DURATION_LBL+": "+j+i)}else{}}else{jQuery("#estimatedDuration").text(TBTranslations.BOOKING_FORM_ESTIMATED_DURATION_LBL+": 0")}};this.ApplyMarkerIcon=function(a,c,e){if(c=="waypoint"){var b=new google.maps.Marker({position:a,map:GoogleGeoCore.MapStep1,title:e,label:this.markerLabels[this.labelIndex++%this.markerLabels.length],draggable:false})}else{if(jQuery("#booking_type").val()=="address"){var b=new google.maps.Marker({position:a,map:GoogleGeoCore.MapStep1,title:e,label:this.markerLabels[this.labelIndex++%this.markerLabels.length],draggable:true})}else{var b=new google.maps.Marker({position:a,map:GoogleGeoCore.MapStep1,title:e,label:this.markerLabels[this.labelIndex++%this.markerLabels.length],draggable:false})}}GoogleGeoCore.Pushpins.push(b);if(c!="waypoint"){google.maps.event.addListener(b,"dragend",function(f){jQuery("#"+c+"_lat").val(this.getPosition().lat());jQuery("#"+c+"_lng").val(this.getPosition().lng());jQuery("#booking_type").val("address");if(TBFSettings.showMapOnDesktop){GoogleGeoCore.RenderDirections()}var g=new google.maps.LatLng(this.getPosition().lat(),this.getPosition().lng());GoogleGeoCore.Geocoder.geocode({latLng:g},function(i,h){if(h==google.maps.GeocoderStatus.OK){if(i[0]){jQuery("#"+c).val(i[0].formatted_address)}}})})}};this.ResizeMap=function(){google.maps.event.trigger(GoogleGeoCore.MapStep1,"resize")};this.getGooglePlaceAutocompleteList=function(f,e,a){if(typeof a=="undefined"){a=true}var c=document.getElementById(f);var b=new google.maps.places.Autocomplete(c,e);google.maps.event.addListener(b,"place_changed",function(){var g=b.getPlace();if(g.geometry){jQuery("#"+f+"_lat").val(g.geometry.location.lat());jQuery("#"+f+"_lng").val(g.geometry.location.lng());jQuery("#"+f).closest("div.step1-inputWrap").removeClass("has-error");if(a&&TBFEngine.checkAreaOperation(f)){jQuery("#booking_type").val("address");if(f=="address_to"){TBFEngine.showViewMapBtn()}if(f!="waypoint"){if(TBFSettings.showMapOnDesktop){GoogleGeoCore.RenderDirections()}}}}})};this.getUserLocation=function(a){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(b){jQuery("#"+a+"_lat").val(b.coords.latitude);jQuery("#"+a+"_lng").val(b.coords.longitude);jQuery("#"+a).closest("div.step1-inputWrap").removeClass("has-error");if(TBFEngine.checkAreaOperation(a)){jQuery("#booking_type").val("address");if(a=="address_to"){TBFEngine.showViewMapBtn()}if(TBFSettings.showMapOnDesktop){GoogleGeoCore.RenderDirections()}var c=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);GoogleGeoCore.Geocoder.geocode({latLng:c},function(f,e){if(e==google.maps.GeocoderStatus.OK){if(f[0]){jQuery("#"+a).val(f[0].formatted_address)}}})}},function(){})}}};