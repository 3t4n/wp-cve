var EnviraGalleryImage=Backbone.Model.extend({defaults:{id:"",title:"",caption:"",alt:"",link:""}}),EnviraGalleryImages=new Backbone.Collection;if(void 0===EnviraGalleryModalWindow)var EnviraGalleryModalWindow=new wp.media.view.Modal({controller:{trigger:function(){}}});var EnviraGalleryEditView=wp.Backbone.View.extend({tagName:"div",className:"edit-attachment-frame mode-select hide-menu hide-router",template:wp.template("envira-meta-editor"),events:{"click .edit-media-header .left":"loadPreviousItem","click .edit-media-header .right":"loadNextItem","keyup input":"updateItem","keyup textarea":"updateItem","change input":"updateItem","change textarea":"updateItem","blur textarea":"updateItem","change select":"updateItem","click .actions a.envira-gallery-meta-submit":"saveItem","keyup input#link-search":"searchLinks","click div.query-results li":"insertLink","click button.media-file":"insertMediaFileLink","click button.attachment-page":"insertAttachmentPageLink"},initialize:function(e){this.on("loading",this.loading,this),this.on("loaded",this.loaded,this),this.is_loading=!1,this.collection=e.collection,this.child_views=e.child_views,this.attachment_id=e.attachment_id,this.attachment_index=0,this.search_timer="";var a=0;this.collection.each(function(e){if(e.get("id")==this.attachment_id)return this.model=e,this.attachment_index=a,!1;a++},this)},render:function(){return this.$el.html(this.template(this.model.attributes)),this.child_views.length>0&&this.child_views.forEach(function(e){var a=new e({model:this.model});this.$el.find("div.envira-addons").append(a.render().el)},this),this.$el.find("textarea[name=caption]").val(this.model.get("caption")),setTimeout(function(){quicktags({id:"caption",buttons:"strong,em,link,ul,ol,li,close"}),QTags._buttonsInit()},500),wpLink.init,0==this.attachment_index&&this.$el.find("button.left").addClass("disabled"),this.attachment_index==this.collection.length-1&&this.$el.find("button.right").addClass("disabled"),this},renderError:function(e){var a={};return a.error=e,new wp.media.view.EnviraGalleryError({model:a}).render().el},loading:function(){this.is_loading=!0,this.$el.find(".spinner").css("visibility","visible")},loaded:function(e){this.is_loading=!1,this.$el.find(".spinner").css("visibility","hidden"),void 0!==e&&this.$el.find("div.media-toolbar").after(this.renderError(e))},loadPreviousItem:function(){this.attachment_index--,this.model=this.collection.at(this.attachment_index),this.attachment_id=this.model.get("id"),this.render()},loadNextItem:function(){this.attachment_index++,this.model=this.collection.at(this.attachment_index),this.attachment_id=this.model.get("id"),this.render()},updateItem:function(e){""!=e.target.name&&("checkbox"==e.target.type?value=e.target.checked?e.target.value:0:value=e.target.value,this.model.set(e.target.name,value))},saveItem:function(e){var a=jQuery("#envira-metabox-saving-error");0!==a.length&&a.hide(),e.preventDefault(),this.trigger("loading"),wp.media.ajax("envira_gallery_save_meta",{context:this,data:{nonce:envira_gallery_metabox.save_nonce,post_id:envira_gallery_metabox.id,attach_id:this.model.get("id"),meta:this.model.attributes},success:function(e){this.trigger("loaded loaded:success");var a=JSON.stringify(this.model.attributes),t=jQuery("ul#envira-gallery-output li#"+this.model.get("id"));jQuery(t).attr("data-envira-gallery-image-model",a),jQuery("div.meta div.title span",t).text(this.model.get("title")),jQuery("div.meta div.title a.hint",t).attr("title",this.model.get("title")),this.model.get("title").length>20?jQuery("div.meta div.title a.hint",t).removeClass("hidden"):jQuery("div.meta div.title a.hint",t).addClass("hidden");var i=this.$el.find(".saved");i.fadeIn(),setTimeout(function(){i.fadeOut()},1500)},error:function(e){if(this.trigger("loaded loaded:error",e),0===a.length){var t=this.$el.find(".saved");jQuery(t).after(`<span id='envira-metabox-saving-error' style='color: red'>${e}</span>`)}else a.show(),a.html(e)}})},searchLinks:function(e){},insertLink:function(e){},insertMediaFileLink:function(e){this.trigger("loading"),wp.media.ajax("envira_gallery_get_attachment_links",{context:this,data:{nonce:envira_gallery_metabox.save_nonce,attachment_id:this.model.get("id")},success:function(e){this.model.set("link",e.media_link),this.trigger("loaded loaded:success"),this.render()},error:function(e){this.trigger("loaded loaded:error",e)}})},insertAttachmentPageLink:function(e){this.trigger("loading"),wp.media.ajax("envira_gallery_get_attachment_links",{context:this,data:{nonce:envira_gallery_metabox.save_nonce,attachment_id:this.model.get("id")},success:function(e){this.model.set("link",e.attachment_page),this.trigger("loaded loaded:success"),this.render()},error:function(e){this.trigger("loaded loaded:error",e)}})}}),EnviraGalleryChildViews=[];function EnviraGalleryImagesUpdate(e){EnviraGalleryImages.reset(),jQuery("ul#envira-gallery-output li.envira-gallery-image"+(e?".selected":"")).each(function(){var e=jQuery.parseJSON(jQuery(this).attr("data-envira-gallery-image-model"));e.alt=EnviraGalleryStripslashes(e.alt),EnviraGalleryImages.add(new EnviraGalleryImage(e))}),jQuery("#envira-gallery-main span.count").text(jQuery("ul#envira-gallery-output li.envira-gallery-image").length)}function EnviraGalleryStripslashes(e){return(e+"").replace(/\\(.?)/g,function(e,a){switch(a){case"\\":return"\\";case"0":return"\0";case"":return"";default:return a}})}jQuery(document).ready(function(e){e(document).on("click","#envira-gallery-main a.envira-gallery-modify-image",function(a){a.preventDefault(),EnviraGalleryImagesUpdate(!1);var t=e(this).parent().data("envira-gallery-image");EnviraGalleryModalWindow.content(new EnviraGalleryEditView({collection:EnviraGalleryImages,child_views:EnviraGalleryChildViews,attachment_id:t})),EnviraGalleryModalWindow.open()})}),jQuery(document).ready(function(e){e(document).on("click","a.envira-gallery-images-delete",function(a){if(a.preventDefault(),!confirm(envira_gallery_metabox.remove_multiple))return!1;var t=[];e("ul#envira-gallery-output > li.selected").each(function(){t.push(e(this).attr("id"))});e(this).parent().attr("id");e.ajax({url:envira_gallery_metabox.ajax,type:"post",dataType:"json",data:{action:"envira_gallery_remove_images",attachment_ids:t,post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.remove_nonce},success:function(a){e("ul#envira-gallery-output > li.selected").remove(),e("nav.envira-select-options").fadeOut(),e(".envira-gallery-load-library").attr("data-envira-gallery-offset",0).addClass("has-search").trigger("click"),EnviraGalleryImagesUpdate(!1)},error:function(a,t,i){e(envira_gallery_output).before('<div class="error"><p>'+t.responseText+"</p></div>")}})}),e(document).on("click","#envira-gallery-main .envira-gallery-remove-image",function(a){if(a.preventDefault(),confirm(envira_gallery_metabox.remove)){var t=e(this).parent().attr("id");e.ajax({url:envira_gallery_metabox.ajax,type:"post",dataType:"json",data:{action:"envira_gallery_remove_image",attachment_id:t,post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.remove_nonce},success:function(a){e("#"+t).fadeOut("normal",function(){e(this).remove(),e(".envira-gallery-load-library").attr("data-envira-gallery-offset",0).addClass("has-search").trigger("click"),EnviraGalleryImagesUpdate(!1)})},error:function(a,t,i){e(envira_gallery_output).before('<div class="error"><p>'+t.responseText+"</p></div>")}})}})}),jQuery(document).ready(function(e){e("a.envira-media-library").on("click",function(a){a.preventDefault(),wp.media.frames.envira?wp.media.frames.envira.open():(wp.media.frames.envira=wp.media({frame:"post",title:wp.media.view.l10n.insertIntoPost,button:{text:wp.media.view.l10n.insertIntoPost},multiple:!0}),wp.media.frames.envira.on("open",function(){var a=wp.media.frames.envira.state().get("selection");e("ul#envira-gallery-output li").each(function(){var t=wp.media.attachment(e(this).attr("id"));a.add(t?[t]:[])})}),wp.media.frames.envira.on("insert",function(a){var t=wp.media.frames.envira.state(),i=[];a.each(function(e){var a=t.display(e).toJSON();switch(a.link){case"none":case"file":e.set("link",e.get("url"));break;case"post":break;case"custom":e.set("link",a.linkUrl)}i.push(e.toJSON())},this),e(document).find(".envira-progress-adding-images").css("display","block"),e.post(envira_gallery_metabox.ajax,{action:"envira_gallery_insert_images",nonce:envira_gallery_metabox.insert_nonce,post_id:envira_gallery_metabox.id,images:JSON.stringify(i)},function(a){a&&a.success&&(e("#envira-gallery-output").html(a.success),EnviraGalleryImagesUpdate(!1),e(document).find(".envira-progress-adding-images").css("display","none"))},"json")}),wp.media.frames.envira.open(),e("div.media-menu a.media-menu-item:nth-child(2)").addClass("hidden"),e("div.media-menu a.media-menu-item:nth-child(4)").addClass("hidden"))})});var envira_gallery_output="#envira-gallery-output",envira_gallery_shift_key_pressed=!1,envira_gallery_last_selected_image=!1;function envira_gallery_sortable(e){e(envira_gallery_output).sortable({containment:envira_gallery_output,items:"li",cursor:"move",forcePlaceholderSize:!0,placeholder:"dropzone",helper:function(a,t){t.hasClass("selected")||t.addClass("selected").siblings().removeClass("selected");var i=t.parent().children(".selected").clone();return t.data("multidrag",i).siblings(".selected").remove(),e("<li/>").append(i)},stop:function(a,t){var i=t.item.data("multidrag");t.item.after(i).remove(),e("li.selected",e(envira_gallery_output)).removeClass("selected"),e.ajax({url:envira_gallery_metabox.ajax,type:"post",async:!0,cache:!1,dataType:"json",data:{action:"envira_gallery_sort_images",order:e(envira_gallery_output).sortable("toArray").toString(),post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.sort},success:function(e){EnviraGalleryImagesUpdate(!1)},error:function(a,t,i){e(envira_gallery_output).before('<div class="error"><p>'+t.responseText+"</p></div>")}})}})}jQuery(document).ready(function(e){e(document).on("click","nav.envira-tab-options a",function(a){a.preventDefault();var t=e(this).closest(".envira-tab-options"),i=e(this).data("view"),n=e(this).data("view-style");e(i).hasClass(n)||(e(i).removeClass("list").removeClass("grid").addClass(n),e("a",t).removeClass("selected"),e(this).addClass("selected"),e.ajax({url:envira_gallery_metabox.ajax,type:"post",dataType:"json",data:{action:"envira_gallery_set_user_setting",name:"envira_gallery_image_view",value:n,nonce:envira_gallery_metabox.set_user_setting_nonce},success:function(e){},error:function(a,t,i){e(envira_gallery_output).before('<div class="error"><p>'+t.responseText+"</p></div>")}}))}),e(document).on("change","nav.envira-tab-options input",function(a){e(this).prop("checked")?(e("li",e(envira_gallery_output)).addClass("selected"),e("nav.envira-select-options").fadeIn()):(e("li",e(envira_gallery_output)).removeClass("selected"),e("nav.envira-select-options").fadeOut())}),envira_gallery_sortable(e),e(document).on("enviraGalleryType",function(){e(envira_gallery_output).length>0&&envira_gallery_sortable(e)}),e(document).on("click","ul#envira-gallery-output li.envira-gallery-image > img, li.envira-gallery-image > div, li.envira-gallery-image > a.check",function(a){a.preventDefault();var t=e(this).parent();if(e(t).hasClass("selected"))e(t).removeClass("selected"),envira_gallery_last_selected_image=!1;else{if(envira_gallery_shift_key_pressed&&!1!==envira_gallery_last_selected_image){var i=e("ul#envira-gallery-output li").index(e(envira_gallery_last_selected_image)),n=e("ul#envira-gallery-output li").index(e(t)),r=0;if(i<n)for(r=i;r<=n;r++)e("ul#envira-gallery-output li:eq( "+r+")").addClass("selected");else for(r=n;r<=i;r++)e("ul#envira-gallery-output li:eq( "+r+")").addClass("selected")}e(t).addClass("selected"),envira_gallery_last_selected_image=e(t)}e("ul#envira-gallery-output > li.selected").length>0?e("nav.envira-select-options").fadeIn():e("nav.envira-select-options").fadeOut()}),e(document).on("keyup keydown",function(e){envira_gallery_shift_key_pressed=e.shiftKey})}),function(e){e(function(){if("undefined"!=typeof uploader){e("input#plupload-browse-button").val(envira_gallery_metabox.uploader_files_computer);var a=e("#envira-gallery .envira-progress-bar"),t=e("#envira-gallery .envira-progress-bar div.envira-progress-bar-inner"),i=e("#envira-gallery .envira-progress-bar div.envira-progress-bar-status"),n=e("#envira-gallery-output"),r=e("#envira-gallery-upload-error"),l=0;uploader.bind("Init",function(a){e("#drag-drop-area").fadeIn(),e("a.envira-media-library.button").fadeIn()}),uploader.bind("FilesAdded",function(t,n){e(r).html(""),l=n.length,e(".uploading .current",e(i)).text("1"),e(".uploading .total",e(i)).text(l),e(".uploading",e(i)).show(),e(".done",e(i)).hide(),e(a).fadeIn("fast",function(){e("p.max-upload-size").css("padding-top","10px")})}),uploader.bind("UploadProgress",function(a,n){e(".uploading .current",e(i)).text(l-a.total.queued+1),e(t).css({width:a.total.percent+"%"})}),uploader.bind("FileUploaded",function(a,t,i){e.post(envira_gallery_metabox.ajax,{action:"envira_gallery_load_image",nonce:envira_gallery_metabox.load_image,id:i.response,post_id:envira_gallery_metabox.id},function(a){switch(envira_gallery_metabox.media_position){case"before":e(n).prepend(a);break;case"after":default:e(n).append(a)}EnviraGalleryImagesUpdate(!1)},"json")}),uploader.bind("UploadComplete",function(){e(".uploading",e(i)).hide(),e(".done",e(i)).show(),setTimeout(function(){e(a).fadeOut("fast",function(){e("p.max-upload-size").css("padding-top","0")})},1e3)}),uploader.bind("Error",function(a,t){e("#envira-gallery-upload-error").html('<div class="error fade"><p>'+t.file.name+": "+t.message+"</p></div>"),a.refresh()})}})}(jQuery);var envira_video_link="p.envira-intro a.envira-video",envira_close_video_link="a.envira-video-close";jQuery(document).ready(function(e){e(document).on("click",envira_video_link,function(a){a.preventDefault();var t=e(this).attr("href");-1==t.search("autoplay=1")&&(-1==t.search("rel=")?t+="?rel=0&autoplay=1":t+="&autoplay=1"),e("div.envira-video-help").remove();var i=e(this).closest("p.envira-intro");e(i).append('<div class="envira-video-help"><iframe src="'+t+'" /><a href="#" class="envira-video-close dashicons dashicons-no"></a></div>')}),e(document).on("click",envira_close_video_link,function(a){a.preventDefault(),e(this).closest(".envira-video-help").remove()})});