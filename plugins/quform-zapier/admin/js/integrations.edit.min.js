var quform=function(e,b,q,a){"use strict";var t,v=e.core,r=v.cache,l=b(window),s=b(document),n=!1,o=!1,d=!1,h={integration:{},savedIntegrationJson:"",currentLogicSources:[],init:function(e){h.integration=e,r.get("#qfb-zapier-integrations-edit-form").submit(function(){return!1}),r.get("#qfb-zapier-save-integration").add(r.get("#qfb-fixed-save-button")).click(h.save),h.savedIntegrationJson=JSON.stringify(h.integration),window.onbeforeunload=function(){if(h.update(),h.savedIntegrationJson!==JSON.stringify(h.integration))return q.unsavedChanges},h.syncAdditionalFields(h.getValue(h.integration,"formId"),h.getValue(h.integration,"additionalFields")),r.get("#qfb-zapier-add-additional-field").click(function(){r.get("#qfb-zapier-integration-additional-fields-empty").hide(),r.get("#qfb-zapier-additional-fields").append(h.getAdditionalFieldHtml(h.getNewAdditionalField())).show()}),r.get("#qfb-zapier-additional-fields").on("click",".qfb-small-add-button",function(){b(this).closest(".qfb-zapier-additional-field").after(h.getAdditionalFieldHtml(h.getNewAdditionalField()))}),r.get("#qfb-zapier-additional-fields").on("click",".qfb-small-remove-button",function(){b(this).closest(".qfb-zapier-additional-field").remove(),0===r.get("#qfb-zapier-additional-fields").find("> .qfb-zapier-additional-field").length&&r.get("#qfb-zapier-integration-additional-fields-empty").fadeIn()}),r.get("#qfb_zapier_integration_form").change(h.resyncAdditionalFields),r.get("#qfb-zapier-integration-additional-fields-sync").click(h.resyncAdditionalFields),r.get("#qfb-zapier-integrations-edit-form").on("click",".qfb-zapier-insert-variable",function(e){e.preventDefault(),e.stopPropagation(),h.openInsertVariableMenu(b(this))}),r.get("#qfb-zapier-integrations-edit-form").on("click",".qfb-zapier-additional-field-value",function(e){e.stopPropagation()}),r.get("#qfb-zapier-integrations-edit-form").on("focus",".qfb-zapier-additional-field-value",function(){v.isNonEmptyString(b(this).val())||h.openInsertVariableMenu(b(this).siblings(".qfb-zapier-insert-variable"))}),r.get("#qfb_zapier_integration_logic_enabled").change(function(){r.get("#qfb-zapier-logic").closest(v.settingWrap)[r.get("#qfb_zapier_integration_logic_enabled").is(":checked")?"qfbSlideShow":"qfbSlideHide"]()}),h.syncLogic(h.getValue(h.integration,"formId"),h.getValue(h.integration,"logicAction"),h.getValue(h.integration,"logicMatch"),h.getValue(h.integration,"logicRules")),r.get("#qfb_zapier_integration_form").change(function(){h.resetLogic(),h.resyncLogic()}),r.get("#qfb-zapier-integration-logic-sync").click(h.resyncLogic),r.get("#qfb-add-logic-rule").click(function(){r.get("#qfb-zapier-logic").find(".qfb-no-logic-rules").remove(),r.get("#qfb-zapier-logic").find(".qfb-logic-rules").append(h.buildLogicRule(h.getNewLogicRule()))})},update:function(){h.integration.name=r.get("#qfb_zapier_integration_name").val(),h.integration.active=r.get("#qfb_zapier_integration_active").is(":checked"),h.integration.formId=r.get("#qfb_zapier_integration_form").val(),h.integration.webhookUrl=r.get("#qfb_zapier_integration_webhook_url").val(),h.integration.additionalFields=[],r.get("#qfb-zapier-additional-fields").find("> .qfb-zapier-additional-field").each(function(){var e=b(this);h.integration.additionalFields.push({key:e.find(".qfb-zapier-additional-field-key").val(),value:e.find(".qfb-zapier-additional-field-value").val()})}),h.integration.logicEnabled=r.get("#qfb_zapier_integration_logic_enabled").is(":checked"),h.integration.logicAction="0"!==r.get("#qfb-zapier-logic").find(".qfb-logic-action").val(),h.integration.logicMatch=r.get("#qfb-zapier-logic").find(".qfb-logic-match").val()||"all",h.integration.logicRules=h.getLogicRules(r.get("#qfb-zapier-logic"))},validate:function(){r.get("#qfb-zapier-integrations-edit-form").find(".qfb-validation-error").remove(),r.get("#qfb-zapier-integrations-edit-form").find(".qfb-field-error").removeClass("qfb-field-error");var e=[];if(v.isNonEmptyString(h.integration.name)||e.push({scrollTarget:r.get("#qfb_zapier_integration_name").closest(v.settingWrap),show:function(){r.get("#qfb_zapier_integration_name").addClass("qfb-field-error"),v.addValidationError(r.get("#qfb_zapier_integration_name").closest(v.settingInputWrap),a.thisFieldIsRequired)}}),v.isNonEmptyString(h.integration.formId)||e.push({scrollTarget:r.get("#qfb_zapier_integration_form").closest(v.settingWrap),show:function(){r.get("#qfb_zapier_integration_form").addClass("qfb-field-error"),v.addValidationError(r.get("#qfb_zapier_integration_form").closest(v.settingInputWrap),a.thisFieldIsRequired)}}),v.isNonEmptyString(h.integration.webhookUrl)||e.push({scrollTarget:r.get("#qfb_zapier_integration_webhook_url").closest(v.settingWrap),show:function(){r.get("#qfb_zapier_integration_webhook_url").addClass("qfb-field-error"),v.addValidationError(r.get("#qfb_zapier_integration_webhook_url").closest(v.settingInputWrap),a.thisFieldIsRequired)}}),r.get("#qfb-zapier-additional-fields").find("> .qfb-zapier-additional-field").each(function(){h.validateAdditionalField(b(this),e)}),e.length){v.showFixedMessage(q.correctHighlightedFields,"error");for(var i=0;i<e.length;i++)e[i].show();return v.scrollTo(e[0].scrollTarget),!1}return!0},validateAdditionalField:function(e,i){var t=e.find(".qfb-zapier-additional-field-key"),n=e.find(".qfb-zapier-additional-field-value");v.isNonEmptyString(t.val())||i.push({scrollTarget:e,show:function(){t.addClass("qfb-field-error"),v.addValidationError(t.closest(".qfb-zapier-additional-field-column"),a.thisFieldIsRequired)}}),v.isNonEmptyString(n.val())||i.push({scrollTarget:e,show:function(){n.addClass("qfb-field-error"),v.addValidationError(n.closest(".qfb-zapier-additional-field-column"),a.thisFieldIsRequired)}})},save:function(){var i;n||(n=!0,h.update(),h.validate()?("number"==typeof t&&(clearTimeout(t),t=null),r.get("#qfb-fixed-save-button").removeClass("qfb-saving qfb-saved qfb-save-error").addClass("qfb-saving"),i=JSON.stringify(h.integration),b.ajax({type:"POST",url:a.ajaxUrl,data:{action:"quform_zapier_save_integration",_ajax_nonce:q.saveIntegrationNonce,integration:i},dataType:"json"}).done(function(e){switch((e=v.sanitizeResponse(e)).type){case"success":h.savedIntegrationJson=i,v.showFixedMessage(q.integrationSaved,"success"),r.get("#qfb-fixed-save-button").removeClass("qfb-saving").addClass("qfb-saved"),t=setTimeout(function(){r.get("#qfb-fixed-save-button").removeClass("qfb-saved")},2e3);break;case"error":case"invalid":v.showFixedMessage(q.errorSavingIntegration+"<br>"+e.message,"error"),r.get("#qfb-fixed-save-button").removeClass("qfb-saving").addClass("qfb-save-error")}}).fail(function(){v.showFixedMessage(q.errorSavingIntegration+"<br>"+a.ajaxError,"error"),r.get("#qfb-fixed-save-button").removeClass("qfb-saving").addClass("qfb-save-error")}).always(function(){n=!1})):n=!1)},syncAdditionalFields:function(e,i){if(!o){if(o=!0,r.get("#qfb-zapier-additional-fields").hide().html(""),r.get("#qfb-zapier-integration-additional-fields-error").hide().html(""),r.get("#qfb-zapier-integration-additional-fields-empty").hide(),r.get("#qfb-zapier-integration-additional-fields-spinner").show(),!b.isNumeric(e))return o=!1,void h.onSyncAdditionalFieldsFail(q.pleaseSelectAFormFirst);b.ajax({type:"POST",url:a.ajaxUrl,data:{action:"quform_zapier_get_additional_field_elements",form_id:e},dataType:"json"}).done(function(e){"success"===(e=v.sanitizeResponse(e)).type?(h.rebuildInsertVariableMenuElements(e.elements),h.rebuildAdditionalFields(i)):h.onSyncAdditionalFieldsFail(e.message)}).fail(function(){h.onSyncAdditionalFieldsFail(a.ajaxError)}).always(function(){o=!1,r.get("#qfb-zapier-integration-additional-fields-spinner").hide()})}},onSyncAdditionalFieldsFail:function(e){h.integration.additionalFields=[],r.get("#qfb-zapier-integration-additional-fields-spinner").hide(),r.get("#qfb-zapier-integration-additional-fields-error").html(e).show()},resyncAdditionalFields:function(){h.update(),h.syncAdditionalFields(r.get("#qfb_zapier_integration_form").val(),h.getValue(h.integration,"additionalFields"))},rebuildAdditionalFields:function(e){var i=[],t=0,n=e.length;if(0<n){for(;t<n;t++)i.push(h.getAdditionalFieldHtml(e[t]));r.get("#qfb-zapier-additional-fields").html(i).show()}else r.get("#qfb-zapier-additional-fields").hide(),r.get("#qfb-zapier-integration-additional-fields-empty").show()},getNewAdditionalField:function(){return{key:"",value:""}},getAdditionalFieldHtml:function(e){var i=b(q.additionalFieldHtml),t=h.getVariableId();return i.find(".qfb-zapier-additional-field-key").val(e.key),i.find(".qfb-zapier-additional-field-value").val(e.value).attr("id",t).siblings(".qfb-zapier-insert-variable").data("target-id",t),i},getVariableId:function i(){return i.count=i.count||0,"qfb-zapier-var-"+ ++i.count},openInsertVariableMenu:function(a){h.closeInsertVariableMenu();var e=r.get("#qfb-zapier-insert-variable"),i=e.outerHeight(),t=a.offset().top-l.scrollTop()+a.outerHeight()/2-i/2,n=a.offset().left+a.outerWidth(),o="auto";t<42?t=42:t+i>l.height()-10&&(t="auto",o=10),a.addClass("qfb-zapier-active"),e.css({top:t,left:n,bottom:o}).fadeIn(200),r.get("#qfb-zapier-integrations-edit-form").one("click.insert-variable",".qfb-zapier-variable",function(e){e.preventDefault();var i,t=a.data("target-id"),n=v.toString(b(this).data("tag"))||"";!n.length||(i=b("#"+t)).length&&h.insertAtCursor(i[0],n)}),s.one("click.close-insert-variable",h.closeInsertVariableMenu)},closeInsertVariableMenu:function(){b(".qfb-zapier-insert-variable").removeClass("qfb-zapier-active"),r.get("#qfb-zapier-insert-variable").add(r.get("#qfb-zapier-insert-variable-pre-process")).scrollTop(0).hide(),r.get("#qfb-zapier-integrations-edit-form").off("click.insert-variable"),s.off("click.close-insert-variable")},insertAtCursor:function(e,i){var t,n,a,o,r;return document.selection?(e.focus(),document.selection.createRange().text=i):e.selectionStart||0===e.selectionStart?(o=e.value,t=e.selectionStart,n=e.selectionEnd,a=e.scrollTop,e.value=o.substring(0,t)+i+o.substring(n,o.length),e.selectionStart=t+i.length,e.selectionEnd=t+i.length,e.scrollTop=a):e.value+=i,e.focus(),document.createEvent?((r=document.createEvent("HTMLEvents")).initEvent("change",!1,!0),e.dispatchEvent(r)):e.fireEvent&&e.fireEvent("onchange"),!0},rebuildInsertVariableMenuElements:function(e){for(var i=[],t=0;t<e.length;t++){var n=e[t],a=h.shorten(n.label);i.push(b('<div class="qfb-zapier-variable">').data({tag:"{element|id:"+n.id+"|"+a+"}",id:n.id}).html([b('<span class="qfb-zapier-variable-label">').text(a),b('<span class="qfb-zapier-variable-identifier">').text("("+n.identifier+")")]))}r.get("#qfb-zapier-insert-variable-element").html(i)},shorten:function(e,i,t){i=i||30,t=t||"...";var n=Math.floor(i/2);return e.length>i&&(e=e.slice(0,n-1)+t+e.slice(-n)),e},getAdminLabel:function(e){return"string"==typeof e.adminLabel&&0<e.adminLabel.length?e.adminLabel:"string"==typeof e.label&&0<e.label.length?e.label:""},getShortenedAdminLabel:function(e){var i=h.shorten(h.getAdminLabel(e));return q.adminLabelElementId.replace("%1$s",i).replace("%2$s",e.identifier)},syncLogic:function(e,i,t,n){if(!d){if(d=!0,r.get("#qfb-zapier-logic").hide(),r.get("#qfb-zapier-logic-error").hide().html(""),r.get("#qfb-zapier-integration-logic-spinner").show(),!b.isNumeric(e))return d=!1,void h.onSyncLogicFail(q.pleaseSelectAFormFirst);b.ajax({type:"POST",url:a.ajaxUrl,data:{action:"quform_zapier_get_logic_sources",form_id:e},dataType:"json"}).done(function(e){"success"===(e=v.sanitizeResponse(e)).type?(h.currentLogicSources=e.logicSources,h.buildLogic([{text:q.runThisIntegration,value:"1"},{text:q.doNotRunThisIntegration,value:"0"}],[{text:q.ifAllOfTheseRulesMatch,value:"all"},{text:q.ifAnyOfTheseRulesMatch,value:"any"}],n,r.get("#qfb-zapier-logic"),i?"1":"0",t)):h.onSyncLogicFail(e.message)}).fail(function(){h.onSyncLogicFail(a.ajaxError)}).always(function(){d=!1,r.get("#qfb-zapier-integration-logic-spinner").hide()})}},onSyncLogicFail:function(e){h.resetLogic(),r.get("#qfb-zapier-integration-logic-spinner").hide(),r.get("#qfb-zapier-logic-error").html(e).show()},buildLogic:function(e,i,t,n,a,o){if(0!==h.currentLogicSources.length){n.empty();var r=b('<div class="qfb-logic-top qfb-settings-row">'),l=b('<div class="qfb-settings-column">'),s=b('<div class="qfb-settings-column">');if(e.length){r.addClass("qfb-settings-row-2");for(var d=b('<select class="qfb-logic-action">'),g=0;g<e.length;g++)d.append(b("<option>",e[g]));v.setSelectVal(d,a),r.append(l.append(d))}for(var c=b('<select class="qfb-logic-match">'),f=0;f<i.length;f++)c.append(b("<option>",i[f]));v.setSelectVal(c,o),r.append(s.append(c)),n.append(r);var u=b('<div class="qfb-logic-rules qfb-cf">');if(t.length)for(var p=0;p<t.length;p++)u.append(h.buildLogicRule(t[p]));else u.append(h.getNoLogicRulesMessage());n.append(u).show()}else n.html(h.buildMessageBox(q.noLogicElements,"warning"))},buildLogicRule:function(e){if(0===h.currentLogicSources.length||"object"!=typeof e)return null;for(var i=b(q.logicRuleHtml).data("rule",e),t=b('<select class="qfb-logic-rule-element">'),n=0;n<h.currentLogicSources.length;n++)t.append(b("<option>",{text:h.getShortenedAdminLabel(h.currentLogicSources[n]),value:h.currentLogicSources[n].id}));v.setSelectVal(t,e.elementId),i.find(".qfb-logic-rule-column-element").html(t);var a=b('<select class="qfb-logic-rule-operator">');return a.append(b("<option>",{text:q.is,value:"eq"})),a.append(b("<option>",{text:q.isNot,value:"neq"})),a.append(b("<option>",{text:q.isEmpty,value:"empty"})),a.append(b("<option>",{text:q.isNotEmpty,value:"not_empty"})),a.append(b("<option>",{text:q.greaterThan,value:"gt"})),a.append(b("<option>",{text:q.lessThan,value:"lt"})),a.append(b("<option>",{text:q.contains,value:"contains"})),a.append(b("<option>",{text:q.startsWith,value:"starts_with"})),a.append(b("<option>",{text:q.endsWith,value:"ends_with"})),v.setSelectVal(a,e.operator),i.find(".qfb-logic-rule-column-operator").html(a),i.find(".qfb-logic-rule-column-value").html(h.buildLogicRuleValues(t.val(),e)),i.on("change",".qfb-logic-rule-element, .qfb-logic-rule-operator",function(){var e={elementId:i.find(".qfb-logic-rule-element").val(),operator:i.find(".qfb-logic-rule-operator").val(),value:"",optionId:null};i.find(".qfb-logic-rule-column-value").html(h.buildLogicRuleValues(t.val(),e))}),i.find(".qfb-small-add-button").click(function(){b(this).closest(".qfb-logic-rule").after(h.buildLogicRule(h.getNewLogicRule()))}),i.find(".qfb-small-remove-button").click(function(){var e=b(this).closest(".qfb-logic-rules");b(this).closest(".qfb-logic-rule").remove(),0===e.find(".qfb-logic-rule").length&&h.getNoLogicRulesMessage().hide().appendTo(e).fadeIn()}),i},buildLogicRuleValues:function(e,i){var t=h.getLogicSourceElementById(parseInt(e,10));if("empty"===i.operator||"not_empty"===i.operator)a=b('<input class="qfb-logic-rule-value" type="hidden">');else if("select"!==t.type&&"radio"!==t.type&&"checkbox"!==t.type&&"multiselect"!==t.type||"eq"!==i.operator&&"neq"!==i.operator)a=b('<input class="qfb-logic-rule-value" type="text">').attr("placeholder",q.enterValue).val(i.value);else{for(var n=0,a=b('<select class="qfb-logic-rule-value">');n<t.options.length;n++)if("select"!==t.type&&"multiselect"!==t.type||"undefined"==typeof t.options[n].options)a.append(b("<option>",{text:h.getShortenedOptionLabel(t.options[n]),value:t.options[n].id}));else{for(var o=b("<optgroup>",{label:h.shorten(t.options[n].label)}),r=0;r<t.options[n].options.length;r++)o.append(b("<option>",{text:h.getShortenedOptionLabel(t.options[n].options[r]),value:t.options[n].options[r].id}));a.append(o)}v.setSelectVal(a,i.optionId)}return a},getLogicSourceElementById:function(e){for(var i=0;i<h.currentLogicSources.length;i++)if(h.currentLogicSources[i].id===e)return h.currentLogicSources[i];return null},getLogicSourceElementOptionById:function(e,i){for(var t=0;t<e.options.length;t++)if("undefined"==typeof e.options[t].options){if(e.options[t].id===i)return e.options[t]}else for(var n=0;n<e.options[t].options.length;n++)if(e.options[t].options[n].id===i)return e.options[t].options[n];return null},getShortenedOptionLabel:function(e){return 0<e.label.length?h.shorten(e.label):h.shorten(e.value)},getLogicRules:function(e){var i=[];return e.find(".qfb-logic-rule").each(function(){i.push(h.getLogicRuleObjectFromValues(b(this)))}),i},getLogicRuleObjectFromValues:function(e){var i,t,n=e.find(".qfb-logic-rule-value"),a=e.find(".qfb-logic-rule-element").val(),o=n.val(),r=null;return n.is("select")&&(!(i=h.getLogicSourceElementById(parseInt(a,10)))||(t=h.getLogicSourceElementOptionById(i,parseInt(o,10)))&&(r=o,o=t.value)),{elementId:a,operator:e.find(".qfb-logic-rule-operator").val(),optionId:r,value:o}},getNewLogicRule:function(){return{elementId:"",operator:"eq",value:"",optionId:null}},getNoLogicRulesMessage:function(){return h.buildMessageBox(q.noLogicRules,"info","qfb-no-logic-rules")},resetLogic:function(){r.get("#qfb-zapier-logic").find(".qfb-logic-action").val("1"),r.get("#qfb-zapier-logic").find(".qfb-logic-match").val("all"),r.get("#qfb-zapier-logic").find(".qfb-logic-rules").empty()},resyncLogic:function(){h.update(),h.syncLogic(h.getValue(h.integration,"formId"),h.getValue(h.integration,"logicAction"),h.getValue(h.integration,"logicMatch"),h.getValue(h.integration,"logicRules"))},buildMessageBox:function(e,i,t){var n=b('<div class="qfb-message-box qfb-message-box-'+(i=i||"info")+'">').append(b('<div class="qfb-message-box-inner">').text(e));return t&&n.addClass(t),n},getValue:function(e,i){return v.getProperty(e,i,v.getProperty(q.defaultIntegrationConfig,i))}};return e.zapier=e.zapier||{},e.zapier.edit=h,e}(quform,jQuery,quformZapierIntegrationsEditL10n,quformCoreL10n);