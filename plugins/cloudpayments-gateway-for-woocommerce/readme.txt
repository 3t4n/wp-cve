=== CloudPayments Gateway for WooCommerce ===
Author URI: https://cloudpayments.ru/
Contributors: cpsupport
Tags: woocommerce, payment, payments, cloudpayments
Requires at least: 4.9.7
Tested up to: 6.1
Stable tag: 3.1.0
Requires PHP: 5.2.4
License: GPLv2 or later
License URI: https://www.gnu.org/licenses/gpl-2.0.html

Это официальный модуль Cloudpayments, который позволит добавить на ваш магазин woocommerce оплату банковскими картами через платежный сервис [CloudPayments](https://cloudpayments.ru/). Модуль вызывает виджет с адреса https://widget.cloudpayments.ru/bundles/cloudpayments для ввода карточных данных в момент оплаты сформированного заказа. CloudPayments — [сертифицированный](https://cloudpayments.ru/storage/Ttp6LK6sGjrG05WH27MNjLrwGZoxMi06DlV8XL4f.jpeg) сервис провайдер с максимальным уровнем соответствия PCI DSS. Подтверждение соответствия проходит каждый год в рамках сертификационного аудита.


== Description ==

## Возможности:
* Одностадийная схема оплаты;
* Двухстадийная схема;
* Оплата в 1 клик;
* Информирование о статусе платежа;
* Выбор языка виджета;
* Выбор дизайна виджета;
* Выбор валюты виджета
* Выбор способа доставки для платежа
* Возможность указать назначение платежа;
* Поддержка WooCommerce Subscriptions;
* Поддержка онлайн-касс (ФЗ-54);
* Отправка чеков по email;
* Отправка чеков по SMS;
* Теги способа и предмета расчета; 
* Отдельный параметр НДС для доставки.

## Совместимость:

WordPress 4.9.7 и выше;  
WooCommerce 3.4.4 и выше.

== Installation ==

## Установка

1. Скопируйте папку `cloudpayments_gateway_for_woocommerce` в директорию `wp-content/plugins/` на вашем сервере или установите плагин напрямую через раздел плагинов WordPress.

2. Зайдите в "Управление сайтом" -> "Плагины". Активируйте плагин "CloudPayments Gateway for WooCommerce".

3. В управлении сайтом зайдите в "WooCommerce" -> "Настройки" -> "Оплата" -> "CloudPayments". Отметьте галочкой  "Enable CloudPayments".
![CPsettings](pics/settings.png)

* **Включить/Выключить** - Включение/Отключение платежной системы;  
* **Включить DMS** - Включение двухстадийной схемы оплата платежа (холдирование);
* **Текст оплаты заказа** - Можете настроить текст назначения платежа;  
* **Статус для оплаченного заказа** - **Обработка** (Если не предусматривается другой функционал);  
* **Статус для отмененного заказа** - **Отменен** (Если не предусматривается другой функционал);  
* **Статус авторизованного платежа DMS** - **На удержании** (Или **Платеж авторизован**, если предусматривается другой функционал);
* **Наименование** - Заголовок, который видит пользователь в процессе оформления заказа;  
* **Описание** - Описание метода оплаты;  
* **Public_id** - Public id сайта из личного кабинета CloudPayments;  
* **Password for API** - API Secret из личного кабинета CloudPayments;  
* **Валюта магазина** - Можно выбрать либо валюту магазина, либо конкретное значение, которое будет передаваться в платеж;  
* **Дизайн виджета** - Выбор дизайна виджета из 3 возможных (classic, modern, mini);
* **Язык виджета** - Русский МСК (Если не предусматривается использовать другие языки); 
* **Включено для способов доставки** - Выбор способа доставки, для которого возможен платеж**.

Использовать функционал онлайн касс:
* **Включить/выключить** - Включение/отключение формирования онлайн-чека при оплате;
* **ИНН** - ИНН вашей организации или ИП;
* **Ставка НДС** - Укажите ставку НДС товаров;
* **Ставка НДС для доставки** - Укажите ставку НДС службы доставки;
* **Система налогообложения организации** - Тип системы налогообложения;
* **Способ расчета** - признак способа расчета;
* **Предмет расчета** - признак предмета расчета;
* **Статус которым пробивать 2ой чек при отгрузке товара или выполнении услуги** - **Выполнен** (Или **Доставлен**, если предусматривается другой функционал);
* **Действие со штрих-кодом** - отправление артикула товара в чек как штрих-код.
_Согласно ФЗ-54 владельцы онлайн-касс должны формировать чеки для зачета и предоплаты. Отправка второго чека возможна только при следующих способах расчета: Предоплата, Предоплата 100%, Аванс._  

Нажмите "Сохранить изменения".

В личном кабинете CloudPayments зайдите в настройки сайта, пропишите в настройках уведомления, как описано на странице настройки модуля на указанный адрес:
![webHooks](pics/Webhook.png)

Вы готовы принимать платежи с банковских карт с помощью CloudPayments!

== Frequently Asked Questions ==

= Какой порядок подключения? =

Для подключения к системе приема платежей CloudPayments, необходимо выполнить следующие действия:
* Оставить заявку.
* Получить ответ от персонального менеджера. Он будет сопровождать на всех этапах.
* Ознакомиться с преимуществами работы и списком необходимых документов.
* Получить доступ в личный кабинет. Он необходим для подписания договора и дальнейшей работы со всеми инструментариями CloudPayments.
* Выполнить техническую интеграцию сайта.
* Провести тестовые платежи. После успешных тестов — сообщить об этом менеджеру, который переведет сайт в боевой режим. 
* Принимайте онлайн-платежи на сайте с помощью банковских карт, а также в один клик
 
= Как получить URL адрес с копией отправленного онлайн-чека в админ панели магазина? =

Для получения URL адреса копии отправленного онлайн-чека в комментариях к заказу необходимо прописать в личном кабинете CloudPayments адрес для уведомления. Для этого зайдите в настройки сайта, пропишите в настройках адрес: 

* **Receipt Уведомление** (Уведомление об онлайн-чеке):\
http://domain.ru/wordpress/wc-api/wc_cloudpayments_gateway?action=receipt

Где domain.ru — доменное имя вашего сайта.

Для некоторых товаров есть требование поставлять названия товаров в чеках на русском языке. Для этого добавлены несколько фильтров:

* Формирование данных заказа во время оплаты  
    * cloudpayments_process_payment_shipping_data  
    * cloudpayments_process_payment_order_item  
* Формирование данных заказа на при смене статуса заказа  
    * cloudpayments_send_receipt_item  
    * cloudpayments_send_receipt_shipping_data  
    * cloudpayments_send_receipt_data
* Формирование данных заказа при запланированном платеже  
    * cloudpayments_scheduled_subscription_payment_shipping_data  
    * cloudpayments_scheduled_subscription_payment_order_item  


= Обновление для токенов =

Если у вас ранее была установлена Beta версия плагина, которая использовала токены, то для дальнейшего использования сохраненных токенов в новом плагине необходимо поправить значения в базе магазина: заменить в таблице 'wp_woocommerce_payment_tokens' в поле 'gateway_id' значение c 'cpgwwc' на 'wc_cloudpayments_gateway'.

= Обновление адресов уведомлений =

Если ранее пользовались предыдущими версиями модуля, то необходимо обновить адреса уведомлений в лк Cloudpayments. Новые можно увидеть в настройках метода оплаты

== Screenshots ==

1. Настройки модуля settings.png
2. Адреса уведомлений Webhook.png

== Upgrade Notice ==

= 3.1.0 =
* Добавлено поле TrInitiatorCode, обновлены функции под актуальный WC API

= 3.0.9 =
* Исправлен баг с передачей данных для онлайн-чека при оплате по сохраненной карте

= 3.0.8 =
* Обновление документации

= 3.0.7 =
* Минорное исправления

= 3.0.6 =
* Добавлен выбор валюты виджета
* Добавлены дополнительные параметры фискализации - [подробнее](https://static.cloudpayments.ru/docs/uz/CP_WooCommerce_UZ.pdf)

= 3.0.5 =
* Минорное исправления

= 3.0.4 =
* Минорное исправления
* Поправлен скрипт отображения уведомлений в настройках способа оплаты
* Добавлена поддержка мультивалютности
* Добавлена возможность выбора способов доставки, для которого будет работать способ оплаты
* Добавлена передача ID транзакции в Примечания заказа

= 3.0.3 =
* Минорное исправления
* Добавлен дизайн инструкции по настройке данных в ЛК, добавили кнопку копирования URL уведомления в буфер обмена
* Добавлены несколько фильтров

= 3.0.2 =
* Минорное исправления
* Поправлен редирект при неуспешной оплате.

= 3.0.1 =
* Минорное исправления
* Поправлен скрипт сохранения токена карты.

= 3.0 =
* Код плагина переписан в соответствии со стандартами WP;
* Добавлена оплата в 1 клик с помощью токенов;
* Поддержка WooCommerce Subscriptions;
* Обновлены адреса уведомлений.

= 2.0 =
* Добавлены теги способов и предметов расчета;
* Добавлен обработчик receipt уведомлений.

== Changelog ==

= 3.1.0 =
* Добавлено поле TrInitiatorCode, обновлены функции под актуальный WC API

= 3.0.9 =
* Исправлен баг с передачей данных для онлайн-чека при оплате по сохраненной карте

= 3.0.8 =
* Обновление документации

= 3.0.7 =
* Минорное исправления

= 3.0.6 =
* Добавлен выбор валюты виджета
* Добавлены дополнительные параметры фискализации - [подробнее](https://static.cloudpayments.ru/docs/uz/CP_WooCommerce_UZ.pdf)

= 3.0.5 =
* Минорные исправления

= 3.0.4 =
* Добавлена поддержка мультивалютности. (выбор конкретной валюты платежа или валюты магазина).
* Добавлен выбор способа доставки, для которого будет включен способ оплаты
* Добавлена передача ID транзакции в Примечание заказа

= 3.0.3 =
* Добавлены фильтры
* Добавлен дизайн инструкции по настройке данных в ЛК
* Поправлено окно выбора карты для оплаты.

= 3.0.2 =
* Поправлен редирект при неуспешной оплате.

= 3.0.1 =
* Поправлен скрипт сохранения токена карты.

= 3.0 =
* Возвращение плагина в маркетплейс;
* Код плагина переписан в соответствии со стандартами WP;
* Добавлена оплата в 1 клик с помощью токенов;
* Обновлены адреса уведомлений;
* Поддержка WooCommerce Subscriptions.

= 2.2.4 =
* минорные исправления

= 2.2.3 =
* минорные исправления

= 2.2.2 =
* Устранена ошибка fail уведомления.

= 2.2.1 =
* Устранены незначительные ошибки.

= 2.1 =
* Устранены некоторые ошибки в описании.

= 2.0 =
* Добавлен новый функционал.

= 1.0 =
* Размещение плагина в маркетплейс.

== Changelog == 
