jQuery(document).ready((function(e){"use strict";let t=e(".emtmpl-email-preview-content");if(ViWec.Builder.init(),e(".emtmpl-show-sub-actions").on("click",(function(){e(".emtmpl-actions-back").slideToggle()})),e(".emtmpl-order-id-test").on("change",(function(){viWecChange=!0})),viWecShortcodeListValue){let t,l=e("#title[name=post_title]"),a=e(".emtmpl-subject-quick-shortcode");l.on("focusout",(function(){t=this.selectionStart})),a.append("<ul>"+viWecShortcodeListValue+"</ul>"),a.on("click",".dashicons-menu",(function(){a.find("ul").toggle("fast")})),a.on("click","li",(function(){let i,o=l.val(),n=e(this).text();if(t){i=o.substr(0,t)+n+o.substr(t+1)}else i=o+n;l.val(i).focus(),e("#title-prompt-text").addClass("screen-reader-text"),a.find("ul").toggle("fast")}))}const l=e=>{var t="";if(e)try{t=decodeURIComponent(atob(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))}catch(t){return e}return t},a=e=>(["padding-left","padding-right","padding-top","padding-bottom"].includes(e)&&(e="padding"),["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius"].includes(e)&&(e="border-radius"),e),i=e=>{if(e){let t=/rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?\)/i,l=e.match(t);if(l){let a=viWecRgb2hex(l[0]);e=e.replace(t,a)}let a=/rgba?[\s+]?\([\s+]?(0)[\s+]?,[\s+]?(0)[\s+]?,[\s+]?(0)[\s+]?,[\s+]?(0)[\s+]?\)/i;return e.match(a)&&(e="transparent"),e=e.replace(/"/gi,"")}return""},o=(e,t)=>{let l=ViWec.Components._components[t],o=l?l.properties:"",n={};if(o){for(let t in o)if(o[t].htmlAttr){let l,s=a(o[t].key),m=e.get(0);m.style&&m.style.length>0&&m.style[s]?l=m.style[s]:m.currentStyle?l=m.currentStyle[s]:window.getComputedStyle&&(l=document.defaultView.getDefaultComputedStyle?document.defaultView.getDefaultComputedStyle(m,null).getPropertyValue(s):window.getComputedStyle(m,null).getPropertyValue(s)),l&&(n[s]=i(l))}n.width=e.css("width")}return n},n=()=>{let t={},l=e("#emtmpl-email-editor-wrapper");return t.style_container={"background-color":i(l.css("background-color")),"background-image":l.css("background-image")},t.rows={},e(viWecEditorArea).find(".emtmpl-layout-row").each((function(l,n){let s=e(n).attr("data-type"),m=e(n).attr("data-cols"),r=o(e(n),s);t.rows[l]={props:{style_outer:r,type:s,dataCols:m},cols:{}};let c=e(n).find(".emtmpl-column-sortable");c.length&&c.each((function(n,s){let m=o(e(s),"layout/grid1cols");t.rows[l].cols[n]={props:{style:m},elements:{}};let r=e(s).find(".emtmpl-element");r.length&&r.each((function(o,s){let m=e(s).data("type");t.rows[l].cols[n].elements[o]=((t,l)=>{let o=ViWec.Components._components[l].properties,n={},s={},m={},r={};r.width=e(t).css("width");for(let l in o)if(o[l].htmlAttr){let d=o[l].target?e(t).find(o[l].target):e(t),p=a(o[l].key);switch(o[l].htmlAttr){case"innerHTML":n[p]=(c=d.html(),btoa(encodeURIComponent(c).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)}))));break;case"style":let e;e=ViWec.StyleManager.getStyle(d,o[l],p),e&&(r[p]=i(e));break;case"childStyle":m[o[l].target]||(m[o[l].target]={});let t=ViWec.StyleManager.getStyle(d,o[l],p);t&&(m[o[l].target][p]=i(t));break;default:let a=d.attr(o[l].htmlAttr),u=o[l].default?o[l].default:"";a=a||u,s[p]=a}}var c;return{type:l,style:r,content:n,attrs:s,childStyle:m}})(s,m)}))}))})),JSON.stringify(t)};if(e("#save-post").on("click",(function(){e("input[name=post_status]").val("draft")})),e("form").on("submit",(function(t){e(window).unbind("beforeunload");let l=n();return e("<input/>").attr({type:"hidden",name:"emtmpl_email_structure",value:l}).appendTo("form#post"),!0})),e(".emtmpl-preview-email-btn").on("click",(function l(){let a={action:"emtmpl_preview_template",nonce:viWecParams.nonce,data:n(),order_id:e(".emtmpl-order-id-test").val(),custom_css:e("#emtmpl-custom-css textarea").val(),direction:e(".emtmpl-settings-direction").val()},i=e(this),o=e(".vi-ui.modal");!1===viWecChange?(o.modal("show"),i.hasClass("mobile")&&t.addClass("emtmpl-mobile-preview"),i.hasClass("desktop")&&t.removeClass("emtmpl-mobile-preview")):e.ajax({url:viWecParams.ajaxUrl,type:"post",dataType:"html",data:a,beforeSend:function(){i.addClass("loading").unbind()},success:function(t){t&&(o.find(".emtmpl-email-preview-content").html(t),o.modal("show"),e(".emtmpl-email-preview-content a").on("click",(function(e){e.preventDefault(),e.stopImmediatePropagation()})))},error:function(e){console.log(e)},complete:function(){i.removeClass("loading"),i.bind("click",l),viWecChange=!1,i.hasClass("mobile")&&t.addClass("emtmpl-mobile-preview"),i.hasClass("desktop")&&t.removeClass("emtmpl-mobile-preview")}})})),e(".emtmpl-send-test-email-btn").on("click",(function t(){let l=e(".emtmpl-send-test-email-btn"),a=e(".emtmpl-to-email").val();if(!a)return alert("Please input your email"),void e(".vi-ui.modal").modal("hide");let i={action:"emtmpl_send_test_email",nonce:viWecParams.nonce,data:n(),order_id:e(".emtmpl-order-id-test").val(),email:a,custom_css:e("#emtmpl-custom-css textarea").val(),direction:e(".emtmpl-settings-direction").val()};e.ajax({url:viWecParams.ajaxUrl,type:"post",dataType:"json",data:i,beforeSend:function(){l.addClass("loading").unbind()},success:function(e){let t=e.success?"#00DA00":"red";viWecNoticeBox(e.data,t)},complete:function(){l.removeClass("loading").bind("click",t),e(".vi-ui.modal").modal("hide")}})})),e(".emtmpl-mobile-view").on("click",(function(){t.addClass("emtmpl-mobile-preview")})),e(".emtmpl-pc-view").on("click",(function(){t.removeClass("emtmpl-mobile-preview")})),ViWec.viWecDrawTemplate=t=>{if(t){e(viWecEditorArea).empty(),e("#emtmpl-email-editor-wrapper").css(t.style_container);for(let a in t.rows){if(e.isEmptyObject(t.rows[a].cols))continue;let i=e(viWecTmpl("emtmpl-block",{type:t.rows[a].props.type,colsQty:t.rows[a].props.dataCols}));i.find(".emtmpl-layout-row").css(t.rows[a].props.style_outer),i.find(".emtmpl-column").each((function(o){let n=e(this);e.isEmptyObject(t.rows[a].cols[o].elements)||n.removeClass("emtmpl-column-placeholder"),n.find(".emtmpl-column-sortable").css(t.rows[a].cols[o].props.style);for(let i in t.rows[a].cols[o].elements){let s=t.rows[a].cols[o].elements[i],m=s.type,r=s.style,c=s.content,d=0!==s.attrs.length?s.attrs:{},p=s.childStyle,u=ViWec.Components._components[m];if(void 0===u)continue;let h=u.properties,f=e(`<div class="emtmpl-element" data-type="${m}"></div>`).append(u.html);for(let e in h)if(h[e].htmlAttr&&!1!==h[e].visible){let t=h[e].target?f.find(h[e].target):f;switch(h[e].htmlAttr){case"innerHTML":let a=l(c[h[e].key]);if(h[e].renderShortcode){let e=t.clone();e=e.removeClass().html(ViWec.viWecReplaceShortcode(a)).addClass("emtmpl-text-view"),t.html(a).hide(),t.after(e)}else t.html(a);"function"==typeof h[e].onChange&&h[e].onChange(t,a);break;case"style":r&&t.css(r);break;case"childStyle":p[h[e].target]&&t.css(p[h[e].target]);break;default:if(t.attr(h[e].htmlAttr,d[h[e].key]),"function"==typeof h[e].onChange){let l=ViWec.viWecReplaceShortcode(d[h[e].key]);h[e].onChange(t,d[h[e].key],l)}}}f.handleElement(),n.find(".emtmpl-column-sortable").append(f)}n.handleColumn(),n.find(".emtmpl-column-sortable").columnSortAble(),i.find(".emtmpl-flex").append(n)})),i.handleRow(),i.appendTo(viWecEditorArea)}}},"undefined"!=typeof viWecLoadTemplate){let e=JSON.parse(viWecLoadTemplate);ViWec.viWecDrawTemplate(e)}e(".emtmpl-export-data").on("click",(function(){let t=n(),l=new RegExp(viWecParams.siteUrl,"g");t=t.replace(l,"{_site_url}"),e("#emtmpl-exim-data").val(t)})),e(".emtmpl-import-data").on("click",(function(){let t=e("#emtmpl-exim-data").val();t=t.replace(/{_site_url}/g,viWecParams.siteUrl),t&&ViWec.viWecDrawTemplate(JSON.parse(t))})),e(".emtmpl-copy-data").on("click",(function(){e("#emtmpl-exim-data").select(),document.execCommand("copy")})),e("#emtmpl-element-search input.emtmpl-search").on("keyup",(function(){let t=e(this).val().toUpperCase(),l=e("#emtmpl-components-list li");for(let a=0;a<l.length;a++){e(l[a]).find(".emtmpl-ctrl-title").text().toUpperCase().indexOf(t)>-1?e(l[a]).show():e(l[a]).hide()}}));const s={init(){let t=e(".emtmpl-set-email-type");this.setupPage(),this.setupPreviewModal(),this.emailTypeChange(),this.hideRules(t.val()),this.hideElements(t.val()),this.addNewTemplate(),this.direction()},setupPage(){e(window).bind("beforeunload"),e(document).width()<=1400&&e("body").addClass("folded"),e(".hndle").removeClass("hndle"),e("form").bind("keypress",(function(e){13===e.keyCode&&(e.preventDefault(),e.stopImmediatePropagation())})),e(document).on("click",(function(t){e(t.target).is(".emtmpl-quick-shortcode-list")||e(t.target).is(".dashicons.dashicons-menu")||(e(".emtmpl-quick-shortcode-list").hide(),e(".emtmpl-subject-quick-shortcode ul").hide())})),e(".emtmpl-select2").select2({placeholder:e(this).attr("data-placeholder")}),e("#emtmpl-control-panel .menu .item").tab(),e(".emtmpl-toggle-admin-bar").on("click",(function(){e(this).toggleClass("dashicons-arrow-left dashicons-arrow-right",1e3),e("body.wp-admin").toggleClass("emtmpl-admin-bar-hidden",1e3),e.ajax({url:ajaxurl,type:"post",dataType:"json",data:{action:"emtmpl_change_admin_bar_stt"}})})),e(".emtmpl-quick-add-layout-btn").on("click",(function(){e(".emtmpl-layout-list").toggle()}))},setupPreviewModal(){e("body").on("click",".emtmpl-email-preview a, #emtmpl-email-editor-wrapper a",(function(e){e.preventDefault(),e.stopImmediatePropagation()}))},addNewTemplate(){if(void 0!==viWecParams.addNew){let t=viWecParams.addNew.type||"",l=viWecParams.addNew.style||"";t&&l&&viWecFunctions.doChangeSampleTemplate(t,l),e(".emtmpl-samples-type").val(t).trigger("change"),e(".emtmpl-samples-style").val(l).trigger("change"),delete viWecParams.addNew}},emailTypeChange(){e(".emtmpl-set-email-type").on("change",(function(){let t=e(this).val();s.hideRules(t),s.hideElements(t)}))},hideRules(e){},hideElements(t){let l=(viWecParams.accept_elements||"")[t]||"";if(l){e("#emtmpl-components-list .emtmpl-control-btn").parent().addClass("emtmpl-hidden");for(let t of l)e(`#emtmpl-components-list .emtmpl-control-btn[data-type='${t}']`).parent().removeClass("emtmpl-hidden")}else e("#emtmpl-components-list .emtmpl-control-btn").parent().removeClass("emtmpl-hidden")},direction(){e(".emtmpl-settings-direction").on("change",(function(){let t=e(this).val(),l=e("#emtmpl-email-editor-content");l.removeClass("emtmpl-direction-rtl emtmpl-direction-ltr"),l.addClass("emtmpl-direction-"+t)}))}};s.init()}));