function UpdraftCentral_PrevNext_Paginator(e,t,r){var a=this,n=r,i="",l=t.last_marker;function p(){a.element.trigger("page_change",i,l),"function"==typeof n&&n(i,l)}t.is_paged&&(0<t.prev_key.length||0<t.next_key.length)&&(r=e,a.element=jQuery(UpdraftCentral.template_replace("updraftvault-prevnext-paginator",{})),0==t.prev_key.length&&(a.element.find("a.page_prev").parent("li").hide(),a.element.find('li:contains("|")').hide()),0==t.next_key.length&&(a.element.find("a.page_next").parent("li").hide(),a.element.find('li:contains("|")').hide()),a.element.appendTo(r),a.element.on("click","a",function(e){e.preventDefault(),jQuery(this).hasClass("page_prev")?(markers=l.split(","),i=markers[markers.length-1],l=l.replace(","+i,""),p()):jQuery(this).hasClass("page_next")&&(i=t.next_key,l+=","+t.prev_key,p())})),this.page_change=function(e){n=e}}function UpdraftCentral_UpdraftVault_Management(){var o,n,i,l=this;function p(r,e){var t,a=r.find(".updraftcentral_updraftvault_paginator");0===a.length?(t=r.find(".updraftcentral_row_extracontents"),a=jQuery('<div class="updraftcentral_updraftvault_paginator"></div>').appendTo(t)):a.empty(),new UpdraftCentral_PrevNext_Paginator(a,e).page_change(function(e,t){e={bucket:n,prefix:i,marker_key:e,last_marker:t,per_page:r.find(".updraftcentral_updraftvault_header .per_page").val()};l.browse_files(r,e).then(function(e){void 0!==e.paging&&p(r,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})})}function s(e){UpdraftCentral.set_loading(e.container),void 0!==e.aws_request&&e.container.before('<div class="updraftcentral_spinner"></div>')}function d(e){var t=jQuery.Deferred();return UpdraftCentral.done_loading(e.container,e.html).then(function(){void 0!==e.aws_request&&e.container.parent().children(".updraftcentral_spinner").remove(),t.resolve()}),t.promise()}function u(e){var t,r;return"string"!=typeof e&&e&&e.hasOwnProperty("values")&&(t=e.values,e=e.message),void 0===e&&console.log("UpdraftCentral: The 'translate_message' requires an object with the properties 'message' and 'values' if there's a variable"),!1===e?"":void 0===(r=udclion.updraftvault[e])?(UpdraftCentral_Library.dialog.alert("<h2>"+udclion.error+"</h2><p>"+sprintf(udclion.updraftvault.translation_not_found_for,e)+"</p>"),null):void 0===t?r:sprintf(r,t)}jQuery("#updraftcentral_dashboard_existingsites").on("updraftcentral_dashboard_mode_set_updraftvault",function(){UpdraftCentral.register_updraftplus_install_activate_handlers("button.updraftcentral_site_browse_files"),UpdraftCentral.register_row_clicker('.updraftcentral_updraftvault_table input[name="uc_updraftvault_check_all"]',function(e){var t=!1;jQuery(this).is(":checked")&&(t=!0),e.find(".updraftcentral_updraftvault_table input.check_item").each(function(){jQuery(this).prop("checked",t)})},!0,"change"),UpdraftCentral.register_row_clicker("select.per_page",function(t){if(t.find(".updraftcentral_updraftvault_rows.no-matched").is(":visible"))return!1;var e={bucket:n,prefix:i,per_page:t.find(".updraftcentral_updraftvault_header .per_page").val()};l.browse_files(t,e).then(function(e){void 0!==e.paging&&p(t,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})},!0,"change"),UpdraftCentral.register_row_clicker(".updraftcentral_site_updraftvault_action_btn",function(t){if(t.find(".updraftcentral_updraftvault_rows.no-matched").is(":visible"))return!1;var r;"delete"===jQuery(this).data("action")&&(r={bucket:n,prefix:i,files:[]},t.find(".updraftcentral_updraftvault_table input.check_item:checked").each(function(){r.files.push(jQuery(this).data("key"))}),0<r.files.length?UpdraftCentral_Library.dialog.confirm("<h2>"+u("delete_files")+"</h2><p>"+u("delete_files_confirm")+"</p>",function(e){e&&l.delete_files(t,r)}):UpdraftCentral_Library.dialog.alert("<h2>"+u("empty_selection_header")+"</h2><p>"+u("select_files")+"</p>"))},!0),UpdraftCentral.register_row_clicker(".updraftcentral_site_browse_files",function(r){l.get_updraftvault_credentials(r).then(function(e){var t=function(e,t){var r={bucket:"",prefix:"",region:""};{var a;void 0!==e&&(a=e.split("/")).length&&(r.bucket=a[0],r.region=r.bucket.replace(t+"-",""),1<a.length)&&(r.prefix=e.replace(r.bucket+"/","")+"/")}return r}(e.path,e.key),e=(AWS.config.update({accessKeyId:e.accesskey,secretAccessKey:e.secretkey,sessionToken:e.sessiontoken}),AWS.config.region=t.region,o=new AWS.S3,n=t.bucket,i=t.prefix,{bucket:t.bucket,prefix:t.prefix,per_page:10,marker_key:"",last_marker:""});l.get_updraftvault_filters(r),l.browse_files(r,e).then(function(e){void 0!==e.paging&&p(r,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker})})})},!0)}),this.browse_files=function(e,t){var r=jQuery.Deferred(),e=e.find(".updraftcentral_row_extracontents"),a=e.find(".updraftcentral_updraftvault_rows"),n={container:a=0===a.length?jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(e):a,html:"",aws_request:!0};return s(n),function(f){var _=jQuery.Deferred();void 0===f.per_page&&(f.per_page=10);void 0===f.marker_key&&(f.marker_key="");void 0===f.last_marker&&(f.last_marker="");var e={Bucket:f.bucket,Delimiter:"/",Marker:f.marker_key,MaxKeys:f.per_page,Prefix:f.prefix};return o.listObjects(e,function(e,t){if(e)_.reject({error:!0,message:"general_error_response",values:[e.stack]});else{for(var r,a,n,i,e=f.marker_key,l="",p=!0,s=[],d=t.Contents,u=0;u<d.length;u++)a=(r=d[u].Key).replace(f.prefix,""),n=function(e,t){if(0===e)return"0 Bytes";var t=t||3,r=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,r)).toFixed(t))+" "+["Bytes","KB","MB","GB","TB"][r]}(d[u].Size,2),i={Bucket:f.bucket,Key:r},f.prefix!==r&&s.push({key:r,file_name:a,size:n,download_link:o.getSignedUrl("getObject",i)});s.length&&(t.IsTruncated?l=t.NextMarker:0===e.length&&(p=!1)),e={prev_key:e,next_key:l,is_paged:p,last_marker:f.last_marker},s.length?_.resolve({files:s,data:t,paging:e}):_.resolve({error:!1,message:"files_not_found",values:[]})}}),_.promise()}(t).then(function(e){n.html=UpdraftCentral.template_replace("updraftvault-updraftvault-row",e),void 0!==e.message&&(n.html=u(e)),n.response=e}).fail(function(e){UpdraftCentral_Library.dialog.alert("<h2>"+u("browse_failed_header")+"</h2><p>"+u(e)+"</p>"),n.response=e}).always(function(e){void 0===e&&(e=n.response),d(n).then(function(){void 0!==e.files?Array.isArray(e.files)&&jQuery(".updraftcentral_updraftvault_rows").removeClass("no-matched"):void 0!==e.message&&"files_not_found"===e.message&&jQuery(".updraftcentral_updraftvault_rows").addClass("no-matched"),r.resolve(e)})}),r.promise()},this.delete_files=function(r,a){var e=r.find(".updraftcentral_row_extracontents"),t=e.find(".updraftcentral_updraftvault_rows"),n={container:t=0===t.length?jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(e):t,html:"",aws_request:!0};s(n),function(e){var r=jQuery.Deferred();files=[];for(var t=0;t<e.files.length;t++)key=e.files[t],files.push({Key:key});var a={Bucket:e.bucket,Delete:{Objects:files}};return o.deleteObjects(a,function(e,t){e?r.reject({error:!0,message:"delete_error",values:[e.stack]}):r.resolve({error:!1,message:"delete_success",values:[]})}),r.promise()}(a).then(function(e){var t=e;l.browse_files(r,a).then(function(e){void 0!==e.paging&&p(r,{prev_key:e.paging.prev_key,next_key:e.paging.next_key,is_paged:e.paging.is_paged,last_marker:e.paging.last_marker}),UpdraftCentral_Library.dialog.alert("<h2>"+u("delete_success_header")+"</h2><p>"+u(t)+"</p>")})}).fail(function(e){UpdraftCentral_Library.dialog.alert("<h2>"+u("delete_failed_header")+"</h2><p>"+u(e)+"</p>"),d(n)})},this.get_updraftvault_filters=function(e){var t=jQuery.Deferred(),e=e.find(".updraftcentral_row_extracontents"),r=e.find(".updraftcentral_updraftvault_filters"),e={container:r=0===r.length?jQuery('<div class="updraftcentral_updraftvault_filters"></div>').prependTo(e):r,html:""};s(e);return e.html=UpdraftCentral.template_replace("updraftvault-updraftvault-filter",{paging:{per_page_options:[10,20,50,100,500,1e3]}}),d(e).then(function(){t.resolve()}),t.promise()},this.get_updraftvault_credentials=function(e){var r=jQuery.Deferred(),t=e.find(".updraftcentral_row_extracontents"),a=t.find(".updraftcentral_updraftvault_rows"),n={container:a=0===a.length?jQuery('<div class="updraftcentral_updraftvault_rows"></div>').appendTo(t):a,html:""};return s(n),UpdraftCentral.send_site_rpc("updraftvault.get_credentials",null,e,function(e,t){"ok"!==t||e.data.error?(e.hasOwnProperty("data")&&e.data&&UpdraftCentral_Library.dialog.alert("<h2>"+u("connection_error_header")+"</h2><p>"+u(e.data)+"</p>"),d(n),r.reject()):(n.html=UpdraftCentral.template_replace("updraftvault-updraftvault-row",e.data),d(n).then(function(){r.resolve(e.data)}))}),r.promise()}}jQuery(function(){new UpdraftCentral_UpdraftVault_Management});