!function(d){window.llms=window.llms||{};window.llms.analytics=new function(t){if(d("#llms-analytics-json").length)return this.charts_loaded=!1,this.data={},this.query=d.parseJSON(d("#llms-analytics-json").text()),this.timeout=8e3,this.options=t,this.$widgets=d(".llms-widget[data-method]"),this.init=function(){google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(this.charts_ready),this.bind(),this.load_widgets()},this.bind=function(){d(".llms-datepicker").length&&d.fn.datepicker&&d(".llms-datepicker").datepicker({dateFormat:"yy-mm-dd",maxDate:0}),d("#llms-students-ids-filter").llmsStudentsSelect2({multiple:!0,placeholder:LLMS.l10n.translate("Filter by Student(s)"),allow_clear:!0}),d('a[href="#llms-toggle-filters"]').on("click",function(t){t.preventDefault(),d(".llms-analytics-filters").slideToggle(100)}),d("#llms-custom-date-submit").on("click",function(){d('input[name="range"]').val("custom")}),d("#llms-date-quick-filters a.llms-nav-link[data-range]").on("click",function(t){t.preventDefault(),d('input[name="range"]').val(d(this).attr("data-range")),d("form.llms-reporting-nav").submit()})},this.charts_ready=function(){window.llms.analytics.charts_loaded=!0,window.llms.analytics.draw_chart()},this.draw_chart=function(){var t,a,e;this.charts_loaded&&this.is_loading_finished()&&((t=document.getElementById("llms-charts-wrapper"))&&(t=new google.visualization.ComboChart(t),a=this.get_chart_data(),e={legend:"top",chartArea:{height:"75%",width:"85%"},colors:["#606C38","#E85D75","#EF8354","#C64191","#731963"],height:560,lineWidth:4,seriesType:"bars",series:this.get_chart_series_options(),vAxes:{0:{format:this.options.currency_format||"currency"},1:{format:""}}},a.length&&((a=google.visualization.arrayToDataTable(a)).sort([{column:0}]),t.draw(a,e))))},this.is_loading_finished=function(){return!d(".llms-widget.is-loading").length},this.load_widgets=function(){var t=this;this.$widgets.each(function(){t.load_widget(d(this))})},this.load_widget=function(a){var e,s=this,i=a.attr("data-method"),r=a.find(".llms-widget-content"),n=a.find(".llms-reload-widget"),l=LLMS.l10n.translate("Error");a.addClass("is-loading"),d.ajax({data:{action:"llms_widget_"+i,dates:s.query.dates,courses:s.query.current_courses,memberships:s.query.current_memberships,students:s.query.current_students,_ajax_nonce:window.llms.ajax_nonce},method:"POST",timeout:s.timeout,url:window.ajaxurl,success:function(t){e="success",void 0!==t.response&&(l=t.response,s.data[i]={chart_data:t.chart_data,response:t.response,results:t.results},n.remove())},error:function(t){e="error"},complete:function(t){"error"===e&&(l="timeout"===t.statusText?LLMS.l10n.translate("Request timed out"):LLMS.l10n.translate("Error"),n.length||((n=d('<a class="llms-reload-widget" href="#">'+LLMS.l10n.translate("Retry")+"</a>")).on("click",function(t){t.preventDefault(),s.load_widget(a)}),a.append(n))),a.removeClass("is-loading"),r.html(l),s.widget_finished(a)}})},this.get_date_diff=function(){var t=new Date(this.query.dates.end),a=new Date(this.query.dates.start);return Math.abs(t.getTime()-a.getTime())},this.get_chart_data_object=function(){var t,a,e,s,i=this,r=this.get_date_diff(),n={};for(s in i.data)if(i.data.hasOwnProperty(s)&&"object"==typeof i.data[s].chart_data&&"object"==typeof i.data[s].results&&(t=i.data[s].results))for(a=0;a<t.length;a++)e=this.init_date(t[a].date),n[e=r<=10368e6?new Date(e.getFullYear(),e.getMonth(),e.getDate()):new Date(e.getFullYear(),e.getMonth(),1)]||(n[e]=this.get_empty_data_object(e)),"amount"===i.data[s].chart_data.type?n[e][s]=n[e][s]+ +t[a][i.data[s].chart_data.key]:n[e][s]++;return n},this.get_chart_data=function(){var t,a=this.get_chart_data_object(),e=this.get_chart_headers();for(t in a)if(a.hasOwnProperty(t)){var s,i=[a[t]._date];for(s in a[t])a[t].hasOwnProperty(s)&&0!==s.indexOf("_")&&i.push(a[t][s]);e.push(i)}return e},this.get_empty_data_object=function(t){var a,e=this,s={_date:t};for(a in e.data)e.data.hasOwnProperty(a)&&e.data[a].chart_data&&(s[a]=0);return s},this.get_chart_headers=function(){var t,a=this,e=[];for(t in e.push({label:LLMS.l10n.translate("Date"),id:"date",type:"date"}),a.data)a.data.hasOwnProperty(t)&&a.data[t].chart_data&&e.push(a.data[t].chart_data.header);return[e]},this.get_chart_series_options=function(){var t,a,e=this,s={};for(t in i=0,e.data)e.data.hasOwnProperty(t)&&e.data[t].chart_data&&(a=e.data[t].chart_data.type,s[i]={type:"count"===a?"bars":"line",targetAxisIndex:"count"===a?1:0},i++);return s},this.init_date=function(t){var t=t.split(" "),a=t[0].split("-"),t=t[1].split(":");return new Date(a[0],a[1]-1,a[2],t[0],t[1],t[2])},this.widget_finished=function(t){this.is_loading_finished()&&this.draw_chart()},this.init(),this}(window.llms.analytics||{})}(jQuery);
//# sourceMappingURL=../maps/js/llms-analytics.min.js.map
