"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,i,o){return i&&t(e.prototype,i),o&&t(e,o),e}}();jQuery(function(){var t=function(){function t(){var e=this;_classCallCheck(this,t),this.dialog=jQuery("#insert_math-dialog"),this.checked_class="insert_math-checked",this.display_mode={buttons:this.dialog.find(".insert_math-display-mode-container .insert_math-button"),block_button:this.dialog.find(".insert_math-display-block"),inline_button:this.dialog.find(".insert_math-display-inline")},this.additional_settings={container:this.dialog.find(".insert_math-additional-settings-container"),header:this.dialog.find(".insert_math-additional-settings-header"),body:this.dialog.find(".insert_math-additional-settings")},this.formula_color={buttons:this.dialog.find(".insert_math-color-container .insert_math-button"),default_button:this.dialog.find(".insert_math-color-default"),custom_button:this.dialog.find(".insert_math-color-custom")},this.formula_id=this.dialog.find("#insert_math-formula-id"),this.formula_classes=this.dialog.find("#insert_math-formula-classes"),this.preview={icon:this.dialog.find(".insert_math-preview-icon"),math:this.dialog.find(".insert_math-preview-math"),empty:this.dialog.find(".insert_math-preview-empty")},this.expression=this.dialog.find("#insert_math-expression"),this.insert_button=this.dialog.find(".insert_math-insert"),this.picker_click_call=0,this.color_picker=this.dialog.find(".insert_math-color-container").iris({palettes:["#C02E1D","#F16C20","#EBC844","#A2B86C","#1395BA","#0D3C55"],change:function(t,i){e.formula_color.custom_button.text(i.color.toString()),e.set_custom_formula_color()}}),this.dialog.click(function(t){t.target===e.formula_color.custom_button.get(0)&&e.picker_click_call>1&&(e.color_picker.iris("hide"),e.picker_click_call=0),!jQuery(t.target).closest(".iris-picker").length>0&&t.target!==e.formula_color.custom_button.get(0)&&(e.color_picker.iris("hide"),e.picker_click_call=0)}),this.init_dialog()}return _createClass(t,[{key:"init_dialog",value:function(){var t=this;this.dialog.dialog({autoOpen:!1,resizable:!1,modal:!0,dialogClass:"insert_math-dialog",draggable:!1,width:"auto",height:"auto",open:function(){t.expression.focus(),jQuery(".ui-widget-overlay").bind("click",function(){t.dialog.dialog("close")}).css({background:"#000",opacity:"0.7"})},close:function(){t.clear()}}),jQuery(window).resize(function(){t.center_dialog()}),this.display_mode.block_button.click(function(){t.display_mode.block_button.hasClass(t.checked_class)||(t.display_mode.buttons.removeClass(t.checked_class),t.display_mode.block_button.addClass(t.checked_class),t.render_preview())}),this.display_mode.inline_button.click(function(){t.display_mode.inline_button.hasClass(t.checked_class)||(t.display_mode.buttons.removeClass(t.checked_class),t.display_mode.inline_button.addClass(t.checked_class),t.render_preview())}),this.formula_color.default_button.click(function(){t.formula_color.default_button.hasClass(t.checked_class)||(t.formula_color.buttons.removeClass(t.checked_class),t.formula_color.default_button.addClass(t.checked_class),t.render_preview())}),this.formula_color.custom_button.click(function(){t.formula_color.custom_button.hasClass(t.checked_class)||(t.formula_color.buttons.removeClass(t.checked_class),t.formula_color.custom_button.addClass(t.checked_class)),t.color_picker.find(".iris-picker").css("top",t.color_picker.outerHeight()+5),t.color_picker.iris("show"),t.picker_click_call++}),this.formula_color.custom_button.on("keydown",function(e){13===e.keyCode&&e.preventDefault(),t.formula_color.custom_button.text().length>=7&&8!==e.keyCode&&46!==e.keyCode&&39!==e.keyCode&&37!==e.keyCode&&e.preventDefault()}),this.formula_color.custom_button.on("keyup",function(){t.set_custom_formula_color()}),this.formula_color.custom_button.on("paste",function(e){e.preventDefault();var i=(event.originalEvent||event).clipboardData.getData("text/plain").replace(/<(?:.|\n)*?>/gm,"");i.length>7&&(i=i.slice(0,-(i.length-7))),t.formula_color.custom_button.text(i),t.set_custom_formula_color()}),this.additional_settings.header.click(function(){t.additional_settings.header.toggleClass("_showing"),t.additional_settings.body.toggleClass("_showing").slideToggle(150,function(){t.center_dialog()})});var e=void 0;this.expression.on("input",function(){clearTimeout(e),t.expression.val().trim()?e=setTimeout(function(){t.render_preview()},300):(t.preview.math.hide(),t.preview.empty.show())}),this.insert_button.click(function(){t.insert()}),this.dialog.keypress(function(e){e.keyCode!==jQuery.ui.keyCode.ENTER||jQuery(e.target).hasClass("insert_math-color-custom")||t.insert()})}},{key:"get_display_mode",value:function(){return this.display_mode.block_button.hasClass(this.checked_class)?"block":"inline"}},{key:"get_formula_color",value:function(){return this.formula_color.default_button.hasClass(this.checked_class)?"default":this.formula_color.custom_button.text()}},{key:"render_preview",value:function(){var t=this,e=this.expression.val().trim();if(!e)return this.preview.math.hide(),void this.preview.empty.show();this.preview.icon.addClass("_rendering"),this.preview.empty.hide();var i="";i="block"===this.get_display_mode()?"\\displaystyle":"\\textstyle";var o=this.get_formula_color();"default"===o?this.preview.math.css("color",""):this.preview.math.css("color",o),MathJax.Hub.queue.Push(["Text",MathJax.Hub.getAllJax("insert_math-preview")[0],i+"{"+e+"}"],function(){t.preview.math.show(),t.preview.icon.removeClass("_rendering"),t.center_dialog()})}},{key:"set_custom_formula_color",value:function(){if(this.formula_color.custom_button.addClass("_applying-color"),/^#[0-9a-f]{3}(?:[0-9a-f]{3})?$/i.test(this.formula_color.custom_button.text())){var t=this.formula_color.custom_button.text();this.formula_color.custom_button.css("color",t),this.render_preview()}this.formula_color.custom_button.removeClass("_applying-color")}},{key:"center_dialog",value:function(){this.dialog.dialog("option","position",{my:"center",at:"center",of:window})}},{key:"clear",value:function(){this.dialog.closest(".ui-dialog").find(".ui-dialog-title").text(this.dialog.data("title")),this.display_mode.buttons.removeClass(this.checked_class),this.display_mode.block_button.addClass(this.checked_class),this.formula_color.buttons.removeClass(this.checked_class),this.formula_color.default_button.addClass(this.checked_class),this.formula_color.custom_button.css("color","#333").text("#333333"),this.formula_id.val(""),this.formula_classes.val(""),this.expression.val(""),this.additional_settings.header.removeClass("_showing"),this.additional_settings.body.removeClass("_showing").hide(),this.insert_button.text(this.insert_button.data("value")),this.current_node=null,this.render_preview()}},{key:"edit",value:function(){this.dialog.closest(".ui-dialog").find(".ui-dialog-title").text(this.dialog.data("title-edit")),"p"!==this.current_node.tagName.toLowerCase()&&(this.display_mode.buttons.removeClass(this.checked_class),this.display_mode.inline_button.addClass(this.checked_class)),jQuery(this.current_node).hasClass("inherit-color")||(this.formula_color.buttons.removeClass(this.checked_class),this.formula_color.custom_button.addClass(this.checked_class).css("color",t.rgb_to_hex(jQuery(this.current_node).css("color"))).text(t.rgb_to_hex(jQuery(this.current_node).css("color")))),this.formula_id.val(void 0===jQuery(this.current_node).attr("id")?"":jQuery(this.current_node).attr("id").trim()),this.formula_classes.val(void 0===jQuery(this.current_node).attr("class")?"":jQuery(this.current_node).attr("class").replace("math","").replace("inherit-color","").replace("_focus","").trim()),this.expression.val(jQuery(this.current_node).text().replace("\\[ ","").replace(" \\]","").replace("\\( ","").replace(" \\)","")),this.insert_button.text(this.insert_button.data("value-edit")),this.render_preview(),this.dialog.dialog("open")}},{key:"insert",value:function(){var e=this.expression.val().trim(),i=void 0;if(e){var o=this.formula_id.val().trim();o&&(o='id="'+o+'"');var s=this.formula_classes.val().trim(),a=this.get_formula_color();"default"===a?s="inherit-color "+s:a='style="color: '+a+';"',"block"===this.get_display_mode()?i="<p "+o+' class="math '+s+'" '+a+">\\[ "+e+" \\]</p>":(i="<span "+o+' class="math '+s+'" '+a+">\\( "+e+" \\)</span>",this.current_node||(i="&#8203;"+i+"&#8203;")),this.current_node&&this.editor.id===t.get_editor().id&&this.current_node.remove(),this.editor.insertContent(i)}this.dialog.dialog("close")}}],[{key:"get_editor",value:function(){return tinymce.EditorManager.activeEditor}},{key:"rgb_to_hex",value:function(t){return"#"+t.substr(4,t.indexOf(")")-4).split(",").map(function(t){return parseInt(t).toString(16)}).join("")}}]),t}();window.Insert_Math_Dialog=new t});