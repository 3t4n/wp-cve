"use strict";var _createClass=function(){function s(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,t,i){return t&&s(e.prototype,t),i&&s(e,i),e}}(),_get=function e(t,i,s){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);return void 0!==n?"value"in n?n.value:void 0!==(n=n.get)?n.call(s):void 0:null!==(n=Object.getPrototypeOf(t))?e(n,i,s):void 0};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}jQuery(function(y){function i(e){_classCallCheck(this,i);var _=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return _.appId=e.appId,_.businessId=e.businessId,_.customerName=e.customerName,_.customerAddress=e.customerAddress,_.isLoggingEnabled=e.isLoggingEnabled,_.mountOptions=e.mountOptions,_.shipping=e.shipping,_.formInitialized||y("form.checkout").length||_.initForm(),y(document.body).on("sv_wc_payment_form_valid_payment_data",function(e,t){var i,s,n,o,r,a,l,d,c,p,h,u,m,g;return t.payment_form&&t.payment_form.id!==_.id?t.passed_validation:t.passed_validation?_.saved_payment_method_selected||_.hasNonce()?!1!==y(document.body).triggerHandler("wc_poynt_form_submitted",{payment_form:t.payment_form}):(t=y("#billing_address_1").val(),i=y("#billing_address_2").val(),s=y("#billing_postcode").val(),n=y("#billing_city").val(),o=y("#billing_state").val(),r=y("#billing_country").val(),a=y("#billing_first_name").val(),l=y("#billing_last_name").val(),d=y("#billing_email").val(),c=y("#billing_phone").val(),g=y("#ship-to-different-address-checkbox").is(":checked"),p=_.shipping.needsShipping?g?y("#shipping_address_1").val():t:"",h=_.shipping.needsShipping?g?y("#shipping_address_2").val():i:"",u=_.shipping.needsShipping?g?y("#shipping_city").val():n:"",m=_.shipping.needsShipping?g?y("#shipping_state").val():o:"",g=_.shipping.needsShipping?g?y("#shipping_postcode").val():s:"",t&&0<t.length&&(_.customerAddress.line1=t),i&&0<i.length&&(_.customerAddress.line2=i),n&&0<n.length&&(_.customerAddress.city=n),o&&0<o.length&&(_.customerAddress.state=o),r&&0<r.length&&(_.customerAddress.country=r),s&&0<s.length&&(_.customerAddress.postcode=s),a&&0<a.length&&(_.customerName.firstName=a),l&&0<l.length&&(_.customerName.lastName=l),d&&0<d.length&&(_.customerEmailAddress=d),c&&0<c.length&&(_.customerPhone=c),p&&0<p.length&&(_.shipping.line1=p),h&&0<h.length&&(_.shipping.line2=h),u&&0<u.length&&(_.shipping.city=u),m&&0<m.length&&(_.shipping.state=m),g&&0<g.length&&(_.shipping.postcode=g),_.form.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),_.createNonce(),!1):void 0}),y(document.body).on("checkout_error",function(){_.clearNonce()}),_}window.WC_Poynt_Payment_Form_Handler=(_inherits(i,SV_WC_Payment_Form_Handler_v5_12_1),_createClass(i,[{key:"getNonceField",value:function(){return y("#wc-"+this.id_dasherized+"-nonce")}},{key:"clearNonce",value:function(){this.getNonceField().val("")}},{key:"createNonce",value:function(){var e={businessId:this.businessId};this.customerName.firstName&&(e.firstName=this.customerName.firstName),this.customerName.lastName&&(e.lastName=this.customerName.lastName),this.customerAddress.line1&&(e.line1=this.customerAddress.line1),this.customerAddress.line2&&(e.line2=this.customerAddress.line2),this.customerAddress.postcode&&(e.zip=this.customerAddress.postcode),this.customerAddress.city&&(e.city=this.customerAddress.city),this.customerAddress.state&&(e.territory=this.customerAddress.state),this.customerAddress.country&&(e.countryCode=this.customerAddress.country),this.customerPhone&&(e.phone=this.customerPhone),this.customerEmailAddress&&(e.emailAddress=this.customerEmailAddress),this.shipping.line1&&(e.shippingLine1=this.shipping.line1),this.shipping.line2&&(e.shippingLine2=this.shipping.line2),this.shipping.city&&(e.shippingCity=this.shipping.city),this.shipping.state&&(e.shippingTerritory=this.shipping.state),this.shipping.postcode&&(e.shippingZip=this.shipping.postcode),this.debugLog(e),this.collect.getNonce(e)}},{key:"hasNonce",value:function(){return 0<this.getNonceField().val().length}},{key:"hasPostcodeField",value:function(){return 0<y("#billing_postcode").length}},{key:"handleError",value:function(e){var t="";"error"===e.type&&e.data&&(e.data.error&&e.data.error.message&&e.data.error.message.message?t=e.data.error.message.message:e.data.error&&e.data.error.message?t=e.data.error.message:e.data.message?t=e.data.message:e.data.error&&(t=e.data.error)),"string"==typeof t&&0<t.length?(this.debugLog(t),t.includes("Request failed")&&this.params.generic_error?_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render_errors",this).call(this,[this.params.generic_error]):(t.includes("Missing details")||t.includes("Enter a card number"))&&this.params.missing_card_details?_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render_errors",this).call(this,[this.params.missing_card_details]):t.includes("Missing field")&&this.params.missing_billing_fields?_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render_errors",this).call(this,[this.params.missing_billing_fields]):_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"render_errors",this).call(this,[t])):this.debugLog(e)}},{key:"handlePaymentFormReady",value:function(e){e.type&&"ready"===e.type?this.debugLog("Payment form ready"):this.debugLog(e),this.form.unblock()}},{key:"handleNonceReady",value:function(e){e.data&&e.data.nonce?(this.getNonceField().val(e.data.nonce),this.debugLog("Nonce set")):(this.clearNonce(),this.debugLog("Nonce value is empty")),this.form.submit()}},{key:"initForm",value:function(){var e,t,i=this;this.initializingForm||(this.initializingForm=!0,this.collect=new TokenizeJs(this.businessId,this.appId),e=!this.customerAddress.postcode&&!this.hasPostcodeField(),(t=this.mountOptions||{}).iFrame||(t.iFrame={}),t.displayComponents||(t.displayComponents={}),e&&(t.iFrame.height="280px",t.displayComponents.zipCode=!0),this.collect.mount("wc-"+this.id_dasherized+"-hosted-form",document,t),this.collect.on("nonce",function(e){i.handleNonceReady(e)}),this.collect.on("ready",function(e){i.initializingForm=!1,i.formInitialized=!0,i.handlePaymentFormReady(e)}),this.collect.on("error",function(e){i.handleError(e)}))}},{key:"set_payment_fields",value:function(){_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"set_payment_fields",this).call(this),this.formInitialized&&(this.collect.unmount("wc-"+this.id_dasherized+"-hosted-form",document),this.formInitialized=!1),this.businessId&&this.appId&&!this.initializingForm&&this.initForm()}},{key:"validate_card_data",value:function(){return!0}},{key:"debugLog",value:function(e){this.isLoggingEnabled&&console.log(e)}}]),i),y(document.body).trigger("wc_poynt_payment_form_handler_loaded")});