jQuery((function(e){e.eaccounting_importer=function(t,i){this.defaults={},this.form=t,this.$form=e(t),this.$top=e(".ea-importer-top",this.$form),this.$bottom=e(".ea-importer-bottom",this.$form),this.options=e.extend(this.defaults,i),this.action="eaccounting_do_ajax_import",this.nonce=this.$form.data("nonce"),this.type=this.$form.data("type"),this.sample={},this.mapping={},this.file="";const a=this;return this.submit=function(t){t.preventDefault(),a.$form.find(".ea-batch-notice").remove();const i=e('input[type="submit"]',a.$top),n=e('input[type="file"]',a.$top);if(i.hasClass("disabled"))return!1;if(a.$form.hasClass("mapped"))return a.mapping=a.$form.serializeAssoc().mapping,a.$form.append('<div class="ea-batch-notice"><div class="ea-batch-progress"><div></div></div></div>'),a.$form.find('input[type="submit"]').attr("disabled","disabled"),a.$form.find(".ea-importer-map-column").attr("disabled","disabled"),a.process_step(0),!1;const o=new FormData;return o.append("upload",n[0].files[0]),o.append("action",a.action),o.append("nonce",a.nonce),o.append("type",a.type),o.append("step","upload"),i.addClass("disabled"),n.attr("disabled","disabled"),i.closest("p").append('<span class="spinner is-active"></span>'),a.$form.find(".ea-importer-map-column").attr("disabled","disabled"),window.wp.ajax.send({type:"POST",data:o,dataType:"json",cache:!1,contentType:!1,processData:!1,success(e){i.find(".spinner").remove(),a.$form.addClass("mapped"),i.removeClass("disabled"),a.sample=e.sample,a.file=e.file,a.$form.find(".ea-importer-map-column").removeAttr("disabled"),a.$form.trigger("upload_complete",[e])},error(e){a.$form.find(".spinner").remove(),i.removeClass("disabled"),n.removeAttr("disabled"),a.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+e.message+"</p></div></div>")}}),!1},this.process_step=function(e){const t=a.$form.find('input[type="submit"]');window.wp.ajax.send(a.action,{data:{nonce:a.nonce,type:a.type,position:e,file:a.file,mapping:a.mapping},success(e){if("done"===e.position)return t.remove(),a.$form.find(".ea-batch-notice").remove(),a.$form.append('<div class="ea-batch-notice"><div class="updated success"><p>'+e.message+"</p></div></div>"),!1;a.$form.find(".ea-batch-progress div").animate({width:e.percentage+"%"},50,(function(){})),a.process_step(parseInt(e.position,10))},error(e){t.removeAttr("disabled"),a.$form.find(".ea-batch-notice").remove(),a.$form.find(".ea-importer-map-column").removeAttr("disabled"),e.message&&a.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+e.message+"</p></div></div>")}})},this.init_mapping=function(t,i){if(e.isEmptyObject(i))return a.$form.find(".ea-batch-notice").remove(),a.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+eaccounting_importer_i10n.uploaded_file_not_found+"</p></div></div>"),!1;a.$top.hide(),a.$bottom.slideDown();const n=e(".ea-importer-map-column",a.$bottom);let o=[];e.each(n,(function(){const t=e(this),a=e(this).attr("name"),n=e(this).closest("tr");-1!==e.inArray(a.replace("mapping","").replace(/[\[\]\]]/g,""),i.required)&&(n.find("td").eq(0).append(" <strong>"+eaccounting_importer_i10n.required+"</strong>"),t.attr("required","required")),e.each(i.headers,(function(e,t){const i=t.toLowerCase().replace(/ /g,"_").replace(/[""]/g,""),n=new RegExp("\\["+i+"\\]");a.length&&a.match(n)?o+='<option value="'+t+'" selected="selected">'+t+"</option>":o+='<option value="'+t+'">'+t+"</option>"})),e(this).append(o).trigger("change"),o=""}))},this.handle_preview=function(){const t=e(this).prop("selectedIndex");t&&!1!==a.sample[t-1]?e(this).parent().next().html(a.sample[t-1]):e(this).parent().next().html(eaccounting_importer_i10n.select_field_to_preview)},this.init=function(){this.$form.on("submit",this.submit).on("upload_complete",a.$form,this.init_mapping).on("change",".ea-importer-map-column",this.handle_preview)},this.init(),this},e.fn.eaccounting_importer=function(t){return this.each((function(){new e.eaccounting_importer(this,t)}))},e(".ea-importer").eaccounting_importer()}));