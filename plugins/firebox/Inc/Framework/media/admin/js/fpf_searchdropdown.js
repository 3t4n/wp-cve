var FPF_SearchDropdown=function(){function e(){var i;this.wrapperElement=".fpf-searchdropdown-wrapper",this.loadingIconClass=".fpf-searchdropdown-spinner",this.dropdownToggle=".fpf-searchdropdown-popup-toggle",this.resultsElement=".fpf-searchdropdown-search-results",this.resultsOnClickElement=".fpf-searchdropdown-search-results-on-click",this.choicesElement=".fpf-searchdropdown-search-choices",this.searchItemClass="fpf-searchdropdown-search-input",this.resultRemoveItem=".fpf-searchdropdown-search-results-remove-item",this.removeSingleValueButton=".fpf-searchdropdown-remove-single-value-button",this.loadingAjax=[],this.navigation_selected_item,this.navigation_index=1,this.previous_search_query="",this.delay=(i=0,function(e,t){clearTimeout(i),i=setTimeout(e,t)}),this.init()}var t=e.prototype;return t.init=function(){this.initEvents()},t.initEvents=function(){document.addEventListener("click",function(e){this.handleOnClickResultsToggle(e),this.handleResetActiveInstances(e),this.handleResultsClick(e),this.handleResultItemRemoval(e),this.handleRemoveSingleValue(e),this.handleDropdownToggle(e)}.bind(this)),document.addEventListener("scroll",function(e){this.onScrollResults(e)}.bind(this),!0),document.addEventListener("keyup",function(e){this.handleItemSearch(e)}.bind(this)),document.addEventListener("keydown",function(e){this.handleResultsKeyboardNavigation(e),this.handleResultsEnterPress(e),this.handleEscapeClosing(e)}.bind(this))},t.onScrollResults=function(t){if(t.target!==document&&t.target.closest(this.wrapperElement)){var e=this.getWrapper(t.target);if(e&&!e.getAttribute("data-local-search")){var i=e.querySelector(".nonce_hidden").value,s=this,l=e.querySelector('li.hidden-template input[type="hidden"]').dataset.name;if(97<100*t.target.scrollTop/(t.target.scrollHeight-t.target.clientHeight)&&!this.loadingAjax[l]){this.loadingAjax[l]=!0;var n=e.querySelectorAll(this.resultsElement+".lazyload ul li").length,a=e.getAttribute("data-hide-ids"),r=e.getAttribute("data-hide-flags"),o=e.querySelector("."+this.searchItemClass).getAttribute("data-path");if(!o)return;var c={nonce:i,path:o,offset:n,ids:s.getAssignedIDs(e.querySelector("."+this.searchItemClass)),hide_ids:a,hide_flags:r,action:"fpf_searchdropdown_lazyload_results"};s.showLoadingIcon(e);var d=Object.keys(c).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(c[e])}).join("&");fetch(fpf_js_object.ajax_url+"?"+d).then(function(e){return e.json()}).then(function(e){void 0!==e.html&&""!=e.html&&t.target.querySelector("ul").insertAdjacentHTML("beforeend",e.html);s.loadingAjax[l]=!1}).finally(function(){s.hideLoadingIcon(e)})}}}},t.handleResultsKeyboardNavigation=function(e){var t=this.getWrapper(e.target);if(t&&(40==e.which||38==e.which)){var i=t.querySelector(this.resultsElement+".is-visible ul");if(i){var s=i.querySelectorAll("li:not(.is-hidden)").length-1;if(40==e.which)if(this.navigation_index++,this.navigation_selected_item){this.navigation_selected_item.classList.remove("selected");var l=this.findNextNavigationItem(i,this.navigation_index,"down");this.navigation_index=l.index;var n=l.li;this.navigation_index<=s?this.navigation_selected_item=n:(this.navigation_index=0,this.navigation_selected_item=i.getElementsByTagName("li")[0]),this.navigation_selected_item&&this.navigation_selected_item.classList.add("selected")}else{var a=this.findNextNavigationItem(i,0,"down");this.navigation_index=a.index,this.navigation_selected_item=a.li,this.navigation_selected_item&&this.navigation_selected_item.classList.add("selected")}else if(38==e.which)if(this.navigation_selected_item){this.navigation_selected_item.classList.remove("selected");var r=this.findNextNavigationItem(i,this.navigation_index,"up");this.navigation_index=r.index;var o=r.li;0<=this.navigation_index?this.navigation_selected_item=o:(this.navigation_index=s,this.navigation_selected_item=i.getElementsByTagName("li")[s]),this.navigation_selected_item&&this.navigation_selected_item.classList.add("selected")}else{var c=this.findNextNavigationItem(i,0,"up");this.navigation_index=c.index,this.navigation_selected_item=c.li,this.navigation_selected_item&&this.navigation_selected_item.classList.add("selected")}if(this.navigation_selected_item){var d=this.navigation_selected_item.offsetHeight;i.parentElement.scrollTop=d*this.navigation_index-2*d}}}},t.findNextNavigationItem=function(e,t,i){var s=e.querySelectorAll("li:not(.is-hidden)");if("down"==i){if(t>=s.length)return this.findNextNavigationItem(e,0,"down");var l=0,n=s,a=Array.isArray(n),r=0;for(n=a?n:n[Symbol.iterator]();;){var o;if(a){if(r>=n.length)break;o=n[r++]}else{if((r=n.next()).done)break;o=r.value}var c=o;if(c.classList.contains("is-disabled")||c.classList.contains("skip")||c.classList.contains("is-hidden"))l++;else{if(l>s.length-1)return this.findNextNavigationItem(e,0,"down");if(!(l<t))return{li:c,index:l};l++}}return this.allListItemsAraUnavailable(s)?{li:null,index:0}:this.findNextNavigationItem(e,0,"down")}if(t<=0)return this.findNextNavigationItem(e,s.length+1,"up");for(var d=s.length-1;0<=d;d--){var u=s[d];if(!(u.classList.contains("is-disabled")||u.classList.contains("skip")||u.classList.contains("is-hidden"))){if(d<0)return this.findNextNavigationItem(e,s.length+1,"up");if(!(t<=d))return{li:u,index:d}}}return this.allListItemsAraUnavailable(s)?{li:null,index:0}:this.findNextNavigationItem(e,s.length+1,"up")},t.allListItemsAraUnavailable=function(e){if(!e)return!0;var t=e,i=Array.isArray(t),s=0;for(t=i?t:t[Symbol.iterator]();;){var l;if(i){if(s>=t.length)break;l=t[s++]}else{if((s=t.next()).done)break;l=s.value}var n=l;if(!n.classList.contains("is-disabled")&&!n.classList.contains("skip"))return!1}return!0},t.handleResultsEnterPress=function(e){if(13==e.which){var t=this.getWrapper(e.target);if(t){var i=t.querySelector(this.resultsElement+".is-visible li.selected");i&&(this.onResultClick(i),document.activeElement.blur(),e.preventDefault())}}},t.handleEscapeClosing=function(e){27==(e=e||window.event).keyCode&&this.getWrapper(e.target)&&this.hideOtherInstances(e)},t.handleDropdownToggle=function(e){var t=e.target.closest(this.dropdownToggle);if(t&&!e.target.closest(this.removeSingleValueButton)){this.hideOtherInstances(e);var i=t.classList.contains("is-active")?"close":"open";this.dropdownChangeStatus(t,i);var s=t.parentElement.querySelector(this.resultsOnClickElement+" li.is-disabled");s&&(s.parentNode.parentNode.scrollTop=s.offsetTop)}},t.dropdownChangeStatus=function(e,t){if("open"==t){e.classList.add("is-active"),e.parentElement.classList.add("is-active"),e.parentElement.querySelector(this.resultsOnClickElement).classList.add("is-visible"),this.resetNavigationElements(e);var i=e.nextElementSibling.querySelector("."+this.searchItemClass);setTimeout(function(){i.focus()},50)}else{e.classList.remove("is-active"),e.parentElement.classList.remove("is-active");var s=e.parentElement.querySelector(this.resultsOnClickElement);s&&s.querySelectorAll("li.is-hidden").forEach(function(e){e.classList.remove("is-hidden")})}},t.resetNavigationElements=function(e){var t=this.getWrapper(e);this.navigation_index=0,this.navigation_selected_item=null;var i=t.querySelectorAll("li.selected");i&&i.forEach(function(e){e.classList.remove("selected")})},t.handleDropdownClose=function(){var t=this,e=document.querySelectorAll(this.dropdownToggle+".is-active");e&&e.forEach(function(e){t.dropdownChangeStatus(e,"close")})},t.handleResetActiveInstances=function(e){e.target.closest(this.resultsElement)||e.target.closest(this.choicesElement)||this.hideOtherInstances(e)},t.hideOtherInstances=function(e){var t=this;if(!e.target.closest(".fpf-modal.upgrade-pro")){var i=document.querySelectorAll(this.wrapperElement+".clicked");i&&i.forEach(function(e){"0"!=e.getAttribute("data-multiple")&&e.classList.remove("clicked")});var s=document.querySelectorAll(this.resultsElement+".is-visible");s&&s.forEach(function(e){t.clearItem(e)}),this.handleDropdownClose(e)}},t.clearItem=function(e){var t=e.querySelector(this.choicesElement+' input[type="text"]');t&&(t.value=""),this.clearResultsBox(e)},t.handleItemSearch=function(e){var t=e.target;if(t.classList.contains(this.searchItemClass)){var i=this;!t.getAttribute("data-path")||this.getWrapper(t).getAttribute("data-local-search")?i.doLocalSearch(e):i.delay(function(){i.doAjaxSearch(e)},250)}},t.doLocalSearch=function(e){var t=e.target,i=t.value.toUpperCase(),s=t.closest(".fpf-field-item"),l=s.querySelectorAll(this.resultsOnClickElement+" ul li:not(.no_results)");l.forEach(function(e){if(e.classList.contains("is-separator"))e.classList.add("is-hidden");else{var t=e.querySelector(".title");-1<(t.textContent||t.innerText).toUpperCase().indexOf(i)?e.classList.remove("is-hidden"):e.classList.add("is-hidden")}});var n=s.querySelectorAll(this.resultsOnClickElement+" ul li:not(.no_results).is-hidden"),a=s.querySelector(this.resultsOnClickElement+" ul");if(l.length==n.length)if(a.querySelector("li.no_results"))a.querySelector("li.no_results").classList.remove("hide");else{var r=document.createElement("li");r.classList.add("no_results","skip"),r.innerHTML=fpf_js_object.FPF_NO_RESULTS_FOUND,a.appendChild(r)}else a.querySelector("li.no_results")&&a.querySelector("li.no_results").classList.add("hide");if(""===i){var o=s.querySelectorAll(this.resultsOnClickElement+" ul li.is-separator.is-hidden");o&&o.forEach(function(e){e.classList.remove("is-hidden")})}},t.doAjaxSearch=function(e){var t=this,i=e.target,s=i.value;if(this.previous_search_query!=s){this.previous_search_query=s;var l=this.getWrapper(e.target),n=l.querySelector(".nonce_hidden").value,a=i.getAttribute("data-path"),r=i.closest("ul").nextElementSibling,o="";if(this.onClickResultsExist(l)&&(o=l.querySelector(this.resultsOnClickElement)),""!=s){var c={nonce:n,path:a,search:s,hide_ids:l.getAttribute("data-hide-ids"),action:"fpf_searchdropdown_get_data",post_id:fpf_js_object.post_id,ids:this.getAssignedIDs(i)};this.showLoadingIcon(l);var d=Object.keys(c).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(c[e])}).join("&");fetch(fpf_js_object.ajax_url+"?"+d).then(function(e){return e.json()}).then(function(e){void 0!==e.html&&""!=e.html?(t.onClickResultsExist(l)&&o.classList.remove("is-visible"),t.setResultsBox(r,e)):t.clearResultsBox(r)}).finally(function(){t.hideLoadingIcon(l)})}else{this.clearResultsBox(r);var u=u||l.querySelector(this.resultsOnClickElement);u&&u.classList.add("is-visible")}}},t.getAssignedIDs=function(e){var t=[];return e.closest("ul").querySelectorAll("li.result-item").forEach(function(e){t.push(e.querySelector("input").value)}),t},t.handleResultsClick=function(e){this.onResultClick(e.target)},t.onResultClick=function(e){var t=e.closest(this.resultsElement);if(t&&e.closest("li")&&((e=e.closest("li")).classList.remove("selected"),!e.classList.contains("is-disabled")&&!e.classList.contains("skip"))){var i=this.getWrapper(t),s=i.querySelector(this.choicesElement),l=i.getAttribute("data-multiple")||!0;if("0"==l){s.querySelector("li.result-item")&&s.querySelector("li.result-item").remove(),this.makeAllResultsItemsAvailable(i);var n=new CustomEvent("onFPFSearchDropdownSingleValueChange",{cancelable:!0,detail:{key:e.dataset.id,container:i,element:e}});if(document.dispatchEvent(n),n.defaultPrevented)return;i.querySelector(this.dropdownToggle).classList.add("has-value"),i.querySelector(this.dropdownToggle+" .label").innerHTML=e.querySelector(".title").innerHTML}var a=e.getAttribute("data-id");if(a){if(this.onClickResultsExist(i)){var r=i.querySelector(this.resultsOnClickElement),o=a.replace(/\\/g,"\\\\");r.querySelector('li[data-id="'+o+'"]')&&(r.querySelector('li[data-id="'+o+'"]').classList.add("is-disabled"),r.querySelector('li[data-id="'+o+'"]').classList.add("skip"))}var c=i.querySelector("."+this.searchItemClass).getAttribute("data-path"),d=e.innerHTML,u=s.querySelector("li.hidden-template").cloneNode(!0);u.classList.remove("hidden-template"),u.classList.add("result-item"),"0"==l&&u.classList.add("hide"),u.querySelector(".text")&&(u.querySelector(".text").innerHTML=d);var h=u.querySelector("input");h.value=a;var v=h.getAttribute("data-name");h.setAttribute("name",v),h.setAttribute("class","fpf-selected-dropdown-value"),h.removeAttribute("data-name");var m=s.querySelector("li:last-child");u.querySelector(".meta .text")&&u.querySelector(".meta .text").remove(),m.before(u),m.querySelector('input[type="text"]').value="",this.clearResultsBox(t),c||this.makeAllResultsItemsVisible(t),this.previous_search_query&&(this.previous_search_query=""),t.closest(this.wrapperElement).classList.remove("clicked")}}},t.makeAllResultsItemsAvailable=function(e){e.querySelectorAll(this.resultsElement).forEach(function(e){var t=e.querySelectorAll("li.is-disabled");t&&t.forEach(function(e){e.classList.remove("is-disabled"),e.classList.remove("skip")})})},t.makeAllResultsItemsVisible=function(e){var t=e.querySelectorAll("li.is-hidden");t&&t.forEach(function(e){e.classList.remove("is-hidden")})},t.handleResultItemRemoval=function(e){var t=e.target.closest(this.resultRemoveItem);if(t){var i=t.closest("li").querySelector("input").value;if(this.onClickResultsExist(t.closest(".fpf-field-item"))){var s=t.closest(".fpf-field-item").querySelector(this.resultsOnClickElement).querySelector('li[data-id="'+i+'"]');s&&(s.classList.remove("is-disabled"),s.classList.remove("skip"))}t.closest("li").remove(),e.preventDefault()}},t.handleRemoveSingleValue=function(e){var t=e.target.closest(this.removeSingleValueButton);if(t){var i=t.closest(this.dropdownToggle),s=this.getWrapper(i);i.classList.remove("has-value");var l=i.querySelector(":scope > .label");l.innerHTML=l.dataset.placeholder;var n=new CustomEvent("onFPFSearchDropdownSingleValueRemove",{detail:{key:s.querySelector(this.choicesElement+' li.result-item input[type="hidden"]').value,element:s}});document.dispatchEvent(n),this.resetSingle(s)}},t.resetSingle=function(e){this.clearItem(e);var t=e.querySelector(this.choicesElement);t.querySelector("li.result-item")&&t.querySelector("li.result-item").remove();var i=e.querySelector(this.resultsOnClickElement);i&&(i.querySelectorAll("li.is-disabled").forEach(function(e){e.classList.remove("is-disabled")}),i.querySelectorAll("li.skip").forEach(function(e){e.classList.remove("skip")}))},t.handleOnClickResultsToggle=function(e){var t=e.target.closest(this.choicesElement);if(t){var i=t.closest(this.wrapperElement);if(this.onClickResultsExist(i)&&!e.target.classList.contains(this.resultRemoveItem.substring(1))){this.makeAllResultsItemsVisible(i);var s=i.getAttribute("data-multiple"),l=i.querySelector(this.resultsOnClickElement+".is-visible");l&&"0"!=s&&l.classList.remove("is-visible");var n=i.querySelector(this.resultsElement+".is-visible");n&&"0"!=s&&n.classList.remove("is-visible"),i.classList.add("clicked"),i.querySelector(this.resultsOnClickElement).classList.add("is-visible"),e.preventDefault()}}},t.getTotalSelectedChoices=function(e){return e?e.querySelectorAll(".result-item").length:0},t.setResultsBox=function(e,t){e.innerHTML=JSON.parse(t.html),e.classList.add("is-visible")},t.clearResultsBox=function(e){e.classList.remove("is-visible");var t=this.getWrapper(e);this.isSingle(t)&&this.dropdownChangeStatus(t.querySelector(this.dropdownToggle),"close")},t.isSingle=function(e){return"0"==e.getAttribute("data-multiple")},t.showLoadingIcon=function(e){e.querySelector(this.loadingIconClass).classList.add("is-visible")},t.hideLoadingIcon=function(e){e.querySelector(this.loadingIconClass).classList.remove("is-visible")},t.onClickResultsExist=function(e){return!!e.querySelector(this.resultsOnClickElement)},t.getWrapper=function(e){var t=e.closest(this.wrapperElement);return t||!1},e}();FPF_Helper.onReady(function(){new FPF_SearchDropdown});

