var J={ALBUM:"album",FOLDERS:"folders",NAME:"name",PATH:"path",THUMB:"thumb",IMAGE:"image",WIDTH:"width",HEIGHT:"height",ORIGINAL:"original",OBJECTS:"objects",FILEDATE:"fileDate",COMMENT:"comment",TITLE:"title",COUNTERS:"counters",DEEPCOUNTERS:"deepCounters",FILESIZE:"fileSize",CATEGORY:"category",KEYWORDS:"keywords",RATING:"rating",CAMERA:"camera",VIDEO:"video",DURATION:"duration",FPS:"fps",LEVEL:"level",PATHREF:"pathRef",PARENTREF:"parentRef",RELPATH:"relPath",FOLDERTITLE:"folderTitle",IMAGECAPTION:"imageCaption",THUMBCAPTION:"thumbCaption",PHOTODATA:"photodata",LOCATION:"location",REGIONS:"regions",SHOP:"shop",EXTERNAL:"external",PROJECTIONTYPE:"projectionType",DATES:"dates",ADDED:"added",TAKENDATE:"takenDate",MODIFIEDDATE:"modifiedDate",DATERANGE:"dateRange",MOSTPHOTOS:"mostphotos",FOTOMOTOCOLLECTION:"fotomotoCollection",SOUNDCLIP:"soundClip",PANORAMA:"panorama",FILTERS:"filters",SORT:"sort",VISITORRATING:"visitorRating",OBJ:"obj",LOADCOUNTER:"loadcounter",TOTAL:"total",FOLDERINDEX:"folderindex"},JCAMERA=["aperture","exposureTime","originalDate","cameraModel","location","focusDistance","focalLength35mm","cameraMake","resolution","isoEquivalent","flash","focalLength"],Album=function(e,t){var r,n,o,a,l,s={treeFile:"tree.json",dataFile:"data1.json",deepDataFile:"deep-data.json",indexName:"index.html",folderImageFile:"folderimage.jpg",folderImageDims:[1200,800],folderThumbFile:"folderthumb.jpg",folderThumbDims:[600,420],thumbDims:[240,180],thumbsDir:"thumbs",slidesDir:"slides",hiresDir:"hi-res",audioPoster:"audio.poster.png",videoPoster:"video.poster.png",rootPath:"",relPath:"",loadDeep:!1,lazy:!0,possibleTypes:["folder","webPage","webLocation","image","video","audio","other"]},E=getTranslations({and:"and",from:"From {0}"}),u=null,O="",f={},c=[],h=[],p=function(e){console&&e&&DEBUG&&(e.match(/^Error\:/i)?console.error("jalbum-album.js "+e):e.match(/^Warning\:/i)?console.warn("jalbum-album.js "+e):e.match(/^Info\:/i)?console.info("jalbum-album.js "+e):console.log("jalbum-album.js "+e))},T=e=>decodeURIComponent(e.slice(e.lastIndexOf("/")+1)),A=e=>!e.hasOwnProperty(J.FOLDERINDEX)&&e.hasOwnProperty(J.CATEGORY)&&-1!=="image.video.audio.other".indexOf(e[J.CATEGORY]),D=function(){if(arguments.length){for(var e=arguments[0],t=1;t<arguments.length;t++)arguments[t]&&("/"===arguments[t]?e="/":"/"===arguments[t][0]?e+="/"===e.slice(-1)?arguments[t].slice(1):arguments[t]:e+="/"===e.slice(-1)?arguments[t]:"/"+arguments[t]);return e}return""},P=function(e){if(typeof e===UNDEF||!e)return 0;"/"!==e.slice(-1)&&(e+="/");var t=c.indexOf(e);return t>=0?t+1:c.push(e)},y=e=>e.hasOwnProperty(J.PATHREF)&&e[J.PATHREF]?u?D(u,c[e[J.PATHREF]-1]):c[e[J.RELPATH]-1]:u||"",g=function(e){var t=y(e),r=e[J.CATEGORY]||"folder";return"folder"===r?t:"video"===r?t+e[J.VIDEO][J.PATH]:"audio"===r||"other"===r||e.hasOwnProperty(J.ORIGINAL)?t+e[J.ORIGINAL][J.PATH]:"image"===r?t+e[J.IMAGE][J.PATH]:"webPage"===r?t+e[J.NAME]:e[J.PATH]},R=function(e){if(typeof e===UNDEF)return null;if(!e.length)return f;var t,r=f,n=e.split("/");for(t=0;t<n.length;t++)if(!r.hasOwnProperty(J.FOLDERS)||!(r=r[J.FOLDERS].find(function(e){return e[J.PATH]===n[t]})))return null;return t===n.length?r:null},m=function(e){if(typeof e===UNDEF&&(e=o),e===f)return null;var t=function(e){return"number"!=typeof e||e<=0?f:--e>c.length?(p("Error: out of bounds path reference ("+e+")!"),null):R(c[e])}(e[J.PARENTREF]||e[J.PATHREF]);return t===e?null:t},L=e=>"video"===e[J.CATEGORY]?T(e[J.VIDEO][J.PATH]):e.hasOwnProperty(J.ORIGINAL)?T(e[J.ORIGINAL][J.PATH]):e[J.NAME],F=e=>(e=e||o).hasOwnProperty(J.LEVEL)?e[J.LEVEL]:F(m(e)),I=e=>(e||o)[J.TITLE]||"",w=e=>(e||o)[J.NAME]||"",S=e=>((e||o)[J.NAME]||"").replace(/\.\w+$/,"").replace(/_/g," "),C=function(e){var t=0;if((e=typeof e===UNDEF?o:e).hasOwnProperty(J.FOLDERS))if(e.hasOwnProperty(J.DEEPCOUNTERS)&&e[J.DEEPCOUNTERS].hasOwnProperty(J.FOLDERS))t=e[J.DEEPCOUNTERS][J.FOLDERS];else{for(var r=0,n=e[J.FOLDERS].length;r<n;r++)t+=C(e[J.FOLDERS][r]);e.hasOwnProperty(J.DEEPCOUNTERS)||(e[J.DEEPCOUNTERS]={}),e[J.DEEPCOUNTERS][J.FOLDERS]=t}return t+1},N=e=>f.hasOwnProperty(e)?f[e]:null,v=function(t,r){var n={};do{t.hasOwnProperty(r)&&(n=e.extend(!0,{},t[r],n))}while(t=m(t));return Object.getOwnPropertyNames(n).length?n:null},x=function(t,r){if(r.indexOf(".")>=0){if("album"===(r=r.split("."))[0])return N(r[1]);do{if(t.hasOwnProperty(r[0]))return e.extend(!0,{},t[r[0]][r[1]])}while(t=m(t));return null}do{if(t.hasOwnProperty(r))return e.extend(!0,{},t[r])}while(t=m(t));return null},b=function(e,t){if(t)for(var r in e)r===J.OBJECTS||r===J.ALBUM||t.hasOwnProperty(r)||(t[r]=e[r])},M=function(e,t,r){if(e.hasOwnProperty(J.OBJECTS)){t[J.OBJECTS]=[];for(var n,o=0,a=0,i=e[J.OBJECTS].length;o<i;o++)n=e[J.OBJECTS][o],f[J.LOADCOUNTER][n[J.CATEGORY]]++,f[J.LOADCOUNTER][J.TOTAL]++,"folder"===n[J.CATEGORY]?(t[J.FOLDERS]||(t[J.FOLDERS]=[]),b(n,t[J.FOLDERS][a]),r&&M(n,t[J.FOLDERS][a],!0),(n={})[J.FOLDERINDEX]=a,a++):(n[J.PATHREF]=t[J.PATHREF],n[J.RELPATH]=t[J.RELPATH]),t[J.OBJECTS].push(n)}},H=function(t,r){if(t){if(t.hasOwnProperty(J.OBJECTS))return e.isFunction(r)&&r.call(this,t),!0;var n=D(y(t),s.dataFile)+O;h||(h=[]),h.push(e.getJSON(n).done(function(n){b(n,t),M(n,t),e.isFunction(r)&&r.call(this,t)}).fail(function(o,a,i){p('Error loading folder data for "'+n+'": '+a+", "+i),e.isFunction(r)&&r.call(this,t)}))}},U=function(e,t){if(H(e),t&&e.hasOwnProperty(J.FOLDERS))for(var r=0,n=e[J.FOLDERS].length;r<n;r++)U(e[J.FOLDERS][r])},B=function(t,r){var n=new Date,o=D(u||rootPath,s.deepDataFile)+O;return e.getJSON(o).done(function(r){DEBUG&&(p("Deep data loaded: "+(new Date-n)+"ms total: "+f[J.LOADCOUNTER][J.TOTAL]+" objects"),n=new Date),M(r,f,!0),DEBUG&&p("Deep data objects are ready: "+(new Date-n)+"ms total: "+f[J.LOADCOUNTER][J.TOTAL]+" objects"),l=!0,e.isFunction(s.deepReady)&&(s.deepReady.call(this),s.deepReady=null),e.isFunction(t)&&t.call(this)}).fail(function(){l=!1,DEBUG&&p('Error loading deep data: "'+o+'".'),e.isFunction(s.deepReady)&&(s.deepReady.call(this),s.deepReady=null),e.isFunction(r)&&r.call(this)})};return t&&(p("new Album("+JSON.stringify(t)+");"),function(t){if(r)return r;r=new Date,typeof t!==UNDEF&&e.extend(s,t),a=l=!1,s.hasOwnProperty("albumPath")?"/"!==(u=s.albumPath).slice(-1)&&(u+="/"):u="."===s.rootPath?"":s.rootPath,n=function(e){if(typeof e===UNDEF)return window.location.href.substring(0,window.location.href.lastIndexOf("/"));if(e.match(/^https?\:\/\//i))return e;if("/"===e[0])return window.location.origin+e;var t=window.location.href;for(t=t.substring(0,t.lastIndexOf("/"));e.startsWith("../");)t=t.substring(0,t.lastIndexOf("/",t.length-2)),e=e.slice(3);return t+e}(u),s.hasOwnProperty("makeDate")&&(O="?"+s.makeDate);(function(t){var r=D(u||relPath,s.treeFile)+O;e.getJSON(r).done(function(r){(f=r)[J.LOADCOUNTER]={},f[J.LOADCOUNTER][J.TOTAL]=0;for(var n=0;n<s.possibleTypes.length;n++)f[J.LOADCOUNTER][s.possibleTypes[n]]=0;null===(o=R(s.relPath))&&e.isFunction(s.fatalError)&&s.fatalError.call(this,"noSuchFolder",s.relPath),function(){var e=function(t,r,n,a){var i=r?D(n,t[J.PATH]):"",l=r?P(i):0;if(t[J.LEVEL]=r,t.hasOwnProperty(J.CATEGORY)||(t[J.CATEGORY]="folder"),r&&(t[J.PARENTREF]=a),t[J.PATHREF]=l,u||(r?t!==o&&(0===(i+"/").indexOf(n)?t[J.RELPATH]=P(i.substring(n.length+1)):t[J.RELPATH]=P(s.rootPath+i)):t[J.RELPATH]=l),t[J.THUMB][J.PATH].startsWith(t[J.PATH]+"/"+s.thumbsDir)&&(t[J.THUMB][J.PATH]=t[J.THUMB][J.PATH].slice(t[J.PATH].length+1)),t.hasOwnProperty(J.FOLDERS))for(var E=0,O=t[J.FOLDERS].length;E<O;E++)e(t[J.FOLDERS][E],r+1,i,l)};e(f,0,"",0)}(),e.isFunction(t)&&t.call(this)}).fail(function(n,o,a){e.isFunction(s.fatalError)&&s.fatalError.call(this,"databaseAccessDenied",r),e.isFunction(t)&&t.call(this)})})(function(){h=[],U(s.lazy?o:f,!s.lazy),e.when.apply(e,h).done(function(){var t=new Date;DEBUG&&p(h.length+" folder(s) loaded: "+(t-r)+"ms"),a=!0,h=null,e.isFunction(s.ready)&&(s.ready.call(this),s.ready=null),s.loadDeep&&f.hasOwnProperty(J.FOLDERS)?B():e.isFunction(s.deepReady)&&(s.deepReady.call(this),s.deepReady=null)})})}(t)),{isReady:()=>a,isDeepReady:()=>l,getTree:()=>f,getPaths:()=>c,isImage:e=>e.hasOwnProperty(J.CATEGORY)&&"image"===e[J.CATEGORY],isAudio:e=>e.hasOwnProperty(J.CATEGORY)&&"audio"===e[J.CATEGORY],isVideo:e=>e.hasOwnProperty(J.CATEGORY)&&"video"===e[J.CATEGORY],isLightboxable:A,isCurrentFolder:e=>e===o,getAlbumPath:function(){if(u)return u;var e=window.location.pathname,t=o[J.LEVEL];do{e=e.substring(0,e.lastIndexOf("/")),t-=1}while(t>=0);return e},getPath:y,getItemPath:g,getLink:function(e){if(typeof e!==UNDEF){switch(e[J.CATEGORY]){case"folder":return y(e);case"webLocation":return e[J.PATH];case"webPage":return D(y(e),e[J.PATH])}return D(y(e),"#img="+e[J.PATH])}return""},getRootPath:e=>y(e)+e[J.NAME],getFolder:R,getParent:m,getItem:function(e,t){if("function"==typeof t){var r=function(e,t,r){if(e.hasOwnProperty(J.OBJECTS)){var n=e[J.OBJECTS].find(function(e){return e[J.NAME]===t});r.call(n)}};if(e)if(e.endsWith("/"))t.call(R(e));else{var n=e.lastIndexOf("/"),o=R(e.substring(0,n)),a=e.substring(n+1);o&&(o.hasOwnProperty(J.OBJECTS)?r(o,a,t):H(o,function(e){r(e,a,t)}))}else t.call(f);return null}},getCurrentFolder:()=>o,getObjects:()=>o.hasOwnProperty(J.OBJECTS)?o[J.OBJECTS]:[],getImages:function(){var e=[];return o&&o.hasOwnProperty(J.OBJECTS)&&o[J.OBJECTS].forEach(t=>{A(t)&&e.push(t)}),e},getFolders:function(){if(o){if(o.hasOwnProperty(J.FOLDERINDEX)){var e=[];return o[J.FOLDERINDEX].forEach(t=>{e.push(o[J.OBJECTS][t])}),e}if(o.hasOwnProperty(J.FOLDERS))return o[J.FOLDERS]}return[]},getMakeDate:()=>new Date(f[J.FILEDATE]),getAlbumTitle:()=>f[J.TITLE]||f[J.NAME],getItemName:L,getExtension:e=>{var t=L(e).match(/\.(\w+)$/);return t?t[1]:""},getLevel:F,getTitle:I,getName:w,getLabel:S,getAlt:e=>I(e)||w(e),getComment:e=>(e||o)[J.COMMENT]||"",getThumbPath:function(e){var t=e[J.THUMB][J.PATH];return(e=>e.hasOwnProperty(J.LEVEL))(e)&&(t=t.replace(e[J.PATH]+"/","")),D(y(e),t)},getImagePath:e=>D(y(e),e.hasOwnProperty(J.LEVEL)?e[J.THUMB][J.PATH].replace(s.thumbsDir+"/",s.slidesDir+"/"):e[J.IMAGE][J.PATH]),getThemeImagePath:e=>D(y(e),s.folderImageFile),getOriginalPath:e=>e.hasOwnProperty(J.ORIGINAL)?D(y(e),e[J.ORIGINAL][J.PATH]):null,getPosterPath:function(e){var t=e[J.CATEGORY],r=e[J.IMAGE][J.PATH];return"audio"!==t&&"video"!==t||r.startsWith(s.slidesDir+"/")?D(y(e),e[J.IMAGE][J.PATH]):D(rootPath,"res",s[t+"Poster"])},getOptimalImage:function(e,t){var r=y(e[J.RELPATH]);return"folder"===(e[J.CATEGORY]||"folder")?D(r,t[0]>s.folderThumbDims[0]||t[1]>s.folderThumbDims[1]?s.folderImageFile:s.folderThumbFile):D(r,t[0]>s.thumbDims[0]||t[1]>s.thumbDims[1]?e[J.IMAGE][J.PATH]:e[J.THUMB][J.PATH])},getSourcePath:e=>D(y(e),e.hasOwnProperty(J.ORIGINAL)?e[J.ORIGINAL][J.PATH]:e[J.IMAGE][J.PATH]),getAbsoluteItemPath:e=>D(n,g(e)),getVideoDuration:function(e){var t,r=e[J.VIDEO];return r&&r.hasOwnProperty(J.DURATION)&&(t=r[J.DURATION].match(/(\d{2})\:(\d{2})\:(\d{2})\.(\d+)/))?parseInt(t[4])+1e3*parseInt(t[3])+6e4*parseInt(t[2])+36e5*parseInt(t[1]):null},hasShop:e=>{var t=v(e||f,J.SHOP);return t&&(t.usePrice||"-"!==t.options)},hasLocation:e=>e.hasOwnProperty(J.LOCATION)||e.hasOwnProperty(J.CAMERA)&&e[J.CAMERA].hasOwnProperty(J.LOCATION),getLocation:e=>e.hasOwnProperty(J.LOCATION)?e[J.LOCATION]:e.hasOwnProperty(J.CAMERA)&&e[J.CAMERA].hasOwnProperty(J.LOCATION)?e[J.CAMERA][J.LOCATION].lat+","+e[J.CAMERA][J.LOCATION].long:null,getPriceRange:function(e){var t=v(e||f,J.SHOP);if(t&&"-"!==t.options&&t.showPriceRange){var r=t.options.split("::"),n=Number.MAX_VALUE,o=Number.MIN_VALUE;if(r.length>1){for(a=0;a<r.length;a++)n=Math.min(parseFloat(r[a].split("=")[1].split("+")[0]),n);if("minmax"===t.showPriceRange){for(var a=0;a<r.length;a++)o=Math.max(parseFloat(r[a].split("=")[1].split("+")[0]),o);return toCurrency(n,t.currency)+"&ndash;"+toCurrency(o,t.currency)}return E.from.template(toCurrency(n,t.currency))}return toCurrency(r[0].split("=")[1].split("+")[0],t.currency)}return""},getCurrency:()=>N(J.SHOP).currency||"EUR",getDeepFolderCount:C,getRootProperty:N,getInheritedPropertyObject:v,getInheritedProperty:x,getProperty:function(t,r,n){var o;return n?o=x(t,r):r.indexOf(".")>0?(r=r.split("."),o=t.hasOwnProperty(r[0])?t[r[0]][r[1]]:null):t.hasOwnProperty(r)&&(o=t[r]),e.extend(!0,{},o)},getPropertyObject:(t,r,n)=>n?v(t,r):t.hasOwnProperty(r)?e.etxend(!0,{},t[r]):null,getNextFoldersFirstImage:function(e){var t=function(e){typeof e===UNDEF&&(e=o);var t=m(e);if(t){var r;if(t.hasOwnProperty(J.FOLDERINDEX)){if(r=t[J.FOLDERINDEX].findIndex(function(r){return t[J.OBJECTS][r]===e}),i<t[J.FOLDERINDEX].length)return t[J.OBJECTS][t[J.FOLDERINDEX][r+1]]}else if(t.hasOwnProperty(J.FOLDERS)&&(r=t[J.FOLDERS].findIndex(function(t){return t===e}))<t[J.FOLDERS].length)return t[J.FOLDERS][r+1]}return null}();return t&&(t.hasOwnProperty(J.OBJECTS)?e.call(getFirstImage()):H(t,function(){e.call(function(e){if(e.hasOwnProperty(J.OBJECTS))for(var t=e[J.OBJECTS],r=0,n=t.length;r<n;r++)if(A(t[r]))return t[r]}())})),null},getPreviousFoldersLastImage:function(e){var t=function(e){typeof e===UNDEF&&(e=o);var t=m(e);if(t){var r;if(t.hasOwnProperty(J.FOLDERINDEX)){if((r=t[J.FOLDERINDEX].findIndex(function(r){return t[J.OBJECTS][r]===e}))>0)return t[J.OBJECTS][t[J.FOLDERINDEX][r+1]]}else if(t.hasOwnProperty(J.FOLDERS)&&(r=t[J.FOLDERS].findIndex(function(t){return t===e}))>0)return t[J.FOLDERS][r+1]}return null}();return t&&(t.hasOwnProperty(J.OBJECTS)?e.call(getFirstImage()):H(t,function(){e.call(function(e){if(e.hasOwnProperty(J.OBJECTS))for(var t=e[J.OBJECTS],r=t.length-1;r>=0;r--)if(A(t[r]))return t[r]}())})),null},collectNItem:function(t){if(typeof t!==UNDEF&&t.hasOwnProperty("ready")){var t=e.extend({folder:"",levels:0,include:"images",max:0,sortBy:"original",sortOrder:0},t),r=[],n=[],o=R(t.folder),a=t.levels?function(e,t){var r=e[J.LEVEL]+(t||0),n=function(e){var t=0;if(e.hasOwnProperty(J.FOLDERS)&&e[J.LEVEL]<=r)for(var o=0,a=e[J.FOLDERS].length;o<a;o++)t+=n(e[J.FOLDERS][o]);return t+1};return n(e)}(o,t.levels):1,i=0,E=!o&&t.levels>1&&f.hasOwnProperty(J.FOLDERS),u=-1!==t.include.indexOf("images"),O=-1!==t.include.indexOf("folders"),c=function(e){e&&e.hasOwnProperty(J.OBJECTS)&&e[J.OBJECTS].forEach(e=>{A(e)&&r.push(e)})},d=function(e){O&&n.push(e),u&&H(e,c),e[J.LEVEL]<=maxLevel&&e.hasOwnProperty(J.FOLDERS)&&e[J.FOLDERS].forEach(e=>d(e)),i++},p=function(){d(o),setTimeout(D,20)},T=function(){h=[],d(o),setTimeout(function(){h.length?e.when.apply(e,h).done(D):D()},20)},D=function(){t.max&&t.quick&&r.length+n.length>=t.max||i>=a?(P(),e.isFunction(t.ready)&&t.ready.call(r,t)):setTimeout(D,50)},P=function(){switch(t.sortBy){case"original":-1===t.sortOrder?(O&&n.sort(()=>.5-Math.random()),u&&r.sort(()=>.5-Math.random())):1===t.sortOrder&&(O&&n.reverse(),u&&r.reverse());break;case J.FILEDATE:case J.ADDED:case J.TAKENDATE:case J.MODIFIEDDATE:t.sortOrder?(O&&n.sort((e,t)=>t[J.FILEDATE]-e[J.FILEDATE]),u&&r.sort((e,r)=>(r.hasOwnProperty(J.DATES)?r[J.DATES][t.sortBy]:r[J.FILEDATE])-e.hasOwnProperty(J.DATES)?e[J.DATES][t.sortBy]:e[J.FILEDATE])):(O&&n.sort((e,t)=>e[J.FILEDATE]-t[J.FILEDATE]),u&&r.sort((e,r)=>(e.hasOwnProperty(J.DATES)?e[J.DATES][t.sortBy]:e[J.FILEDATE])-r.hasOwnProperty(J.DATES)?r[J.DATES][t.sortBy]:r[J.FILEDATE]));break;case J.NAME:t.sortOrder?(O&&n.sort((e,t)=>(""+t[J.NAME]).localeCompare(""+e[J.NAME])),u&&r.sort((e,t)=>(""+t[J.NAME]).localeCompare(""+e[J.NAME]))):(O&&n.sort((e,t)=>(""+e[J.NAME]).localeCompare(""+t[J.NAME])),u&&r.sort((e,t)=>(""+e[J.NAME]).localeCompare(""+t[J.NAME])));break;case J.FILESIZE:t.sortOrder?u&&r.sort((e,t)=>t[J.FILESIZE]-e[J.FILESIZE]):u&&r.sort((e,t)=>e[J.FILESIZE]-t[J.FILESIZE])}O&&(r=u?"folders,images"===t.include?n.concat(r):r.concat(n):n),t.max&&t.max<r.length&&(r=r.slice(0,t.max))};t.hasOwnProperty("quick")||(t.quick=t.max&&"original"!==t.sortBy),maxLevel=o[J.LEVEL]+t.levels,random=-1===t.sortOrder,random&&(s.sortBy="original"),E&&!l?B(p,T):T()}},collectByDate:function(t){if(typeof t!==UNDEF&&t.hasOwnProperty("range")&&t.hasOwnProperty("ready")){var r,n,a=[],i="current"===(t=e.extend({sort:!0,reverse:!1,reference:"dateTaken",depth:"current"},t)).depth?1:C("tree"===t.depth?f:o),s=0,E="tree"===t.depth&&f.hasOwnProperty(J.FOLDERS)||"subfolders"===t.depth&&o.hasOwnProperty(J.FOLDERS)&&o[J.LEVEL]<3,u=function(e){e&&e.hasOwnProperty(J.OBJECTS)&&(e[J.OBJECTS].forEach(e=>{A(e)&&(d=e[J.DATES])&&(d=d[t.reference])&&d>=r&&d<=n&&a.push(e)}),s++)},O=function(e){var r=typeof e===UNDEF?f:e;H(r,u),"current"!==t.depth&&r.hasOwnProperty(J.FOLDERS)&&r[J.FOLDERS].forEach(e=>O(e))},c=function(){O("tree"===t.depth?f:o),setTimeout(T,20)},p=function(){h=[],O("tree"===t.depth?f:o),setTimeout(function(){h.length?e.when.apply(e,h).done(T):T()},20)},T=function(){i>s?setTimeout(T,20):(D(),e.isFunction(t.ready)&&t.ready.call(a,t))},D=function(){t.sort&&(t.reverse?a.sort((e,r)=>r[J.DATES][t.reference]-e[J.DATES][t.reference]):a.sort((e,r)=>e[J.DATES][t.reference]-r[J.DATES][t.reference])),t.max&&t.max<a.length&&(a=a.slice(0,t.max))};t.hasOwnProperty("end")&&(n=t.end*ONEDAY_S),t.hasOwnProperty("start")&&(r=t.start*ONEDAY_S),t.hasOwnProperty("range")&&(null!==r?n=r+t.range*ONEDAY_S:null!==n?r=n-t.range*ONEDAY_S:(n=Math.round(new Date/1e3),r=n-t.range*ONEDAY_S)),null===r&&(r=0),null===n&&Math.round(new Date/1e3),E&&!l?B(c,p):p()}},collectItems:function(t){if(typeof t!==UNDEF&&t.hasOwnProperty("terms")){var r,n,a=[],i=(t=e.extend({fields:"creator,keywords,title,comment,name",types:"all",depth:"current",exact:!1},t)).fields.split(/,\s?/),u=i.length,O=new Array(u),c=!1,d="all"===t.types,p={},T="current"===t.depth?1:C("tree"===t.depth?f:o),A=0,D="tree"===t.depth&&f.hasOwnProperty(J.FOLDERS)||"subfolders"===t.depth&&o.hasOwnProperty(J.FOLDERS)&&o[J.LEVEL]<3,P=function(t,o){for(var l,s,E=0,f=0;f<u;f++){if(i[f].length>1){if(i[f][0]!==o)continue;l=i[f][1]}else l=i[f][0];JCAMERA.indexOf(l)&&t.hasOwnProperty(J.CAMERA)?typeof(s=t[J.CAMERA][l])===UNDEF&&(s=t[l]):s=t[l],typeof s!==UNDEF&&null!=s&&(e.isArray(s)?s=s.join(" "):s+="",("comment"===l||l.endsWith("Caption"))&&(s=s.stripHTML()),s.searchTerm(r,O[l],c)&&E++)}(c&&E===n||E)&&a.push(t)},y=function(e){if(e){if(e!==f&&(d||p.folder)&&P(e,"folder"),e.hasOwnProperty(J.OBJECTS)){var t;e[J.OBJECTS].forEach(e=>{t=e[J.CATEGORY],(d||p[t])&&P(e,t)})}A++}},g=function(e){var r=typeof e===UNDEF?f:e;H(r,y),"current"!==t.depth&&r.hasOwnProperty(J.FOLDERS)&&r[J.FOLDERS].forEach(e=>g(e))},R=function(){g("tree"===t.depth?f:o),setTimeout(L,20)},m=function(){h=[],g("tree"===t.depth?f:o),setTimeout(function(){h.length?e.when.apply(e,h).done(L):L()},20)},L=function(){T>A?setTimeout(L,20):(F(),e.isFunction(t.ready)&&t.ready.call(a,t))},F=function(){t.max&&t.max<a.length&&(a=a.slice(0,t.max))};'"'===t.terms[0]&&'"'===t.terms[t.terms.length-1]?(r=t.terms.substring(1,t.terms.length-1),!1===t.exact&&(t.exact=!0)):!1===t.exact?~(r=t.terms.replace(/\s+/g,",")).indexOf(","+E.and+",")&&(r=r.replace(new RegExp(","+E.and+",","gi"),","),c=!0):r=t.terms.trim(),r=t.exact?[r]:removeEmpty(r.split(/,\s?/)),n=r.length;for(var I,w=0;w<u;w++)i[w]=i[w].split(":"),I=i[w][1]||i[w][0],O[I]="string"==typeof t.exact?t.exact.indexOf(I)>=0:t.exact;d||("-"===s.types.charAt(0)?s.possibleTypes.forEach(e=>{-1===s.types.indexOf(e)&&(p[e]=!0)}):s.types.split(/,\s?/).forEach(e=>{p[e]=!0})),D&&!l?B(R,m):m()}},collectTags:function(t){var t=e.extend({fields:"creator,keywords,folder:title,webLocation:title",types:"all",depth:"current",exact:"creator,keywords,name"},t),r=[],n=e.isArray(t.fields)?t.fields:t.fields.split(/,\s?/),a=n.length,i="name"===t.sort,l="all"===t.types,E={},u={},O=function(e){for(var t=0,n=!1,o=(e=e.split("^")).length;t<o;t++)if(!(e[t].length<3)){tag=e[t].toUpperCase(),n=!1;for(var a=0,i=r.length;a<i;a++)if(tag===r[a][2]){r[a][1]++,n=!0;break}n||r.push([e[t],1,tag])}},c=function(t,r){for(var o,i,l="^",s="^",E=function(e,t){if(e){var r,n;u[t]?n=[e.toString()]:(("comment"===t||t.endsWith("Caption"))&&(e=e.stripHTML()),n=e.split(/[\s,_\.\?\!\-\(\)\[\]]/),n=removeEmpty(n));for(var o=0,a=n.length;o<a;o++)(r=n[o].trim()).length<=2||-1===s.indexOf("^"+r.toUpperCase()+"^")&&(l+=r+"^",s+=r.toUpperCase()+"^")}},f=0;f<a;f++){if(n[f].length>1){if(n[f][0]!==r)continue;o=n[f][1]}else o=n[f][0];if(JCAMERA.indexOf(o)&&t.hasOwnProperty(J.CAMERA)?typeof(i=t[J.CAMERA][o])===UNDEF&&(i=t[o]):i=t[o],typeof i!==UNDEF&&null!=i)if(e.isArray(i))for(var c=0;c<i.length;c++)E(i[c],o);else E(i,o)}l.length>1&&O(l)},d=function(e){if(e&&(e!==f&&(l||E.folder)&&c(e,"folder"),e.hasOwnProperty(J.OBJECTS)))for(var t,r=0,n=e[J.OBJECTS];r<n.length;r++)n[r].hasOwnProperty(J.CATEGORY)&&(t=n[r][J.CATEGORY],(l||E[t])&&c(n[r],t))},p=function(e){if(H(e,d),"current"!==t.depth&&e.hasOwnProperty(J.FOLDERS))for(var r=0,n=e[J.FOLDERS].length;r<n;r++)p(e[J.FOLDERS][r])},T=function(){t.sort&&r.sort(function(e,t){return i?(""+e[2]).localeCompare(""+t[2]):t[1]-e[1]}),t.max&&t.max<r.length&&(r=r.slice(0,t.max))};h=[];for(var A,D=0;D<a;D++)n[D]=n[D].split(":"),A=n[D][1]||n[D][0],u[A]="string"==typeof t.exact?t.exact.indexOf(A)>=0:t.exact;if(!l)for(var D=0,P=s.types.split(/,\s?/);D<P.length;D++)E[P[D]]=!0;p("tree"===t.depth?f:o),e.isFunction(t.ready)&&(h.length?e.when.apply(e,h).done(function(){T(),t.ready.call(r,t)}):(T(),t.ready.call(r,t)))},processTemplate:function(e,t,r){var n,a,i,l,s=typeof r!==UNDEF&&r,t=t||o,E=e=>"label"===e?S(t):stringVal(t[e]);if(e&&e.indexOf("${")>0)for(;i=e.match(/\$\{([\w\.|]+)\}/);){if(i[1].indexOf("|")>0)for(var u=0,O=i[1].split("|");u<O.length&&!(l=E(O[u]));u++);else l=E(i[1]);e=null===l&&s&&(n=i.index-1,a=n+i[0].length,n>0&&">"===e[n]&&a<sb.length-1&&"<"===e[a]&&(n=e.lastIndexOf("<",n),a=e.indexOf(">",a),n>=0&&a>=0))?e.slice(0,n)+e.slice(a):e.slice(0,i.index)+(l||"")+e.slice(i.index+i[0].length)}return e}}};