!function(s){"use strict";function d(e,t){this.$elem=s(e),this.options=s.extend({},d.defaultOptions,t),this.$submit=this.$elem.find(':input[type="submit"]'),this.fieldItems={},this.isLoaded=!1,this.isSaved=!1,this.setSaved("saved");var o=this;this.$elem.on("click",".wdc-add-condition-group",function(e){var t=o.createConditionGroup(),i=o.createCondition({group:t.data("id")});t.find(".wdc-conditions").append(i),o.$elem.find(".wdc-condition-groups").append(t)}),this.$elem.on("click",".wdc-add-condition",function(e){var t=s(this).closest(".wdc-condition"),i=t.closest(".wdc-condition-group");o.createCondition({group:i.data("id")}).insertAfter(t)}),this.$elem.on("click",".wdc-remove-condition",function(e){var t=s(this).closest(".wdc-condition"),i=t.closest(".wdc-condition-group");t.remove(),0==i.find(".wdc-condition").length&&i.remove()}),this.$elem.on("change",".wdc-type",function(e){var t=s(this).closest(".wdc-condition");o.updateConditionFields(t)}),this.$elem.on("change",".wdc-type, .wdc-operator, .wdc-value",function(e){o.setSaved("save")}),this.$elem.on("submit","form",function(e){e.preventDefault(),o.setSaved("saving"),s.post(ajaxurl,s(this).serialize(),function(e){o.setSaved("saved")})}),this.$elem.on("DOMNodeInserted DOMNodeRemoved",function(e){var t=s(e.target);o.$elem.find(".wdc-condition").length?o.$elem.addClass("wdc-has-conditions"):o.$elem.removeClass("wdc-has-conditions"),o.isLoaded&&(t.is(".wdc-condition-group")||t.is(".wdc-condition"))&&o.setSaved("save")}),this.preload()}window.wdc=window.wdc||{},d.defaultOptions={widget:"",nonceName:"",nonce:""},d.generateId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},d.populateSelectField=function(n,e){n.empty(),s.each(e,function(e,t){if(void 0!==(t=s.extend({id:"",text:"",selected:!1},t)).children){var i=s("<optgroup></optgroup>");i.attr("label",t.text),d.populateSelectField(i,t.children),n.append(i)}else{var o=s("<option></option>");o.val(t.id).text(t.text).prop("selected",!!t.selected),n.append(o)}})},d.setSelected=function(e,t){e.find("option").filter(function(){return t==s(this).val()}).prop("selected",!0)},d.prototype.trigger=function(){arguments[0]="wdc."+arguments[0],this.$elem.trigger.apply(this.$elem,arguments)},d.prototype.on=function(){arguments[0]="wdc."+arguments[0],this.$elem.on.apply(this.$elem,arguments)},d.prototype.createConditionGroup=function(e){return e=s.extend({id:d.generateId()},e),s(wp.template("wdc-condition-group")({id:e.id}))},d.prototype.createCondition=function(e){e=s.extend({id:d.generateId(),type:"",operator:"",value:"",group:""},e);var t=s(wp.template("wdc-condition")({id:e.id,group:e.group}));return d.setSelected(t.find(".wdc-type"),e.type),this.updateConditionFields(t,{operator:e.operator,value:e.value}),t},d.prototype.updateConditionFields=function(e,t){t=s.extend({},t);e.find(".wdc-type");var i=e.find(".wdc-operator"),o=e.find(".wdc-value");i.prop("disabled",!0),o.prop("disabled",!0),this.getConditionFieldItems(e,function(e){e=s.extend({},e),d.populateSelectField(i,e.operator),d.populateSelectField(o,e.value),void 0!==t.operator&&d.setSelected(i,t.operator),void 0!==t.value&&d.setSelected(o,t.value),i.prop("disabled",!1),o.prop("disabled",!1)})},d.prototype.getConditionFieldItems=function(e,t){var i=e.find(".wdc-type").val();if(void 0===this.fieldItems[i]){var o=this,n=this.prepareAjax({action:"wdc_ui_get_condition_field_items",type:i});s.post(ajaxurl,n,function(e){o.fieldItems[i]=s.extend({},e),t(o.fieldItems[i])})}else t(this.fieldItems[i])},d.prototype.preload=function(){var d=this;this.$elem.addClass("wdc-loading");var e=this.prepareAjax({action:"wdc_ui_preload",widget:this.options.widget});s.post(ajaxurl,e,function(e){d.fieldItems=s.extend({},e.fieldItems),s.each(e.conditions,function(o,e){var n=d.createConditionGroup({id:o});s.each(e,function(e,t){var i=d.createCondition({id:e,type:t.type,operator:t.operator,value:t.value,group:o});n.find(".wdc-conditions").append(i)}),d.$elem.find(".wdc-condition-groups").append(n)}),d.$elem.removeClass("wdc-loading"),d.isLoaded=!0,d.trigger("preloadComplete")})},d.prototype.setSaved=function(e){switch(void 0===this.$submit.data("save")&&this.$submit.data("save",this.$submit.text()),this.isSaved=!1,e){case"save":this.$submit.text(this.$submit.data("save")).prop("disabled",!1).siblings(".spinner").removeClass("is-active");break;case"saved":this.$submit.text(this.$submit.data("saved")).prop("disabled",!0).siblings(".spinner").removeClass("is-active"),this.isSaved=!0;break;case"saving":this.$submit.text(this.$submit.data("save")).prop("disabled",!0).siblings(".spinner").addClass("is-active")}},d.prototype.prepareAjax=function(e){return e=s.extend({},e),this.options.nonceName&&(e[this.options.nonceName]=this.options.nonce),e},window.wdc.ui=d}(jQuery),function(d){"use strict";d(document.body).on("click",".wdc-open-ui",function(e){var t=d(this),i=t.siblings(".spinner");i.addClass("wdc-is-active");var o=wp.template("wdc-ui")({widget:t.data("widget")}),n=new wdc.ui(o,{widget:t.data("widget"),nonceName:t.data("noncename"),nonce:t.data("nonce")});n.on("preloadComplete",function(e){i.removeClass("wdc-is-active"),d.featherlight(n.$elem,{namespace:"wdc-modal",persist:!0,closeOnClick:!1,closeOnEsc:!0,afterContent:function(){},beforeClose:function(){if(!n.isSaved&&wdc.messages.notSaved)return window.confirm(wdc.messages.notSaved)}})})})}(jQuery);