<?php
/**
 * Pos Warehouse Database Model
 *
 * @package VitePos_Lite\Models\Database
 */

namespace VitePos_Lite\Models\Database;

use VitePos_Lite\Core\ViteposModelLite;

/**
 * Class Mapbd_pos_warehouse
 *
 * @properties id,name,email,phone,country,state,city,street,zip_code,status
 */
class Mapbd_Pos_Warehouse extends ViteposModelLite {
	/**
	 * Its property id
	 *
	 * @var int
	 */
	public $id;
	/**
	 * Its property name
	 *
	 * @var string
	 */
	public $name;
	/**
	 * Its property email
	 *
	 * @var string
	 */
	public $email;
	/**
	 * Its property phone
	 *
	 * @var int
	 */
	public $phone;
	/**
	 * Its property country
	 *
	 * @var string
	 */
	public $country;
	/**
	 * Its property state
	 *
	 * @var string
	 */
	public $state;
	/**
	 * Its property city
	 *
	 * @var string
	 */
	public $city;
	/**
	 * Its property street
	 *
	 * @var string
	 */
	public $street;
	/**
	 * Its property zip_code
	 *
	 * @var int
	 */
	public $zip_code;
	/**
	 * Its property wh_timezone
	 *
	 * @var Time
	 */
	public $wh_timezone;
	/**
	 * Its property main_branch
	 *
	 * @var string
	 */
	public $main_branch;
	/**
	 * Its property allowed_ip
	 *
	 * @var string
	 */
	public $allowed_ip;
	/**
	 * Its property status
	 *
	 * @var bool
	 */
	public $status;


	/**
	 * Mapbd_pos_warehouse constructor.
	 */
	public function __construct() {
		parent::__construct();
		$this->set_validation();
		$this->table_name     = 'apbd_pos_warehouse';
		$this->primary_key    = 'id';
		$this->unique_key     = array();
		$this->multi_key      = array();
		$this->auto_inc_field = array( 'id' );
		$this->app_base_name  = 'apbd-elite-pos';
	}


	/**
	 * The set validation is generated by appsbd
	 */
	public function set_validation() {
		$this->validations = array(
			'id'          => array(
				'Text' => 'Id',
				'Rule' => 'max_length[11]|integer',
			),
			'name'        => array(
				'Text' => 'Name',
				'Rule' => 'max_length[100]',
			),
			'email'       => array(
				'Text' => 'Email',
				'Rule' => 'max_length[150]|valid_email',
			),
			'phone'       => array(
				'Text' => 'Phone',
				'Rule' => 'max_length[150]',
			),
			'country'     => array(
				'Text' => 'Country',
				'Rule' => 'max_length[100]',
			),
			'state'       => array(
				'Text' => 'State',
				'Rule' => 'max_length[100]',
			),
			'city'        => array(
				'Text' => 'City',
				'Rule' => 'max_length[100]',
			),
			'street'      => array(
				'Text' => 'Street',
				'Rule' => 'max_length[100]',
			),
			'zip_code'    => array(
				'Text' => 'Zip Code',
				'Rule' => 'max_length[100]',
			),
			'wh_timezone' => array(
				'Text' => 'Timezone',
				'Rule' => 'max_length[50]',
			),
			'allowed_ip'  => array(
				'Text' => 'Allowed Ip',
				'Rule' => 'max_length[255]',
			),
			'main_branch' => array(
				'Text' => 'Main Branch',
				'Rule' => 'max_length[1]',
			),
			'status'      => array(
				'Text' => 'Status',
				'Rule' => 'max_length[1]',
			),

		);
	}

	/**
	 * The get property raw options is generated by appsbd
	 *
	 * @param \Appsbd_Lite\V1\Core\any $property Its string.
	 * @param false                    $is_with_select Its bool.
	 *
	 * @return array|string[]
	 */
	public function get_property_raw_options( $property, $is_with_select = false ) {
		$return_obj = array();
		switch ( $property ) {
			case 'status':
				$return_obj = array(
					'A' => 'Active',
					'I' => 'Inactive',
				);
				break;
			case 'main_branch':
				$return_obj = array(
					'Y' => 'Yes',
					'N' => 'No',
				);
				break;
			default:
		}
		if ( $is_with_select ) {
			return array_merge( array( '' => 'Select' ), $return_obj );
		}
		return $return_obj;
	}

	/**
	 * The get property options color is generated by appsbd
	 *
	 * @param \Appsbd_Lite\V1\Core\any $property Its string.
	 *
	 * @return array|string[]
	 */
	public function get_property_options_color( $property ) {
		$return_obj = array();
		switch ( $property ) {
			case 'status':
				$return_obj = array(
					'A' => 'success',
					'I' => 'danger',
				);
				break;
			case 'main_branch':
				$return_obj = array(
					'Y' => 'success',
					'N' => 'danger',
				);
				break;
			default:
		}
		return $return_obj;
	}

	/**
	 * The select all is generated by appsbd
	 *
	 * @param string $select Its Select param.
	 * @param string $order_by Its order by param.
	 * @param string $order Its order param.
	 * @param string $limit Its limit param.
	 * @param string $limit_start Its limit_start param.
	 * @param string $like_fld Its like_fld param.
	 * @param string $like_value Its like value param.
	 * @param array  $extra_param Its extra param.
	 * @param string $like_side Its like side param.
	 * @param bool   $is_escap Its escap param.
	 * @param false  $is_data_only Its data param.
	 *
	 * @return array|false
	 */
	public function select_all( $select = '', $order_by = '', $order = '', $limit = '', $limit_start = '', $like_fld = '', $like_value = '', $extra_param = array(), $like_side = 'after', $is_escap = true, $is_data_only = false ) {
		if ( empty( $order_by ) ) {
			$order_by = 'id';
		}
		return parent::select_all(
			$select,
			$order_by,
			$order,
			1,
			$limit_start,
			$like_fld,
			$like_value,
			$extra_param,
			$like_side,
			$is_escap,
			$is_data_only
		);
	}

	/**
	 * The get outlet details is generated by appsbd
	 *
	 * @param WP_user $user Its string.
	 *
	 * @param bool    $has_any Its a boolean.
	 *
	 * @return array|false
	 */
	public static function get_outlet_details( $user, $has_any = false ) {

		if ( $has_any || ( is_object( $user ) && ( $user instanceof \WP_User ) ) ) {

			if ( ! $has_any && ( empty( $user ) || empty( $user->roles ) ) ) {
				return array();
			}
			$has_multi_outlet_access = $has_any;
			if ( ! $has_multi_outlet_access && in_array( 'administrator', $user->roles ) ) {
				$has_multi_outlet_access = true;
			}

			$outlet_obj = new self();
			$outlet_obj->status( 'A' );
			$in_str = '';
			if ( ! $has_multi_outlet_access ) {
				$user_outlets = get_user_meta( $user->ID, 'outlet_id', true );
				if ( empty( $user_outlets ) ) {
					return array();
				}
				$user_outlets = array_map(
					function ( $value ) {
						return intval( $value );
					},
					$user_outlets
				);
				$in_str       = '(' . implode( ',', $user_outlets ) . ')';
				$outlet_obj->id( "in {$in_str}", true );
			}

			$outlets = $outlet_obj->select_all_grid_data( 'id,name,country,state,city,street,zip_code,status' );
			if ( ! empty( $outlets ) ) {
				$cash_counter = new Mapbd_pos_counter();
				if ( ! $has_multi_outlet_access ) {
					$cash_counter->outlet_id( "in {$in_str}", true );
				}
				$cash_counters = $cash_counter->select_all_grid_data();
				$outlet_ids    = array();
				foreach ( $cash_counters as $cash_counter ) {
					$outlet_id = $cash_counter->outlet_id;
					if ( ! isset( $outlet_ids[ $outlet_id ] ) ) {
						$outlet_ids[ $outlet_id ] = array();
					}
					unset( $cash_counter->outlet_id );
					$outlet_ids[ $outlet_id ][] = $cash_counter;
				}
				foreach ( $outlets as &$outlet ) {
					$outlet->counters = ! empty( $outlet_ids[ $outlet->id ] ) ? $outlet_ids[ $outlet->id ] : array();
				}
			}
			return $outlets;
		}
		return array();
	}

	/**
	 * The save is generated by appsbd
	 *
	 * @return bool
	 */
	public function save() {
		if ( self::count_all() < 1 ) {
			return parent::save();
		}
		return false;
	}

	/**
	 * The create db table is generated by appsbd
	 */
	public static function create_db_table() {
		$this_obj = new static();
		$table    = $this_obj->db->prefix . $this_obj->table_name;
		if ( $this_obj->db->get_var( "show tables like '{$table}'" ) != $table ) {
			$sql = "CREATE TABLE `{$table}` (
					  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
					  `name` char(100) NOT NULL DEFAULT '',
					  `email` char(150) NOT NULL DEFAULT '',
					  `phone` char(150) NOT NULL DEFAULT '',
					  `country` char(100) NOT NULL,
					  `state` char(100) NOT NULL DEFAULT '',
					  `city` char(100) NOT NULL DEFAULT '',
					  `street` char(100) NOT NULL DEFAULT '',
					  `zip_code` char(100) NOT NULL DEFAULT '',
					  `wh_timezone` char(50) NOT NULL,
					  `main_branch` char(1) NOT NULL DEFAULT 'N' COMMENT 'bool(Y=Yes,N=No)',
                      `allowed_ip` char(255) NOT NULL DEFAULT '',
					  `status` char(1) NOT NULL DEFAULT 'A' COMMENT 'bool(A=Active,I=Inactive)',
					  PRIMARY KEY (`id`)
					) ";
			require_once ABSPATH . 'wp-admin/includes/upgrade.php';
			dbDelta( $sql );
		}
	}

	/**
	 * The DeleteById is generated by appsbd
	 *
	 * @param any $id Its integer.
	 *
	 * @return bool
	 */
	public static function delete_by_id( $id ) {
		return self::delete_by_key_value( 'id', $id );
	}
}
