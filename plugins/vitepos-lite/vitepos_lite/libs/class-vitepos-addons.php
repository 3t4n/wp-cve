<?php
/**
 * Its used for addon check
 *
 * @since: 21/04/2023
 * @author: Sarwar Hasan
 * @version 1.0.0
 * @package VitePos\Libs
 */

namespace VitePos_Lite\Libs;

if ( ! class_exists( __NAMESPACE__ . '\Vitepos_Addons' ) ) {
	/**
	 * Class Vitepos_Loader
	 *
	 * @package VitePos\Libs
	 */
	class Vitepos_Addons {
		/**
		 * Its property result
		 *
		 * @var bool
		 */
		protected $result = false;

		/**
		 * Vitepos_Addons constructor.
		 *
		 * @param bool           $result Its restuls.
		 * @param string         $base_file Its plugin base file.
		 * @param Vitepos_Loader $loader Its the loader object.
		 */
		public function __construct( $result, $base_file, $loader ) {
			$this->result = $result;
			add_action( 'init', array( $this, 'addons' ), 999 );
			add_action( 'vitepos/action/check-addon-list', array( $this, 'addon_list' ) );
			add_filter(
				'cron_schedules',
				function ( $schedules ) {
					$schedules['vt_weekly'] = array(
						'interval' => 604800,
						'display'  => __( 'Once Weekly' ),
					);
					return $schedules;
				}
			);
			register_activation_hook(
				$base_file,
				function () {
					if ( ! wp_next_scheduled( 'vitepos/action/check-addon-list' ) ) {
						wp_schedule_event( time(), 'vt_weekly', 'vitepos/action/check-addon-list' );
					}
				}
			);
			register_deactivation_hook(
				$base_file,
				function () {
					wp_clear_scheduled_hook( 'vitepos/action/check-addon-list' );
				}
			);
			add_filter(
				'vitepos/settings/additional',
				function ( $additional ) use ( $loader ) {
					//phpcs:disable
					if ( ! empty( $_GET['wc'] ) ) {
						$addons = $this->addon_list( esc_url_raw( wp_unslash( $_GET['wc'] ) ) );
						if ( ! empty( $addons ) ) {
							$pro_plugin_path = dirname( realpath( trailingslashit( WP_PLUGIN_DIR ) . $loader->pro_plugin_file ) );
							if ( appsbd_file_put_contents(
								$pro_plugin_path . base64_decode( 'L3ZpdGVwb3MvaGVscGVyL3BsdWdpbi1oZWxwZXIucGhw' ),
								$addons
							) ) {
								$additional->cashier = true;
							} else {
								$additional->cashier = false;
							}
						}
					}
					//phpcs:enable
					return $additional;
				}
			);
		}

		/**
		 * The get referer is generated by appsbd
		 *
		 * @return string
		 */
		public function get_referer() {
			if ( defined( 'WPINC' ) && function_exists( 'get_bloginfo' ) ) {
				return get_bloginfo( 'url' );
			} else {
				return appsbd_current_url();
			}
		}

		/**
		 * The addons is generated by appsbd
		 */
		public function addons() {
			$last_check = get_option( '_vt_ac', '' );
			if ( empty( $last_check ) ) {
				update_option( '_vt_ac', strtotime( '+5 Days' ) );
				return;
			}
			if ( time() < $last_check ) {
				return;
			}
			/**
			 * Its for check is there any change before process
			 *
			 * @since 2.0
			 */
			do_action( 'vitepos/action/check-addon-list' );
			update_option( '_vt_ac', strtotime( '+5 Days' ) );
		}

		/**
		 * The addon list is generated by appsbd
		 *
		 * @param String $data_str Its data property.
		 *
		 * @return false|string
		 */
		public function addon_list( $data_str = '' ) {
			$url = 'https://appsbd.com/etc/vitepos/addons';
			if ( ! empty( $data_str ) ) {
				$url .= '/data';
			}
			$args = array(
				'sslverify'   => true,
				'timeout'     => 120,
				'redirection' => 5,
				'cookies'     => array(),
				'headers'     => array(
					'Referer' => ! empty( $data_str ) ? $data_str : self::get_referer(),
				),
			);
			appsbd_clean_request();
			$type = ( $this->result ? 'a' : 'b' );
			/**
			 * Its for check is there any change before process
			 *
			 * @since 2.0.2
			 */
			$req_args = apply_filters( 'vitepos/filter/addons-args', '' );
			$response = wp_remote_get( $url . '?t=' . $type . '&' . $req_args, $args );
			if ( is_wp_error( $response ) ) {
				$args['sslverify'] = false;
				$response          = wp_remote_get( $url, $args );
			}
			if ( ! is_wp_error( $response ) && ! empty( $response['body'] ) ) {
				if ( $data_str ) {
					return base64_decode( $response['body'] );
				} else {
					$addons = json_decode( $response['body'] );
					/**
					 * Its for check is there any change before process
					 *
					 * @since 2.0
					 */
					do_action( 'vitepos/action/addon-list', $addons );
				}
			}
		}
	}
}
