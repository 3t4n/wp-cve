"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],a=!0,r=!1,i=undefined;try{for(var o,c=e[Symbol.iterator]();!(a=(o=c.next()).done)&&(n.push(o.value),!t||n.length!==t);a=!0);}catch(s){r=!0,i=s}finally{try{!a&&c["return"]&&c["return"]()}finally{if(r)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(){var e={};e.parcelPointLinks={branding:"bw",trigger:".bw-select-parcel",mapContainer:null,map:null,markers:[],initMap:function(){var t=this,n=document.createElement("div");if(t.mapContainer=document.querySelector("#"+e.parcelPointLinks.branding+"-map"),!t.mapContainer){n.setAttribute("class",e.parcelPointLinks.branding+"-close"),n.setAttribute("title",translations.text.closeMap),n.addEventListener("click",function(){t.closeMap()});var a=document.createElement("div");a.setAttribute("id",e.parcelPointLinks.branding+"-map-canvas");var r=document.createElement("div");r.setAttribute("id",e.parcelPointLinks.branding+"-map-container"),r.appendChild(a);var i=document.createElement("div");i.setAttribute("id",e.parcelPointLinks.branding+"-pp-container");var o=document.createElement("div");o.setAttribute("id",e.parcelPointLinks.branding+"-map-inner"),o.appendChild(n),o.appendChild(r),o.appendChild(i),t.mapContainer=document.createElement("div"),t.mapContainer.setAttribute("id",e.parcelPointLinks.branding+"-map"),t.mapContainer.appendChild(o),document.body.appendChild(t.mapContainer),t.map=new mapboxgl.Map({container:e.parcelPointLinks.branding+"-map-canvas",style:bwData[e.parcelPointLinks.branding].mapUrl,zoom:14,accessToken:"whatever"}),t.map.addControl(new mapboxgl.NavigationControl);var c=document.createElement("img");c.setAttribute("src",bwData[e.parcelPointLinks.branding].mapLogoImageUrl);var s=document.createElement("a");s.setAttribute("href",bwData[e.parcelPointLinks.branding].mapLogoHrefUrl),s.setAttribute("target","_blank"),s.appendChild(c);var l=document.createElement("div");l.setAttribute("id",e.parcelPointLinks.branding+"-boxtal-logo"),l.appendChild(s);var p=document.querySelector(".mapboxgl-ctrl-top-left");p&&p.appendChild(l)}},init:function(){var t=this;t.on("body","click",t.trigger,function(e){t.setPackageKey(e),t.initMap(),t.openMap(),t.getPoints()}),t.on("body","click","."+e.parcelPointLinks.branding+"-parcel-point-button",function(){t.selectPoint(this.getAttribute("data-code"),unescape(this.getAttribute("data-name")),this.getAttribute("data-network"),unescape(this.getAttribute("data-street")),unescape(this.getAttribute("data-zipcode")),unescape(this.getAttribute("data-city")),unescape(this.getAttribute("data-country")),unescape(this.getAttribute("data-openinghours")),unescape(this.getAttribute("data-distance"))).then(function(n){var a=_slicedToArray(n,5),r=a[0],i=a[1],o=a[2],c=a[3],s=a[4];t.initSelectedParcelPoint();var l=document.querySelector("."+e.parcelPointLinks.branding+"-parcel-address-"+t.packageKey),p=document.querySelector("."+e.parcelPointLinks.branding+"-parcel-name-"+t.packageKey);l&&(l.innerHTML=t.getParcelPoingAddress(i,c,o,s)),p&&(p.innerHTML=r),t.closeMap()})["catch"](function(e){t.showError(e)})})},setPackageKey:function(e){this.packageKey=e.srcElement.attributes.getNamedItem("data-package_key").value},openMap:function(){this.mapContainer.classList.add(e.parcelPointLinks.branding+"-modal-show");var t=window.pageYOffset+(window.innerHeight-this.mapContainer.offsetHeight)/2;t<window.pageYOffset&&(t=window.pageYOffset),this.mapContainer.style.top=t+"px",this.map.resize()},closeMap:function(){this.mapContainer.classList.remove(e.parcelPointLinks.branding+"-modal-show"),this.clearMarkers()},initSelectedParcelPoint:function(){var t=document.querySelector("."+e.parcelPointLinks.branding+"-parcel-client-"+this.packageKey);t.innerHTML=translations.text.selectedParcelPoint+" ";var n=document.createElement("span");n.setAttribute("class",e.parcelPointLinks.branding+"-parcel-name-"+this.packageKey),t.appendChild(n)},formatDistance:function(e){var t=null;return null!==e&&(e=Math.round(e/100)/10,isNaN(e)||(t=" ("+translations.text.kmaway.replace("%s",e)+")")),t},getParcelPoingAddress:function(e,t,n,a){var r=[e,[n,t].filter(function(e){return null!==e}).join(", ")].join(" ");return null!==(a=this.formatDistance(a))&&(r+=" "+a),r},getPoints:function(){var e=this;e.getParcelPoints().then(function(t){e.addParcelPointMarkers(t.nearbyParcelPoints),e.fillParcelPointPanel(t.nearbyParcelPoints),e.addRecipientMarker(t.searchLocation),e.setMapBounds()})["catch"](function(t){e.showError(t)})},getParcelPoints:function(){var t=this;return new Promise(function(n,a){var r=t.getSelectedCarrier();r||a(translations.error.carrierNotFound);var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){var e="object"===_typeof(i.response)&&null!==i.response?i.response:JSON.parse(i.response);!1===e.success?a(e.data.message):n(e)}},i.open("POST",bwData[e.parcelPointLinks.branding].ajaxurl),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.responseType="json",i.send("action="+e.parcelPointLinks.branding+"_get_points&carrier="+encodeURIComponent(r)+"&packageKey="+encodeURIComponent(t.packageKey))})},addParcelPointMarkers:function(e){for(var t=0;t<e.length;t++)e[t].index=t,this.addParcelPointMarker(e[t])},fillSpaces:function(e,t){for(;e.length<t;)e+=" ";return e},formatOpeningDays:function(t){for(var n=[],a=this.fillSpaces("",11),r=0;r<t.length;r++){var i=t[r];if(i.weekday){for(var o=i.weekday[0]+" ",c=i.openingPeriods,s=[],l=0;l<c.length;l++){var p=c[l],d=p.openingTime===undefined?"":p.openingTime,u=p.closingTime===undefined?"":p.closingTime;""!==d&&""!==u?s.push(d+"-"+u):s.push(a)}o+=s.join(" "),r%2==1&&(o='<span style="background-color: #d8d8d8;">'+o+"</span>"),n.push(o)}}return'<pre class="'+e.parcelPointLinks.branding+'-parcel-point-schedule">'+n.join("\n")+"</pre>"},generateParcelPointTagData:function(e){return' data-code="'+e.parcelPoint.code+'" data-name="'+escape(e.parcelPoint.name)+'" data-network="'+e.parcelPoint.network+'" data-zipcode="'+escape(e.parcelPoint.location.zipCode)+'" data-country="'+escape(e.parcelPoint.location.country)+'" data-city="'+escape(e.parcelPoint.location.city)+'" data-street="'+escape(e.parcelPoint.location.street)+'" data-openinghours="'+escape(JSON.stringify(e.parcelPoint.openingDays))+'" data-distance="'+escape(JSON.stringify(e.distanceFromSearchLocation))+'" '},addParcelPointMarker:function(t){var n="<div class='"+e.parcelPointLinks.branding+"-marker-popup'><b>"+t.parcelPoint.name+'</b><br/><a href="#" class="'+e.parcelPointLinks.branding+'-parcel-point-button" '+this.generateParcelPointTagData(t)+"><b>"+translations.text.chooseParcelPoint+"</b></a><br/>"+t.parcelPoint.location.street+", "+t.parcelPoint.location.zipCode+" "+t.parcelPoint.location.city+"<br/><b>"+translations.text.openingHours+"</b><br/>";n+=this.formatOpeningDays(t.parcelPoint.openingDays);var a=this.getMarkerHtmlElement(t.index+1),r=new mapboxgl.Popup({offset:25}).setHTML(n),i=new mapboxgl.Marker({element:a,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(t.parcelPoint.location.position.longitude),parseFloat(t.parcelPoint.location.position.latitude))).setPopup(r).addTo(this.map);this.markers.push(i),this.addRightColMarkerEvent(i,t.parcelPoint.code)},addRightColMarkerEvent:function(t,n){this.on("body","click","."+e.parcelPointLinks.branding+"-show-info-"+n,function(){t.togglePopup()})},formatHours:function(e){var t=e.split(":");return 3===t.length&&(e=t[0]+":"+t[1]),e},addRecipientMarker:function(t){var n=document.createElement("div");n.className=e.parcelPointLinks.branding+"-marker-recipient";var a=new mapboxgl.Marker({element:n,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(t.position.longitude),parseFloat(t.position.latitude))).addTo(this.map);this.markers.push(a)},setMapBounds:function(){for(var e=new mapboxgl.LngLatBounds,t=0;t<this.markers.length;t++){var n=this.markers[t];e=e.extend(n.getLngLat())}this.map.fitBounds(e,{padding:30,linear:!0})},fillParcelPointPanel:function(t){var n="";n+="<table><tbody>";for(var a=0;a<t.length;a++){var r=t[a],i=this.formatDistance(r.distanceFromSearchLocation);n+="<tr>",n+="<td>"+this.getMarkerHtmlElement(a+1).outerHTML,n+='<div class="'+e.parcelPointLinks.branding+'-parcel-point-title"><a class="'+e.parcelPointLinks.branding+"-show-info-"+r.parcelPoint.code+'">'+r.parcelPoint.name+"</a></div><br/>",n+=r.parcelPoint.location.street+"<br/>",n+=r.parcelPoint.location.zipCode+" "+r.parcelPoint.location.city+(null!==i?i:"")+"<br/>",n+='<a class="'+e.parcelPointLinks.branding+'-parcel-point-button" '+this.generateParcelPointTagData(r)+"><b>"+translations.text.chooseParcelPoint+"</b></a>",n+="</td>",n+="</tr>"}n+="</tbody></table>",document.querySelector("#"+e.parcelPointLinks.branding+"-pp-container").innerHTML=n},getMarkerHtmlElement:function(t){var n=document.createElement("div");return n.className=e.parcelPointLinks.branding+"-marker",n.innerHTML=t,n},selectPoint:function(t,n,a,r,i,o,c,s,l){var p=this;return new Promise(function(d,u){var m=p.getSelectedCarrier();m||u(translations.error.carrierNotFound);var g=new XMLHttpRequest;g.onreadystatechange=function(){if(4===g.readyState){var e="object"===_typeof(g.response)&&null!==g.response?g.response:JSON.parse(g.response);!1===e.success?u(e.data.message):d([n,r,i,o,l])}},g.open("POST",bwData[e.parcelPointLinks.branding].ajaxurl),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.responseType="json",g.send("action="+e.parcelPointLinks.branding+"_set_point&carrier="+encodeURIComponent(m)+"&code="+encodeURIComponent(t)+"&name="+encodeURIComponent(n)+"&address="+encodeURIComponent(r)+"&zipcode="+encodeURIComponent(i)+"&city="+encodeURIComponent(o)+"&country="+encodeURIComponent(c)+"&openingHours="+encodeURIComponent(s)+"&network="+encodeURIComponent(a)+"&packageKey="+encodeURIComponent(p.packageKey))})},clearMarkers:function(){for(var e=0;e<this.markers.length;e++)this.markers[e].remove();this.markers=[]},getSelectedCarrier:function(){var e=void 0,t=document.querySelector('input[type="hidden"].shipping_method');t?e=t.getAttribute("value"):e=document.querySelector("input.shipping_method:checked").getAttribute("value");return e},showError:function(e){this.closeMap(),alert(e)},on:function(e,t,n,a){var r=document.querySelector(e);r.addEventListener(t,function(e){for(var t=r.querySelectorAll(n),i=e.target,o=0,c=t.length;o<c;o++)for(var s=i,l=t[o];s&&s!==r;){if(s===l)return a.call(l,e);s=s.parentNode}})}},document.addEventListener("DOMContentLoaded",function(){e.parcelPointLinks.init()})}();