/*! User Switcher -v 2.0.0 
 * Copyright (c) 2016;
 * Licensed: GPLv2+
 **/
!function(a){var b=userSwitcher;_.extend(userSwitcher,{users:{},suOn:!1,pageReload:function(){window.location.reload()},SendRequest:Backbone.Model.extend({url:b._ajax_url+"?action=us_request&nonce="+b.nonce,initialize:function(){this.on("error",this.serverError,this)},parse:function(a){var b=this.get("action");a.success?this.trigger("us:"+b+"_success",a.data):this.trigger("us:"+b+"_error",a.data.message)},turnOffEvents:function(){var a=this.get("action");this.off("us:"+a+"_error"),this.off("us:"+a+"_success")},serverError:function(){var a=this.get("action");this.trigger("us:"+a+"_error",b.l8n.server_error)}}),SwitcherController:Backbone.View.extend({el:"#wp-admin-bar-us-switcher-menu",events:{"click #wp-admin-bar-us-to-guest":"switchToGuest","click #wp-admin-bar-us-search-users":"searchUsers","click #wp-admin-bar-us-switch-back":"switchBack"},switchToGuest:function(){b.SendRequest.set({action:"switch_user",user_id:"guest",ajax:!0}),b.SendRequest.turnOffEvents(),b.SendRequest.on("us:switch_user_success",b.pageReload),b.SendRequest.save()},searchUsers:function(){!1===b.suOn?(b.suOn=new b.SwitcherWindow,b.suOn.render()):b.suOn.show()},switchBack:function(){b.noAdminView.prototype.switchBack.apply(this)}}),noAdminView:Backbone.View.extend({className:"us-no-admin-view",isguest:!1,events:{"click .us-switch-back":"switchBack","click .us-search-user":"searchUsers","click .description":"toggleOptions","click .us-guest-user":"switchToGuest"},initialize:function(){this.isguest="guest"===b.user_switch_to,this.render()},render:function(){var b=this.isguest?"#user-no-admin-bar":"#user-no-admin-bar-admin",c=_.template(a(b).html());this.$el.append(c),this.$el.appendTo("body")},toggleOptions:function(a){var b=this.$el.find("p").not(a.currentTarget),c=b.is(":visible");b[c?"slideUp":"slideDown"]()},switchToGuest:function(){b.SwitcherController.prototype.switchToGuest.apply(this)},switchBack:function(){b.SendRequest.set({action:"restore_account",ajax:!0}),b.SendRequest.turnOffEvents(),b.SendRequest.on("us:restore_account_success",b.pageReload),b.SendRequest.save()},searchUsers:function(){b.SwitcherController.prototype.searchUsers.apply(this)}}),SwitcherWindow:Backbone.View.extend({className:"us-window",page:1,per_page:20,events:{"submit form":"searchUsers","click .switch_to_user button":"switchUser","keydown .us-search-key":"hideNotice","click .us-close-icon":"hide","click .us-prev-button":"searchPrev","click .us-next-button":"searchNext"},render:function(){var b=_.template(a("#user-switcher-window").html());this.$el.append(b),this.$el.appendTo("body"),this.$el.find('[name="key"]').focus(),this.notice_container=this.$el.find("#us-notice-box"),this.result_container=this.$el.find("#us-search-results"),this.navs_container=this.$el.find("#us-navs"),this.next_button=this.navs_container.find(".us-next-button"),this.prev_button=this.navs_container.find(".us-prev-button"),this.form=this.$el.find("form")},showNotice:function(a){this.notice_container.empty().slideUp().html(a).slideDown()},hideNotice:function(){this.notice_container.empty().slideUp()},searchUsers:function(c){function d(){f.removeClass("us-searching")}var e=a(c.currentTarget),f=e.find('[name="key"]'),g=f.val();return 1>g.length?(this.showNotice(b.l8n.notice.char_limit),!1):(this.hideNotice(),b.users[g]&&b.users[g][this.page]?(this.result_container.empty().html(b.users[g][this.page].users),!1):(f.addClass("us-searching"),b.SendRequest.set({action:"search_users",term:g,page:this.page}),b.SendRequest.turnOffEvents(),b.SendRequest.on("us:search_users_error",d),b.SendRequest.on("us:search_users_error",this.showNotice,this),b.SendRequest.on("us:search_users_success",d),b.SendRequest.on("us:search_users_success",this.showResults,this),b.SendRequest.save(),!1))},showResults:function(a){var c=b.SendRequest.get("term"),d=b.SendRequest.get("page");b.users[c]={},b.users[c][d]=a,this.result_container.empty().show().html(a.users),this.toggleNavs(a.total)},switchUser:function(c){var d=a(c.currentTarget),e=d.data("id");b.SendRequest.set({action:"switch_user",user_id:e,ajax:!0}),b.SendRequest.turnOffEvents(),b.SendRequest.on("us:switch_user_success",b.pageReload),b.SendRequest.save()},show:function(){this.$el.show()},hide:function(){this.$el.hide()},toggleNavs:function(a){var b=this.page*this.per_page;(b<a||this.page>1)&&this.navs_container.show(),this.prev_button[this.page>1?"addClass":"removeClass"]("active"),this.next_button[b<a?"addClass":"removeClass"]("active")},searchPrev:function(b){var c=a(b.currentTarget);c.is(".active")&&(this.page-=1,this.page<=0&&(this.page=1),this.form.submit())},searchNext:function(b){var c=a(b.currentTarget);c.is(".active")&&(this.page+=1,this.form.submit())}})}),b.SendRequest=new b.SendRequest,a(document).ready(function(){"guest"===b.switch_to||!b.admin_bar&&!b.is_admin?new b.noAdminView:new b.SwitcherController})}(jQuery);