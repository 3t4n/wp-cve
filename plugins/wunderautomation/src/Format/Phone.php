<?php

namespace WunderAuto\Format;

/**
 * Class Phone
 */
class Phone
{
    /**
     * @var \stdClass
     */
    private $phoneRules;

    /**
     * @var array<int, string>
     */
    private $pauseCharacters = [',', 'p', 'w'];

    /**
     * Phone
     */
    public function __construct()
    {
        $this->readPhoneRules();
    }

    /**
     * Deserialize the phone rules array
     *
     * @return void
     */
    private function readPhoneRules()
    {
        // phpcs:disable
        $this->phoneRules = json_decode(
            '{"AF":{"e":["00"],"i":"93","x":["93"],"t":["0"]},"AL":{"e":["00"],"i":"355","x":["355"],"t":["0"]},"DZ":{"e":["00"],"i":"213","x":["213"],"t":["0"]},"AD":{"e":["00"],"i":"376","x":["376"],"t":[null]},"AO":{"e":["00"],"i":"244","x":["244"],"t":["0"]},"AG":{"e":["011"],"i":"1","x":["1268"],"t":["1"]},"AR":{"e":["00"],"i":"54","x":["54"],"t":["0"]},"AM":{"e":["00"],"i":"374","x":["374"],"t":["0"]},"AU":{"e":["0011"],"i":"61","x":["61"],"t":["0"]},"AT":{"e":["00"],"i":"43","x":["43"],"t":["0"]},"AZ":{"e":["00"],"i":"994","x":["994","37497"],"t":["0"]},"BS":{"e":["011"],"i":"1","x":["1242"],"t":["1"]},"BH":{"e":["00"],"i":"973","x":["973"],"t":[null]},"BD":{"e":["00"],"i":"880","x":["880"],"t":["0"]},"BB":{"e":["011"],"i":"1","x":["1246"],"t":["1"]},"BY":{"e":["8p10"],"i":"375","x":["375"],"t":["8"]},"BE":{"e":["00"],"i":"32","x":["32"],"t":["0"]},"BZ":{"e":["00"],"i":"501","x":["501"],"t":[null]},"BJ":{"e":["00"],"i":"229","x":["229"],"t":[null]},"BT":{"e":["00"],"i":"975","x":["975"],"t":[null]},"BO":{"e":["00"],"i":"591","x":["591"],"t":["0"]},"BA":{"e":["00"],"i":"387","x":["387"],"t":["0"]},"BW":{"e":["00"],"i":"267","x":["267"],"t":[null]},"BR":{"e":["0014","0015","0021","0023","0031"],"i":"55","x":["55"],"t":["0"]},"BN":{"e":["00"],"i":"673","x":["673"],"t":[null]},"BG":{"e":["00"],"i":"359","x":["359"],"t":["0"]},"BF":{"e":["00"],"i":"226","x":["226"],"t":[null]},"BI":{"e":["00"],"i":"257","x":["257"],"t":[null]},"KH":{"e":["001","007","008"],"i":"855","x":["855"],"t":["0"]},"CM":{"e":["00"],"i":"237","x":["237"],"t":[null]},"CA":{"e":["011"],"i":"1","x":["1204","1289","1306","1403","1416","1418","1450","1506","1514","1519","1604","1613","1647","1705","1709","1778","1780","1807","1819","1867","1902","1905"],"t":["1"]},"CV":{"e":["0"],"i":"238","x":["238"],"t":[null]},"CF":{"e":["00"],"i":"236","x":["236"],"t":[null]},"TD":{"e":["00"],"i":"235","x":["235"],"t":[null]},"CL":{"e":["00"],"i":"56","x":["56"],"t":["0"]},"CN":{"e":["00"],"i":"86","x":["86"],"t":["0"]},"CO":{"e":["00444","005","007","009"],"i":"57","x":["57"],"t":["03","05","07","09"]},"KM":{"e":["00"],"i":"269","x":["269"],"t":[null]},"CD":{"e":["00"],"i":"243","x":["243"],"t":[null]},"CG":{"e":["00"],"i":"242","x":["242"],"t":[null]},"CR":{"e":["00"],"i":"506","x":["506"],"t":[null]},"CI":{"e":["00"],"i":"225","x":["225"],"t":[null]},"HR":{"e":["00"],"i":"385","x":["385"],"t":["0"]},"CU":{"e":["119"],"i":"53","x":["53"],"t":["0"]},"CY":{"e":["00"],"i":"357","x":["357","90392"],"t":[null]},"CZ":{"e":["00"],"i":"420","x":["420"],"t":[null]},"DK":{"e":["00"],"i":"45","x":["45"],"t":[null]},"DJ":{"e":["00"],"i":"253","x":["253"],"t":[null]},"DM":{"e":["011"],"i":"1","x":["1767"],"t":["1"]},"DO":{"e":["011"],"i":"1","x":["1849","1829","1809"],"t":["1"]},"EC":{"e":["00"],"i":"593","x":["593"],"t":["0"]},"EG":{"e":["00"],"i":"20","x":["20"],"t":["0"]},"SV":{"e":["00"],"i":"503","x":["503"],"t":[null]},"GQ":{"e":["00"],"i":"240","x":["240"],"t":[null]},"ER":{"e":["00"],"i":"291","x":["291"],"t":["0"]},"EE":{"e":["00"],"i":"372","x":["372"],"t":[null]},"ET":{"e":["00"],"i":"251","x":["251"],"t":["0"]},"FJ":{"e":["00"],"i":"679","x":["679"],"t":[null]},"FI":{"e":["00","990","994","999"],"i":"358","x":["358"],"t":["0"]},"FR":{"e":["00"],"i":"33","x":["33"],"t":["0"]},"GA":{"e":["00"],"i":"241","x":["241"],"t":[null]},"GM":{"e":["00"],"i":"220","x":["220"],"t":[null]},"GE":{"e":["8p10"],"i":"995","x":["995"],"t":["8"]},"DE":{"e":["00"],"i":"49","x":["49"],"t":["0"]},"GH":{"e":["00"],"i":"233","x":["233"],"t":["0"]},"GR":{"e":["00"],"i":"30","x":["30"],"t":[null]},"GD":{"e":["011"],"i":"1","x":["1473"],"t":["1"]},"GT":{"e":["00"],"i":"502","x":["502"],"t":[null]},"GW":{"e":["00"],"i":"245","x":["245"],"t":[null]},"GY":{"e":["001"],"i":"592","x":["592"],"t":[null]},"HT":{"e":["00"],"i":"509","x":["509"],"t":[null]},"HN":{"e":["00"],"i":"504","x":["504"],"t":[null]},"HU":{"e":["00"],"i":"36","x":["36"],"t":["06"]},"IS":{"e":["00"],"i":"354","x":["354"],"t":[null]},"IN":{"e":["00"],"i":"91","x":["91"],"t":["0"]},"ID":{"e":["001","008"],"i":"62","x":["62"],"t":["0"]},"IR":{"e":["00"],"i":"98","x":["98"],"t":["0"]},"IQ":{"e":["00"],"i":"964","x":["964"],"t":[null]},"IE":{"e":["00"],"i":"353","x":["353"],"t":["0"]},"IL":{"e":["00","012","013","014","018"],"i":"972","x":["972"],"t":["0"]},"IT":{"e":["00"],"i":"39","x":["39"],"t":[null]},"JM":{"e":["011"],"i":"1","x":["1876"],"t":["1"]},"JP":{"e":["010"],"i":"81","x":["81"],"t":["0"]},"JO":{"e":["00"],"i":"962","x":["962"],"t":["0"]},"KZ":{"e":["8p10"],"i":"7","x":["72131","72532","71033","71638","72641","71839","71231","71133","72757","71837","72346","71031","72531","721344","721394","7292","7132","71037","71841","71143","710363","72344","71337","7272","7273","71440","72433","71430","71644","72540","72633","71641","72542","71030","71643","7122","71453","72237","72438","71342","72773","71036","71640","72838","72246","72635","71840","71345","73622","72932","71538","72236","72341","72351","71630","71443","72154","72338","71531","7172","71136","71137","72778","71131","71434","71648","71235","71642","72147","7187","71334","71633","72775","71647","71132","71442","72938","72138","71233","72347","72331","71341","71336","71234","71343","71832","71651","72837","71456","71139","71437","71333","72841","72772","71441","72836","7212","71454","71452","72644","71145","72252","710322","72146","72771","71833","72342","72256","71144","72777","72536","72144","71542","72842","72348","71622","71838","72636","71637","7142","71634","72631","71237","72251","72339","72937","72422","72539","72547","72336","72843","71433","71236","72239","71239","71646","71541","71331","72632","71238","72642","72148","72541","72779","72353","71535","71448","72149","72752","7182","71130","7152","71544","71039","71431","72333","72137","72839","72537","72637","71451","72840","71063","72639","71533","71140","7222","72337","71534","72156","71335","72345","71836","72535","71038","72544","72548","72776","72332","72931","72432","72546","71631","72643","71346","71636","72257","7252","71532","71645","71639","71536","7282","72774","71546","71436","72622","72334","71142","72835","72530","7213","712302","72343","72436","71537","72638","72153","71439","72538","72533","71445","71332","71035","7112","72230","72833","72834","71834","7232","71444","72770","71543","71455","72340","71632","71635","72431","71138","72435","72934","72634","71141","72832","71135","72831","710422","710432","710403","71831","7102","72534","71034","72349","71134","71435","72437","72335","71290","71291","71390","71391","71490","71491","71590","71591","71790","71791","71890","71891","72190","72191","72390","72391","72490","72590","72591","72690","72691","72758","72790","72791","76099","760","762","763","705","777","700","701","702","707","764","771","775","72159","71059","71146","71147","71149","71159","71259","71347","71348","71349","71359","71457","71459","71545","71547","71559","71649","71659","71842","71843","71844","72330","72359","72259","72559","72640","72659","72830","72859","72740","72759","72959"],"t":["8"]},"KE":{"e":["000"],"i":"254","x":["254"],"t":["0"]},"KI":{"e":["00"],"i":"686","x":["686"],"t":[null]},"KP":{"e":["99"],"i":"850","x":["850"],"t":[null]},"KR":{"e":["001","002"],"i":"82","x":["82"],"t":["0"]},"KW":{"e":["00"],"i":"965","x":["965"],"t":[null]},"KG":{"e":["00"],"i":"996","x":["996"],"t":["0"]},"LA":{"e":["00"],"i":"856","x":["856"],"t":["0"]},"LV":{"e":["00"],"i":"371","x":["371"],"t":[null]},"LB":{"e":["00"],"i":"961","x":["961"],"t":["0"]},"LS":{"e":["00"],"i":"266","x":["266"],"t":[null]},"LR":{"e":["00"],"i":"231","x":["231"],"t":[null]},"LY":{"e":["00"],"i":"218","x":["218"],"t":["0"]},"LI":{"e":["00"],"i":"423","x":["423"],"t":[null]},"LT":{"e":["00"],"i":"370","x":["370"],"t":["0"]},"LU":{"e":["00"],"i":"352","x":["352"],"t":[null]},"MK":{"e":["00"],"i":"389","x":["389"],"t":["0"]},"MG":{"e":["00"],"i":"261","x":["261"],"t":[null]},"MW":{"e":["00"],"i":"265","x":["265"],"t":[null]},"MY":{"e":["00"],"i":"60","x":["60"],"t":["0"]},"MV":{"e":["00"],"i":"960","x":["960"],"t":[null]},"ML":{"e":["00"],"i":"223","x":["223"],"t":[null]},"MT":{"e":["00"],"i":"356","x":["356"],"t":[null]},"MH":{"e":["011"],"i":"692","x":["692"],"t":["1"]},"MR":{"e":["00"],"i":"222","x":["222"],"t":[null]},"MU":{"e":["00"],"i":"230","x":["230"],"t":[null]},"MX":{"e":["00"],"i":"52","x":["52"],"t":["01"]},"FM":{"e":["011"],"i":"691","x":["691"],"t":["1"]},"MD":{"e":["00"],"i":"373","x":["373","373533"],"t":["0"]},"MC":{"e":["00"],"i":"377","x":["377"],"t":[null]},"MN":{"e":["001"],"i":"976","x":["976"],"t":["0"]},"ME":{"e":["00"],"i":"382","x":["382"],"t":["0"]},"MA":{"e":["00"],"i":"212","x":["212"],"t":["0"]},"MZ":{"e":["00"],"i":"258","x":["258"],"t":[null]},"MM":{"e":["00"],"i":"95","x":["95"],"t":[null]},"NA":{"e":["00"],"i":"264","x":["264"],"t":["0"]},"NR":{"e":["00"],"i":"674","x":["674"],"t":[null]},"NP":{"e":["00"],"i":"977","x":["977"],"t":["0"]},"NL":{"e":["00"],"i":"31","x":["31"],"t":["0"]},"NZ":{"e":["00"],"i":"64","x":["64"],"t":["0"]},"NI":{"e":["00"],"i":"505","x":["505"],"t":[null]},"NE":{"e":["00"],"i":"227","x":["227"],"t":[null]},"NG":{"e":["009"],"i":"234","x":["234"],"t":["0"]},"NO":{"e":["00"],"i":"47","x":["47"],"t":[null]},"OM":{"e":["00"],"i":"968","x":["968"],"t":[null]},"PK":{"e":["00"],"i":"92","x":["92"],"t":["0"]},"PW":{"e":["011"],"i":"680","x":["680"],"t":[null]},"PA":{"e":["00"],"i":"507","x":["507"],"t":[null]},"PG":{"e":["05"],"i":"675","x":["675"],"t":[null]},"PY":{"e":["00"],"i":"595","x":["595"],"t":["0"]},"PE":{"e":["00"],"i":"51","x":["51"],"t":["0"]},"PH":{"e":["00"],"i":"63","x":["63"],"t":["0"]},"PL":{"e":["00"],"i":"48","x":["48"],"t":[null]},"PT":{"e":["00"],"i":"351","x":["351"],"t":[null]},"QA":{"e":["00"],"i":"974","x":["974"],"t":[null]},"RO":{"e":["00"],"i":"40","x":["40"],"t":["0"]},"RU":{"e":["8p10"],"i":"7","x":["7"],"t":["8"]},"RW":{"e":["00"],"i":"250","x":["250"],"t":[null]},"KN":{"e":["011"],"i":"1","x":["1869"],"t":["1"]},"LC":{"e":["011"],"i":"1","x":["1758"],"t":["1"]},"VC":{"e":["011"],"i":"1","x":["1784"],"t":["1"]},"WS":{"e":["0"],"i":"685","x":["685"],"t":[null]},"SM":{"e":["00"],"i":"378","x":["378"],"t":[null]},"ST":{"e":["00"],"i":"239","x":["239"],"t":[null]},"SA":{"e":["00"],"i":"966","x":["966"],"t":["0"]},"SN":{"e":["00"],"i":"221","x":["221"],"t":[null]},"RS":{"e":["00"],"i":"381","x":["381"],"t":["0"]},"SC":{"e":["00"],"i":"248","x":["248"],"t":[null]},"SL":{"e":["00"],"i":"232","x":["232"],"t":["0"]},"SG":{"e":["001","008"],"i":"65","x":["65"],"t":[null]},"SK":{"e":["00"],"i":"421","x":["421"],"t":["0"]},"SI":{"e":["00"],"i":"386","x":["386"],"t":["0"]},"SB":{"e":["00"],"i":"677","x":["677"],"t":[null]},"SO":{"e":["00"],"i":"252","x":["252"],"t":[null]},"ZA":{"e":["00"],"i":"27","x":["27"],"t":["0"]},"ES":{"e":["00"],"i":"34","x":["34"],"t":[null]},"LK":{"e":["00"],"i":"94","x":["94"],"t":["0"]},"SD":{"e":["00"],"i":"249","x":["249"],"t":["0"]},"SR":{"e":["00"],"i":"597","x":["597"],"t":["0"]},"SZ":{"e":["00"],"i":"268","x":["268"],"t":[null]},"SE":{"e":["00"],"i":"46","x":["46"],"t":["0"]},"CH":{"e":["00"],"i":"41","x":["41"],"t":["0"]},"SY":{"e":["00"],"i":"963","x":["963"],"t":["0"]},"TJ":{"e":["8p10"],"i":"992","x":["992"],"t":["8"]},"TZ":{"e":["000"],"i":"255","x":["255"],"t":["0"]},"TH":{"e":["001"],"i":"66","x":["66"],"t":["0"]},"TL":{"e":["00"],"i":"670","x":["670"],"t":[null]},"TG":{"e":["00"],"i":"228","x":["228"],"t":[null]},"TO":{"e":["00"],"i":"676","x":["676"],"t":[null]},"TT":{"e":["011"],"i":"1","x":["1868"],"t":["1"]},"TN":{"e":["00"],"i":"216","x":["216"],"t":[null]},"TR":{"e":["00"],"i":"90","x":["90"],"t":["0"]},"TM":{"e":["8p10"],"i":"993","x":["993"],"t":["8"]},"TV":{"e":["00"],"i":"688","x":["688"],"t":[null]},"UG":{"e":["000"],"i":"256","x":["256"],"t":["0"]},"UA":{"e":["00"],"i":"380","x":["380"],"t":["0"]},"AE":{"e":["00"],"i":"971","x":["971"],"t":["0"]},"GB":{"e":["00"],"i":"44","x":["44"],"t":["0"]},"US":{"e":["011"],"i":"1","x":["1"],"t":["1",null]},"UY":{"e":["00"],"i":"598","x":["598"],"t":["0"]},"UZ":{"e":["8p10"],"i":"998","x":["998"],"t":["8"]},"VU":{"e":["00"],"i":"678","x":["678"],"t":[null]},"VA":{"e":["00"],"i":"379","x":["379"],"t":[null]},"VE":{"e":["00"],"i":"58","x":["58"],"t":["0"]},"VN":{"e":["00"],"i":"84","x":["84"],"t":["0"]},"YE":{"e":["00"],"i":"967","x":["967"],"t":["0"]},"ZM":{"e":["00"],"i":"260","x":["260"],"t":["0"]},"ZW":{"e":["00"],"i":"263","x":["263"],"t":["0"]},"TW":{"e":["002"],"i":"886","x":["886"],"t":["0"]},"NF":{"e":["00"],"i":"672","x":["672"],"t":[null]},"NC":{"e":["00"],"i":"687","x":["687"],"t":[null]},"PF":{"e":["00"],"i":"689","x":["689"],"t":[null]},"PM":{"e":["00"],"i":"508","x":["508"],"t":[null]},"WF":{"e":["00"],"i":"681","x":["681"],"t":[null]},"CK":{"e":["00"],"i":"682","x":["682"],"t":[null]},"NU":{"e":["00"],"i":"683","x":["683"],"t":[null]},"TK":{"e":["00"],"i":"690","x":["690"],"t":[null]},"AI":{"e":["011"],"i":"1","x":["1264"],"t":["1"]},"BM":{"e":["011"],"i":"1","x":["1441"],"t":["1"]},"IO":{"e":["00"],"i":"246","x":["246"],"t":[null]},"VG":{"e":["011"],"i":"1","x":["1284"],"t":["1"]},"KY":{"e":["011"],"i":"1","x":["1345"],"t":["1"]},"FK":{"e":["00"],"i":"500","x":["500"],"t":[null]},"GI":{"e":["00"],"i":"350","x":["350"],"t":[null]},"MS":{"e":["011"],"i":"1","x":["1664"],"t":["1"]},"SH":{"e":["00"],"i":"290","x":["290"],"t":[null]},"TC":{"e":["0"],"i":"1","x":["1649"],"t":["1"]},"MP":{"e":["011"],"i":"1","x":["1670"],"t":["1"]},"PR":{"e":["011"],"i":"1","x":["1939","1787"],"t":["1"]},"AS":{"e":["011"],"i":"1","x":["1684"],"t":["1"]},"GU":{"e":["011"],"i":"1","x":["1671"],"t":["1"]},"VI":{"e":["011"],"i":"1","x":["1340"],"t":["1"]},"HK":{"e":["001"],"i":"852","x":["852"],"t":[null]},"MO":{"e":["00"],"i":"853","x":["853"],"t":[null]},"FO":{"e":["00"],"i":"298","x":["298"],"t":[null]},"GL":{"e":["00"],"i":"299","x":["299"],"t":[null]},"GF":{"e":["00"],"i":"594","x":["594"],"t":["0"]},"GP":{"e":["00"],"i":"590","x":["590"],"t":["0"]},"MQ":{"e":["00"],"i":"596","x":["596"],"t":["0"]},"RE":{"e":["00"],"i":"262","x":["262"],"t":[null]},"AW":{"e":["00"],"i":"297","x":["297"],"t":[null]},"AN":{"e":["00"],"i":"599","x":["599"],"t":["0"]},"AC":{"e":["00"],"i":"247","x":["247"],"t":[null]},"PS":{"e":["00"],"i":"970","x":["970"],"t":["0"]}}'
        );
        //phpcs:enable
    }

    /**
     * Return the internal phone rule representation
     *
     * @return \stdClass
     */
    public function getPhoneRules()
    {
        return $this->phoneRules;
    }

    /**
     * Attempt to convert the number to E.164
     *
     * @param string $number     Phone number.
     * @param string $isoCountry ISO Country code.
     *
     * @return string
     */
    public function formatE164($number, $isoCountry)
    {
        return $this->normalizeNumber(
            $this->validatedInputNumber($number),
            $isoCountry
        );
    }

    /**
     * Normalize the phone number to E.164 format
     *
     * @param string $number     Phone number.
     * @param string $isoCountry ISO Country code.
     *
     * @return string
     */
    private function normalizeNumber($number, $isoCountry)
    {
        $countryRules = isset($this->phoneRules->$isoCountry) ?
            $this->phoneRules->$isoCountry :
            $this->phoneRules->US;

        // remove international exit dialcodes such as + or 00
        foreach ($countryRules->e as $exitDialCode) {
            $number = preg_replace("/^([+]|$exitDialCode)/", '+', (string)$number);
        }
        // if the country has a trunk code remove it
        if (substr((string)$number, 0, 1) !== '+') {
            // loop through valid trunk codes, exiting immediately when one matches.
            foreach ($countryRules->t as $trunkCode) {
                if (is_null($trunkCode) === true) {
                    // add plus and the country's international dialcode
                    $number = '+' . $countryRules->i . $number;
                    break;
                } else {
                    // replace the trunk code for the country with plus and the country's international dialcode
                    $count  = 0;
                    $number = preg_replace(
                        "/^$trunkCode/",
                        '+' . $countryRules->i,
                        (string)$number,
                        1,
                        $count
                    );
                    if ($count === 1) {
                        break;
                    }
                }
            }
        }

        return (string)$number;
    }

    /**
     * Clean out pause character etc. from phone nr.
     *
     * @param string $number Phone number.
     *
     * @return string
     */
    private function validatedInputNumber($number)
    {
        // replace *known pause character with an internal representation
        $pauseReplacePreg = '/[' . implode('', $this->pauseCharacters) . ']/';
        $ret              = preg_replace($pauseReplacePreg, 'p', $number);
        if (is_null($ret)) {
            return $number;
        }
        // finish replacements
        $ret = preg_replace("/[^\d\+]/", '', $ret);
        if (is_null($ret)) {
            return $number;
        }

        return $ret;
    }

    /**
     * Guess the ISO code from a phone number
     *
     * @param string $number Phone number.
     *
     * @return mixed
     */
    public function guessIsoCode($number)
    {
        $hits   = [];
        $number = trim($number);
        foreach ((array)$this->phoneRules as $key => $phoneRule) {
            foreach ($phoneRule->e as $exitDialcode) {
                $numberFixed = preg_replace("/^([+]|$exitDialcode)/", '+', $number);
                $numberFixed = $this->validatedInputNumber((string)$numberFixed);
                foreach ($phoneRule->x as $prefix) {
                    $prefix = '+' . $prefix;
                    if (substr($numberFixed, 0, strlen($prefix)) === $prefix) {
                        $hits[$key] = $phoneRule;
                    }
                }
            }
        }

        $keys = array_keys($hits);
        return reset($keys);
    }
}
