!function($){"use strict";function log(msg){window.console&&window.console.log&&console.log(msg)}function safeFind(context,selector){return"#"==selector[0]&&selector.indexOf(" ")<0?$(selector):context.find(selector)}function Rule(controller,condition,value){this.init(controller,condition,value)}function Ruleset(){this.rules=[]}$.extend(Rule.prototype,{init:function(controller,condition,value){this.controller=controller,this.condition=condition,this.value=value,this.rules=[],this.controls=[]},evalCondition:function(context,control,condition,val1,val2){if("=="==condition||"OR"==condition)return this.checkBoolean(val1)==this.checkBoolean(val2);if("!="==condition)return this.checkBoolean(val1)!=this.checkBoolean(val2);if(">="==condition)return Number(val2)>=Number(val1);if("<="==condition)return Number(val2)<=Number(val1);if(">"==condition)return Number(val2)>Number(val1);if("<"==condition)return Number(val2)<Number(val1);if("()"==condition)return window[val1](context,control,val2);if("any"==condition)return $.inArray(val2,val1.split(","))>-1;if("not-any"==condition)return-1==$.inArray(val2,val1.split(","));throw new Error("Unknown condition:"+condition)},checkCondition:function(context,cfg){if(!this.condition)return!0;var control=context.find(this.controller);0===control.size()&&cfg.log&&log("Evaling condition: Could not find controller input "+this.controller);var val=this.getControlValue(context,control);return cfg.log&&void 0===val&&log("Evaling condition: Could not exctract value from input "+this.controller),void 0!==val&&(val=this.normalizeValue(control,this.value,val),this.evalCondition(context,control,this.condition,this.value,val))},normalizeValue:function(control,baseValue,val){return"number"==typeof baseValue?parseFloat(val):val},getControlValue:function(context,control){return("radio"==control.attr("type")||"checkbox"==control.attr("type"))&&control.size()>1?control.filter(":checked").val():"checkbox"==control.attr("type")||"radio"==control.attr("type")?control.is(":checked"):control.val()},createRule:function(controller,condition,value){var rule=new Rule(controller,condition,value);return this.rules.push(rule),rule},include:function(input){if(!input)throw new Error("Must give an input selector");this.controls.push(input)},applyRule:function(context,cfg,enforced){var result;result=void 0===enforced?this.checkCondition(context,cfg):enforced,cfg.log&&log("Applying rule on "+this.controller+"=="+this.value+" enforced:"+enforced+" result:"+result),cfg.log&&!this.controls.length&&log("Zero length controls slipped through");var show=cfg.show||function(control){control.show()},hide=cfg.hide||function(control){control.hide()},controls=$.map(this.controls,function(elem,idx){var control=context.find(elem);return cfg.log&&0===control.size()&&log("Could not find element:"+elem),control});result?($(controls).each(function(){cfg.log&&0===$(this).size()&&(log("Control selection is empty when showing"),log(this)),show(this)}),$(this.rules).each(function(){this.applyRule(context,cfg)})):($(controls).each(function(){cfg.log&&0===$(this).size()&&(log("Control selection is empty when hiding:"),log(this)),hide(this)}),$(this.rules).each(function(){this.applyRule(context,cfg,!1)}))},checkBoolean:function(value){switch(value){case!0:case"true":case 1:case"1":value=!0;break;case!1:case"false":case 0:case"0":value=!1}return value}}),$.extend(Ruleset.prototype,{createRule:function(controller,condition,value){var rule=new Rule(controller,condition,value);return this.rules.push(rule),rule},applyRules:function(context,cfg){var i;for((cfg=cfg||{}).log&&log("Starting evaluation ruleset of "+this.rules.length+" rules"),i=0;i<this.rules.length;i++)this.rules[i].applyRule(context,cfg)},walk:function(){function descent(rule){rules.push(rule),$(rule.children).each(function(){descent(this)})}var rules=[];return $(this.rules).each(function(){descent(this)}),rules},checkTargets:function(context,cfg){var controls=0,rules=this.walk();$(rules).each(function(){if(0===context.find(this.controller).size())throw new Error("Rule's controller does not exist:"+this.controller);if(0===this.controls.length)throw new Error("Rule has no controls:"+this);$(this.controls).each(function(){if(0===safeFind(context,this))throw new Error("Rule's target control "+this+" does not exist in context "+context.get(0));controls++})}),cfg.log&&log("Controller check ok, rules count "+rules.length+" controls count "+controls)},install:function(cfg){$.deps.enable($(document.body),this,cfg)}});var deps={createRuleset:function(){return new Ruleset},enable:function(selection,ruleset,cfg){((cfg=cfg||{}).checkTargets||void 0===cfg.checkTargets)&&ruleset.checkTargets(selection,cfg);cfg.log&&log("Enabling dependency change monitoring on "+selection.get(0));var handler=function(){ruleset.applyRules(selection,cfg)},val=selection.on?selection.on("change.deps",null,null,handler):selection.live("change.deps",handler);return ruleset.applyRules(selection,cfg),val}};$.deps=deps}(jQuery);