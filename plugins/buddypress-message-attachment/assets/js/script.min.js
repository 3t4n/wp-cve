window.BPMsgAt_Media_Uploader=function(t,e){var a=!1,n=e.uploader||{},i=e.lang,o=e.selectors,r={},l={init:function(){var e=this;return e.get_elements()?(0!==r.$cb_send_notice.length&&r.$cb_send_notice.change(function(){t(this).is(":checked")?r.$form.find(".bp_msgat_ui_wrapper").hide():r.$form.find(".bp_msgat_ui_wrapper").show()}),setTimeout(function(){e.start_uploader()},10),void t.ajaxPrefilter(l.prefilter)):!1},get_elements:function(){return r.$form=t("compose"==e.current_action?o.form_message:o.form_reply),0===r.$form.length?!1:(r.$button=r.$form.find('input[type="submit"],button[type="submit"]'),r.$field_attachment_ids=r.$form.find('input[name="bp_msgat_attachment_ids"]'),r.$upload_button=t("#btn_msgat_upload"),r.$cb_send_notice=r.$form.find('input[name="send-notice"]'),!0)},get_query_variable:function(t,e){if("undefined"==typeof t||""==t||"undefined"==typeof e||""==e)return"";for(var a=t.split("&"),n=0;n<a.length;n++){var i=a[n].split("=");if(i[0]==e)return i[1]}return!1},prefilter:function(e,a){var n=l.get_query_variable(e.data,"action");if("undefined"!=typeof n&&"messages_send_reply"==n){var i=t.extend({},a.data,{bp_msgat_attachment_ids:r.$field_attachment_ids.val()});e.data=t.param(i),e.success=function(e){return r.$field_attachment_ids.val(""),t(".msgat-uploaded-file").remove(),function(a,n,i){t.isFunction(e)&&e(a,n,i)}}(e.success)}},start_uploader:function(){a=new plupload.Uploader({runtimes:"html5,silverlight,flash,html4",browse_button:"btn_msgat_upload",dragdrop:!1,max_file_size:n.max_file_size||"5mb",multi_selection:n.multiselect||!1,url:ajaxurl,multipart:!0,multipart_params:{action:"bp_msgat_upload",cookie:encodeURIComponent(document.cookie),_wpnonce:n.nonce},flash_swf_url:n.swf_url||"",silverlight_xap_url:n.silverlight_xap_url||"",filters:n.filters,init:{FilesAdded:function(t){r.$button.attr("disabled","disabled").addClass("loading");var e=r.$upload_button.html();r.$upload_button.attr("disabled","disabled").addClass("loading").data("org_text",e).html(i.uploading),t.start()},FileUploaded:function(e,a,o){r.$button.removeAttr("disabled").removeClass("loading"),r.$upload_button.removeAttr("disabled").removeClass("loading").html(r.$upload_button.data("org_text"));var l=t.parseJSON(o.response),d=r.$field_attachment_ids.val();if(n.multiselect);else{d=l.attachment_id,t(".msgat-uploaded-file").remove();var s="<span class='msgat-uploaded-file'>"+l.name+"<a href='#' data-attachment_id='"+l.attachment_id+"' class='remove-uploaded-file'  onclick='return window.BPMsgAt_Media_Uploader.removeAttachment(this)'  title='"+i.remove+"'>x</a></span>";t("#btn_msgat_upload").after(s)}r.$field_attachment_ids.val(d)},Error:function(t,e){r.$button.removeAttr("disabled").removeClass("loading"),r.$upload_button.removeAttr("disabled").removeClass("loading").html(r.$upload_button.data("org_text")),l.show_upload_error(e.code),t.refresh(),n.multiselect||r.$field_attachment_ids.val("")}}}),a.init()},show_upload_error:function(t){switch(t){case plupload.FILE_EXTENSION_ERROR:alert(i.upload_error.file_type);break;case plupload.FILE_SIZE_ERROR:alert(i.upload_error.file_size);break;default:alert(i.upload_error.generic)}},removeAttachment:function(e){return $el=t(e),r.$field_attachment_ids.val(""),$el.closest(".msgat-uploaded-file").remove(),!1}},d={setup:function(){l.init()},removeAttachment:function(t){return l.removeAttachment(t)}};return t(document).ready(function(){l.init()}),d}(window.jQuery,window.BPMsgAt_Util);