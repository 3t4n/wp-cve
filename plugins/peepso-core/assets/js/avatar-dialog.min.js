!function(t,i){var e,s,n,a="PsAvatarDialog",o=(e=a,s=t.jQuery,n=t.PsAvatar,peepso.createClass(e,{__constructor:function(t){this._data=_.extend({},t),this._isCurrent=!0,this._canFinalize=!1,this.$el=null},template:peepsodata.avatar.templateDialog,init:function(){var t,i;return this.$el||(t=_.extend({},this._data,{myId:+peepsodata.currentuserid}),i=peepso.template(this.template||"")(t),this.$el=s(i).hide(),this.$file=this.$el.find("input[type=file]"),this.$hasAvatar=this.$el.find(".ps-js-has-avatar"),this.$noAvatar=this.$el.find(".ps-js-no-avatar"),this.$preview=this.$el.find(".ps-js-preview"),this.$avatar=this.$el.find(".ps-js-avatar"),this.$error=this.$el.find(".ps-js-error"),this.$btnRemove=this.$el.find(".ps-js-btn-remove"),this.$btnCrop=this.$el.find(".ps-js-btn-crop"),this.$btnCropCancel=this.$el.find(".ps-js-btn-crop-cancel"),this.$btnCropConfirm=this.$el.find(".ps-js-btn-crop-save"),this.$btnFinalize=this.$el.find(".ps-js-btn-finalize").attr("disabled","disabled"),this.$disabler=this.$el.find(".ps-js-disabler").hide(),this.$el.on("click",".ps-js-btn-upload",s.proxy(this.onUpload,this)),this.$el.on("click",".ps-js-btn-remove",s.proxy(this.onRemove,this)),this.$el.on("click",".ps-js-btn-gravatar",s.proxy(this.onUseGravatar,this)),this.$el.on("click",".ps-js-btn-crop",s.proxy(this.onCrop,this)),this.$el.on("click",".ps-js-btn-crop-cancel",s.proxy(this.onCropCancel,this)),this.$el.on("click",".ps-js-btn-crop-save",s.proxy(this.onCropConfirm,this)),this.$el.on("click",".ps-js-btn-finalize",s.proxy(this.onFinalize,this)),this.$el.on("click",".ps-js-btn-close",s.proxy(this.onClose,this)),this.$el.appendTo(document.body),this.avatar=new n(this.$file),this.avatar.on("uploadsubmit",s.proxy(function(){this.cropDetach(),this.disable()},this)).on("uploaddone",s.proxy(function(t,i){this.updateAvatar(t,i),this._isCurrent=!1,this.canFinalize(!0),this.enable()},this)).on("uploadfail",s.proxy(function(t){this.canFinalize(!1),_.isArray(t)&&(t=t.join("<br />")),this.$error.html(t).show(),this.enable()},this))),this},show:function(){return this.init()&&this.$el.show(),this},hide:function(){return this.$el&&(this.$el.remove(),this.$el=null),this},disable:function(){return this.$el&&(clearTimeout(this._enableTimer),this.$disabler.stop().show(),this.freezeFinalize()),this},enable:function(){return this.$el&&(clearTimeout(this._enableTimer),this._enableTimer=setTimeout(s.proxy(function(){this.$disabler.stop().fadeOut(),this.resetFinalize()},this),500)),this},updateAvatar:function(t,i){var e="?_t="+(new Date).getTime();this.$avatar.find("img").attr("src",t+e),!1!==i?(i&&this.$preview.find("img").attr("src",i+e),this.$btnRemove.show(),this.$noAvatar.hide(),this.$hasAvatar.show()):(this.$preview.find("img").removeAttr("src"),this.$btnRemove.hide(),this.$hasAvatar.hide(),this.$noAvatar.show())},onUpload:function(t){t.preventDefault(),t.stopPropagation(),this.$error.hide(),this.$file.click()},onRemove:function(t){t.preventDefault(),t.stopPropagation(),this.disable(),this.avatar.remove().done(s.proxy(function(t){this.updateAvatar(t,!1),window.location.reload(!0)},this)).always(s.proxy(function(){this.enable()},this))},onUseGravatar:function(t){t.preventDefault(),t.stopPropagation(),this.disable(),this.avatar.useGravatar().done(s.proxy(function(t){this.updateAvatar(t,!1),this._isCurrent=!1,this.canFinalize(!0)},this)).always(s.proxy(function(){this.enable()},this))},onFinalize:function(t){t.preventDefault(),t.stopPropagation(),this.disable(),this.avatar.finalize().done(s.proxy(function(t){window.location.reload(!0)},this)).always(s.proxy(function(){this.enable()},this))},onClose:function(t){t.preventDefault(),t.stopPropagation(),this.cropDetach(),this.hide()},cropAttach:function(){var t=this.$preview.find("img");ps_crop.init({elem:t,change:s.proxy(function(t){this._cropCoords=t},this)}),this.$btnCrop.hide(),this.$btnCropCancel.show(),this.$btnCropConfirm.show(),this.freezeFinalize()},cropDetach:function(){var t=this.$preview.find("img");ps_crop.detach(t),this.$btnCropCancel.hide(),this.$btnCropConfirm.hide(),this.$btnCrop.show(),this.resetFinalize()},cropCoords:function(){var t,i,e,s=this.$preview.find("img"),n=this._cropCoords,a=1,o=!1;return s[0].naturalWidth&&(t=s[0].naturalWidth||s.width(),i=s[0].naturalHeight||s.height(),(800<t||800<i)&&(a=800/Math.max(t,i),t*=a,i*=a,o=!0),a=t/s.width()),e={x1:Math.floor(a*n.x),y1:Math.floor(a*n.y),x2:Math.floor(a*(n.x+n.width)),y2:Math.floor(a*(n.y+n.height))},o&&(e.width=t,e.height=i),e},cropConfirm:function(){var t=this.cropCoords();this.disable(),this.avatar.crop(t.x1,t.y1,t.x2,t.y2,t.width,t.height).done(s.proxy(function(t){this.cropDetach(),this.updateAvatar(t),this._isCurrent&&window.location.reload(!0)},this)).always(s.proxy(function(){this.enable()},this))},onCrop:function(t){t.preventDefault(),t.stopPropagation(),this.cropAttach()},onCropCancel:function(t){t.preventDefault(),t.stopPropagation(),this.cropDetach()},onCropConfirm:function(t){t.preventDefault(),t.stopPropagation(),this.cropConfirm()},canFinalize:function(t){return _.isUndefined(t)||(t?(this._canFinalize=!0,this.$btnFinalize.removeAttr("disabled")):(this._canFinalize=!1,this.$btnFinalize.attr("disabled","disabled"))),this._canFinalize},freezeFinalize:function(){this.$btnFinalize.attr("disabled","disabled")},resetFinalize:function(){this.canFinalize(this.canFinalize())}}));"object"==typeof module&&module.exports?module.exports=o:t[a]=o;var r=null;peepso.observer.addAction("avatar_update_dialog",function(){if(peepsodata.profile){var t=_.extend({},peepsodata.profile);t.username&&t.id&&(r||(t.hasAvatar||(t.imgOriginal=""),r=new window.PsAvatarDialog(t)),r.show())}})}(window);