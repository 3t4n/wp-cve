!function(e,t){t.comment=new(function(d,p){function e(){this.init()}if(p.npm.objectAssign(e.prototype,{init:function(){this.ajax={};d(d.proxy(function(){var e=window.location.hash||"",t=/[#&]comment(?:\.|=)(\d+)\.(\d+)(?:\.(\d+)(?:\.(\d+))?)?/,n=e.match(t);if(n&&n[2])this.whenLoaded(n[1]).done(d.proxy(function(){this.reveal(n[1],n[2],n[3],n[4])},this))},this));p.observer.addAction("post_loaded",function(e){var t=d(e);var n=t.find("textarea[name=comment]");n.ps_autosize();n.each(function(){var t=this;p.elements.droppable(t,{dropped:function(e){p.observer.doAction("commentbox_drop_files",t,e)}})});t.on("click",".ps-comment-time .activity-post-age",function(e){d(e.currentTarget).children("a").each(function(){var e=d(this);if(e.children(".ps-js-autotime").length){var t=e.attr("href");var n=location.href.replace(location.hash,"");if(0===t.indexOf(n)){window.location=t;window.location.reload()}}})})},10,1);p.observer.addFilter("peepso_activity",function(e){var t=e.find(".ps-js-comments"),n=+t.data("comments-open");if(!n)t.find(".ps-js-btn-reply").hide();return e});p.hooks.addAction("comment_added","comments",function(e){var t=d(e),n=t.closest(".ps-js-comments"),o=+n.data("comments-open");if(!o)n.find(".ps-js-btn-reply").hide()})},whenLoaded:function(i){return d.Deferred(function(e){var t=60,n=0,o;o=setInterval(function(){if(d(".ps-js-comment-container--"+i).length){clearInterval(o);e.resolve()}else if(n++>t){clearInterval(o);e.reject()}},1e3)})},add:function(){},edit:function(){},reply:function(e,t,n,o){var i,s,r,c,a,m="#comment-item-"+t;if(n)i=d(n).closest(m);else i=d(m);s=i.find(".actaction-reply");a=s.closest(".ps-comments").hasClass("ps-comments--nested");if(a){r=s.closest(".ps-comments").children(".ps-comment-reply");c=r.find("textarea")}else{r=s.closest(".ps-comment").next(".ps-comments--nested").children(".ps-comment-reply");c=r.find("textarea")}if(r.not(":visible"))r.show();c.focus();o=o||{};p.observer.applyFilters("comment.reply",c,d.extend({},o,{act_id:e,post_id:t}));c.off("keyup.peepso").on("keyup.peepso",function(e){e.stopPropagation();activity.update_beautifier(e.target)}).trigger("keyup.peepso")},show_previous:function(e,t){var r,c,a,n=".ps-js-comment-container--"+e;if(t)r=d(t).closest(n);else r=d(n);c=r.find(".ps-js-comment-more").eq(0);a=c.find(".ps-js-loading");function o(i){var s=r.children(".cstream-comment:first");a.show();p.postJson("activity.show_previous_comments",{act_id:e,uid:peepsodata.currentuserid,first:s.data("comment-id")},function(e){var t=jQuery("<div />").append(e.data.html);t=p.observer.applyFilters("peepso_activity",t);var n=p.observer.applyFilters("peepso_activity_content",t.html());n=n.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"');n=n.replace(/\/\?embed=true([#"])/g,"/?embed=true&peepso=1$1");var o=d(n);a.hide();if(s.length==0){s=r.children(".ps-comment-more");s.after(o)}else s.before(o);o.each(function(){if(1===this.nodeType&&d(this).hasClass("ps-js-comment-item"))p.hooks.doAction("comment_added",this)});if(e.data.comments_remain>0)c.find("a").html(e.data.comments_remain_caption);else c.remove();d(document).trigger("ps_comment_added");i()})}return d.Deferred(function(e){o(function(){e.resolve()})})},show_all:function(e){var s=d(".ps-js-comment-container--"+e),r=s.children(".ps-js-comment-more"),c=r.find(".ps-js-loading"),t=s.children(".cstream-comment:first"),n=t.data("comment-id");function a(o){c.show();p.postJson("activity.show_previous_comments",{act_id:e,uid:peepsodata.currentuserid,all:1,first:n},function(e){var t=jQuery("<div />").append(e.data.html);t=p.observer.applyFilters("peepso_activity",t);var n=p.observer.applyFilters("peepso_activity_content",t.html());n=n.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"');n=n.replace(/\/\?embed=true([#"])/g,"/?embed=true&peepso=1$1");var i=d(n);c.hide();s.each(function(e){var t=d(this),n=t.children(".cstream-comment:first"),o=i;if(e>0)o=i.clone();if(n.length==0){n=t.children(".ps-comment-more");n.after(o)}else n.before(o)});i.each(function(){if(1===this.nodeType&&d(this).hasClass("ps-js-comment-item"))p.hooks.doAction("comment_added",this)});if(e.data.comments_remain>0){r.find("a").html(e.data.comments_remain_caption);a(o)}else{r.remove();d(document).trigger("ps_comment_added");o()}})}return d.Deferred(function(e){a(function(){e.resolve()})})},reveal_comment:function(n,o){return d.Deferred(d.proxy(function(e){var t=d("#comment-item-"+o);if(t.length)e.resolve();else this.show_all(n).done(d.proxy(function(){e.resolve()},this))},this))},reveal:function(e,t,n,o){function i(e){var t=p.getLinkColor(),n=e.offset().top-(d(window).height()-e.outerHeight())/2;e.css({backgroundColor:t});e.css({transition:"background-color 3s ease"});d("html, body").delay(50).animate({scrollTop:n},500,function(){e.css({backgroundColor:""})})}this.reveal_comment(e,t).done(d.proxy(function(){var e;if(!o){e=d("#comment-item-"+t);i(e)}else this.reveal_comment(n,o).done(function(){e=d("#comment-item-"+o);i(e)})},this))}}),+peepsodata.show_powered_by)p.observer.addAction("show_branding",function(){d(document).off("focus.ps-branding blur.ps-branding").on("focus.ps-branding",".ps-comments__input[name=comment]",function(){let e=d(this).closest(".ps-comments__input-wrapper");let t=d(peepsodata.powered_by);if(!e.children(`.${t.attr("class")}`).length)t.appendTo(e);t.not("style").show()}).on("blur.ps-branding",".ps-comments__input[name=comment]",function(){let e=d(this).closest(".ps-comments__input-wrapper");let t=d(peepsodata.powered_by);t=e.children(`.${t.attr("class")}`);t.not("style").hide()})});return e}(e,t,t.modules))}(jQuery,peepso);