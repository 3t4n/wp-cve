!function(e){function t(){return this.init.apply(this,arguments)}var i;PsPageAutoload=(i=e,t.prototype={init:function(e,t){var s;if(e)return s=+peepsodata.loadmore_enable,s=peepso.isMobile()?1===s||2===s:1===s||3===s,this._css_prefix=e,this._container=t,this._config_loadmore_enable=s,this._config_loadmore_repeat=this._config_loadmore_enable?+peepsodata.loadmore_repeat:0,i(_.bind(this.onDocumentLoaded,this)),this;throw new Error("CSS prefix is not supplied!")},onDocumentLoaded:function(){if(this._search_$ct=i(this._css_prefix,this._container).eq(0),this._search_$trigger=i(this._css_prefix+"-triggerscroll",this._container),this._search_$loading=i(this._css_prefix+"-loading",this._container),this._search_$nomore=i(peepsodata.activity.template_no_more).hide().insertBefore(this._search_$trigger),!this._search_$ct.length)return!1;this._search()},_search_url:"",_search_params:{},_search_loadmore_enable:null,_search:function(){this._search_toggle_autoscroll("off"),this._search_toggle_loading("show"),this._search_$ct.empty(),this._search_$nomore.hide(),this._search_params.page<=1&&(this._search_loadmore_enable=this._config_loadmore_enable,this._search_loadmore_repeat=this._config_loadmore_repeat,this._search_$loadmore)&&(this._search_$loadmore.remove(),this._search_$loadmore=null),this._search_debounced()},_search_next:function(){this._search_toggle_autoscroll("off"),this._search_toggle_loading("show"),this._search_params.page++,this._search_debounced()},_search_debounced:function(){clearTimeout(this._search_debounced_timer),this._search_debounced_timer=setTimeout(_.bind(function(){this._fetch(this._search_params).done(function(e){var t=this._search_render_html(e),s=!!t;void 0!==e.has_next&&(s=!!e.has_next),this._search_toggle_loading("hide"),t&&this._search_$ct.append(t),s?this._search_toggle_autoscroll("on"):this._search_$nomore.show()}).fail(function(e){this._search_toggle_loading("hide"),this._search_params.page<=1?this._search_$ct.html(e.join("<br>")):this._search_$nomore.show()})},this),500)},_search_render_html:function(){throw new Error("This method must be implemented by subclass!")},_search_toggle_loading:function(e){function t(e,t){(t=this._search_$loading).data("lazySrc")&&(t=this._search_$loading=i(this._css_prefix+"-loading")),"show"===e?t.show():t.hide()}"show"===e?(clearTimeout(this._search_toggle_loading_timer),t.call(this,e)):"hide"===e&&(this._search_toggle_loading_timer=setTimeout(i.proxy(function(){t.call(this,e)},this),1e3))},_search_toggle_autoscroll:function(e){var t="scroll"+this._css_prefix,s=i(peepso.observer.applyFilters("autoload_scrollable_container",window));"off"===e?s.off(t):"on"===e&&this._search_$trigger.length&&(this._search_loadmore_enable?this._search_should_load_more()?this._search_next():(this._search_$loadmore=i(peepsodata.activity.template_load_more).insertAfter(this._search_$ct),this._search_$loadmore.one("click",i.proxy(function(e){this._search_$loadmore.remove(),this._search_loadmore_repeat||(this._search_loadmore_enable=!1),this._search_next()},this))):s.off(t).on(t,i.proxy(function(){this._search_should_load_more()&&this._search_next()},this)).trigger(t))},_search_get_items:function(){return i()},_search_should_load_more:function(){var e=+peepsodata.activity_limit_below_fold,t=this._search_get_items();return this._search_loadmore_enable&&this._search_loadmore_repeat?this._search_params.page%this._search_loadmore_repeat!=0:(e=0<e?e:3,this._search_params.limit&&(e*=this._search_params.limit),!!((t=t.slice(0-e).eq(0)).length&&(this._search_loadmore_enable?t.eq(0).offset():t.get(0).getBoundingClientRect()).top<(window.innerHeight||document.documentElement.clientHeight)))},_fetch:function(e){return i.Deferred(i.proxy(function(t){e=i.extend({},e),_.isUndefined(e.limit)||(e.limit*=2),this._fetch_xhr&&this._fetch_xhr.abort(),this._fetch_xhr=peepso.getJson(this._search_url,e,i.proxy(function(e){e.success?t.resolveWith(this,[e.data]):t.rejectWith(this,[e.errors])},this))},this))}},t)}(jQuery);